<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.20.2 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>[Spring][JPA] 스프링 데이터 JPA - YHW Blog</title>
<meta name="description" content="새로운 배움을 기록하고 공유합니다">


  <meta name="author" content="yhw">
  
  <meta property="article:author" content="yhw">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="YHW Blog">
<meta property="og:title" content="[Spring][JPA] 스프링 데이터 JPA">
<meta property="og:url" content="https://rere950303.github.io/spring/jpa/SpringDataJPA/">


  <meta property="og:description" content="새로운 배움을 기록하고 공유합니다">







  <meta property="article:published_time" content="2021-10-24T00:00:00+09:00">





  

  


<link rel="canonical" href="https://rere950303.github.io/spring/jpa/SpringDataJPA/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "yhw",
      "url": "https://rere950303.github.io/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="YHW Blog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
<link rel="manifest" href="/favicon/site.webmanifest">
<link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          YHW Blog
          <span class="site-subtitle">새로운 배움을 기록하고 공유합니다</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/">categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">토글 메뉴</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://rere950303.github.io/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#spring" itemprop="item"><span itemprop="name">Spring</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#jpa" itemprop="item"><span itemprop="name">Jpa</span></a>
          <meta itemprop="position" content="3" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">[Spring][JPA] 스프링 데이터 JPA</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/bio/photo.png" alt="yhw" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">yhw</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>어제와 다른 오늘, 오늘 같은 내일</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">팔로우</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Republic of Korea</span>
        </li>
      

      
        
          
            <li><a href="mailto:yhwjjang1995@naver.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
        
          
        
          
            <li><a href="https://github.com/rere950303" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="[Spring][JPA] 스프링 데이터 JPA">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2021-10-24T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">[Spring][JPA] 스프링 데이터 JPA
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2021-10-24T00:00:00+09:00">October 24, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          7 분 소요
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              
                <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
                <ul class="toc__menu">
  <li><a href="#들어가며">들어가며</a></li>
  <li><a href="#공통-인터페이스-기능">공통 인터페이스 기능</a>
    <ul>
      <li><a href="#공통-인터페이스-설정">공통 인터페이스 설정</a></li>
      <li><a href="#공통-인터페이스-적용">공통 인터페이스 적용</a></li>
      <li><a href="#공통-인터페이스-분석">공통 인터페이스 분석</a></li>
    </ul>
  </li>
  <li><a href="#쿼리-메소드-기능">쿼리 메소드 기능</a>
    <ul>
      <li><a href="#메소드-이름으로-쿼리-생성">메소드 이름으로 쿼리 생성</a></li>
      <li><a href="#query-리포지토리-메소드에-쿼리-정의하기">@Query, 리포지토리 메소드에 쿼리 정의하기</a></li>
      <li><a href="#반환-타입">반환 타입</a></li>
      <li><a href="#순수-jpa-페이징과-정렬">순수 JPA 페이징과 정렬</a></li>
      <li><a href="#스프링-데이터-jpa-페이징과-정렬">스프링 데이터 JPA 페이징과 정렬</a></li>
      <li><a href="#벌크성-수정-쿼리">벌크성 수정 쿼리</a></li>
      <li><a href="#entitygraph">@EntityGraph</a></li>
      <li><a href="#jpa-hint--lock">JPA Hint &amp; Lock</a></li>
    </ul>
  </li>
  <li><a href="#확장-기능">확장 기능</a>
    <ul>
      <li><a href="#사용자-정의-리포지토리-구현">사용자 정의 리포지토리 구현</a></li>
      <li><a href="#auditing">Auditing</a></li>
      <li><a href="#web-확장---페이징과-정렬">Web 확장 - 페이징과 정렬</a></li>
    </ul>
  </li>
  <li><a href="#스프링-데이터-jpa-분석">스프링 데이터 JPA 분석</a>
    <ul>
      <li><a href="#스프링-데이터-jpa-구현체-분석">스프링 데이터 JPA 구현체 분석</a></li>
      <li><a href="#새로운-엔티티를-구별하는-방법">새로운 엔티티를 구별하는 방법</a></li>
    </ul>
  </li>
</ul>

              
            </nav>
            <nav class="toc-custom">
              
            </nav>
          </aside>
        
        <h2 id="들어가며">들어가며</h2>
<p>해당 게시글은 인프런 김영한 강사님의 <a href="https://www.inflearn.com/course/스프링-데이터-JPA-실전/dashboard">실전! 스프링 데이터 JPA</a> 강의를 바탕으로 쓰였음을 미리 밝힙니다.</p>

<h2 id="공통-인터페이스-기능">공통 인터페이스 기능</h2>
<h3 id="공통-인터페이스-설정">공통 인터페이스 설정</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/JPA/SpringData/1.png">
          <img src="/assets/images/post/Spring/JPA/SpringData/1.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">org.springframework.data.repository.Repository</code> 를 구현한 클래스는 스캔 대상
    <ul>
      <li>Spring Data JPA가 인터페이스를 구현한 프록시 객체를 생성한다.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">@Repository</code> 애노테이션 생략 가능
    <ul>
      <li>Spring Data JPA가 컴포넌트 스캔을 자동으로 처리하여 Spring Context에서 관리하고 의존관계를 주입해준다.</li>
      <li>JPA 예외를 스프링 예외로 변환하는 과정도 자동으로 처리한다.</li>
    </ul>
  </li>
</ul>

<h3 id="공통-인터페이스-적용">공통 인터페이스 적용</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>T: 엔티티 타입</li>
  <li>ID: 식별자 타입(PK)</li>
</ul>

<h3 id="공통-인터페이스-분석">공통 인터페이스 분석</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/JPA/SpringData/2.png">
          <img src="/assets/images/post/Spring/JPA/SpringData/2.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>주요 메서드
    <ul>
      <li><code class="language-plaintext highlighter-rouge">save(S)</code> : 새로운 엔티티는 저장하고 이미 있는 엔티티는 병합한다.</li>
      <li><code class="language-plaintext highlighter-rouge">delete(T)</code> : 엔티티 하나를 삭제한다. 내부에서 <code class="language-plaintext highlighter-rouge">EntityManager.remove()</code> 호출</li>
      <li><code class="language-plaintext highlighter-rouge">findById(ID)</code> : 엔티티 하나를 조회한다. 내부에서 <code class="language-plaintext highlighter-rouge">EntityManager.find()</code> 호출</li>
      <li><code class="language-plaintext highlighter-rouge">getOne(ID)</code> : 엔티티를 프록시로 조회한다. 내부에서 <code class="language-plaintext highlighter-rouge">EntityManager.getReference()</code> 호출</li>
      <li><code class="language-plaintext highlighter-rouge">findAll(...)</code> : 모든 엔티티를 조회한다. 정렬(<code class="language-plaintext highlighter-rouge">Sort</code>)이나 페이징(<code class="language-plaintext highlighter-rouge">Pageable</code>) 조건을 파라미터로 제공할 수 있다.</li>
    </ul>
  </li>
</ul>

<h2 id="쿼리-메소드-기능">쿼리 메소드 기능</h2>
<h3 id="메소드-이름으로-쿼리-생성">메소드 이름으로 쿼리 생성</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsernameAndAgeGreaterThan</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>스프링 데이터 JPA는 메소드 이름을 분석해서 JPQL을 생성하고 실행</li>
  <li>쿼리 메소드 필터 조건: https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation</li>
  <li>이 기능은 엔티티의 필드명이 변경되면 인터페이스에 정의한 메서드 이름도 꼭 함께 변경해야 한다. 그렇지 않으면 애플리케이션을 시작하는 시점에 오류가 발생한다. 이렇게 애플리케이션 로딩 시점에 오류를 인지할 수 있는 것이 스프링 데이터 JPA의 매우 큰 장점이다.</li>
</ul>

<h3 id="query-리포지토리-메소드에-쿼리-정의하기"><code class="language-plaintext highlighter-rouge">@Query</code>, 리포지토리 메소드에 쿼리 정의하기</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Query</span><span class="o">(</span><span class="s">"select m from Member m where m.username= :username and m.age = :age"</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findUser</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"age"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">@org.springframework.data.jpa.repository.Query</code> 어노테이션을 사용</li>
  <li>JPA Named 쿼리처럼 애플리케이션 실행 시점에 문법 오류를 발견할 수 있음(매우 큰 장점!)</li>
</ul>

<h3 id="반환-타입">반환 타입</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span> <span class="c1">//컬렉션 </span>
<span class="nc">Member</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span> <span class="c1">//단건</span>
<span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span> <span class="c1">//단건 Optional</span>
</code></pre></div></div>
<ul>
  <li>조회 결과가 많거나 없으면?
    <ul>
      <li>컬렉션: 결과 없음: 빈 컬렉션 반환</li>
    </ul>
  </li>
  <li>단건 조회
    <ul>
      <li>결과 없음: <code class="language-plaintext highlighter-rouge">null</code> 반환</li>
      <li>결과가 2건 이상: <code class="language-plaintext highlighter-rouge">javax.persistence.NonUniqueResultException</code> 예외 발생</li>
    </ul>
  </li>
</ul>

<h3 id="순수-jpa-페이징과-정렬">순수 JPA 페이징과 정렬</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByPage</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select m from Member m where m.age = :age order by m.username desc"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="n">age</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setFirstResult</span><span class="o">(</span><span class="n">offset</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="n">limit</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">long</span> <span class="nf">totalCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select count(m) from Member m where m.age = :age"</span><span class="o">,</span> <span class="nc">Long</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="n">age</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getSingleResult</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="스프링-데이터-jpa-페이징과-정렬">스프링 데이터 JPA 페이징과 정렬</h3>
<ul>
  <li>페이징과 정렬 파라미터
    <ul>
      <li><code class="language-plaintext highlighter-rouge">org.springframework.data.domain.Sort</code>: 정렬 기능</li>
      <li><code class="language-plaintext highlighter-rouge">org.springframework.data.domain.Pageable</code>: 페이징 기능 (내부에 <code class="language-plaintext highlighter-rouge">Sort</code> 포함)</li>
    </ul>
  </li>
  <li>특별한 반환 타입
    <ul>
      <li><code class="language-plaintext highlighter-rouge">org.springframework.data.domain.Page</code>: 추가 count 쿼리 결과를 포함하는 페이징</li>
      <li><code class="language-plaintext highlighter-rouge">org.springframework.data.domain.Slice</code>: 추가 count 쿼리 없이 다음 페이지만 확인 가능 (내부적으로 limit + 1조회)</li>
      <li><code class="language-plaintext highlighter-rouge">List</code>(자바 컬렉션): 추가 count 쿼리 없이 결과만 반환</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">//count 쿼리 사용 </span>
<span class="nc">Slice</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">//count 쿼리 사용 안함</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">//count 쿼리 사용 안함</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Sort</span> <span class="n">sort</span><span class="o">);</span>
</code></pre></div></div>

<ul>
  <li>count 쿼리를 다음과 같이 분리할 수 있음(성능 최적화시 고려사항)</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="err">“</span><span class="n">select</span> <span class="n">m</span> <span class="n">from</span> <span class="nc">Member</span> <span class="n">m</span><span class="err">”</span><span class="o">,</span> <span class="n">countQuery</span> <span class="o">=</span> <span class="err">“</span><span class="n">select</span> <span class="nf">count</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">username</span><span class="o">)</span><span class="n">from</span> <span class="nc">Member</span> <span class="n">m</span><span class="err">”</span><span class="o">)</span>
<span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findMemberAllCountBy</span><span class="o">(</span><span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
</code></pre></div></div>
<ul>
  <li>페이지를 유지하면서 엔티티를 DTO로 변환하기</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findByAge</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">pageRequest</span><span class="o">);</span>
<span class="nc">Page</span><span class="o">&lt;</span><span class="nc">MemberDto</span><span class="o">&gt;</span> <span class="n">dtoPage</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">MemberDto</span><span class="o">());</span>
</code></pre></div></div>

<h3 id="벌크성-수정-쿼리">벌크성 수정 쿼리</h3>
<ul>
  <li>JPA를 사용한 벌크성 수정 쿼리</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">int</span> <span class="nf">bulkAgePlus</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">resultCount</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
                    <span class="s">"update Member m set m.age = m.age + 1"</span> <span class="o">+</span>
                            <span class="s">"where m.age &gt;= :age"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="n">age</span><span class="o">)</span>
            <span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">resultCount</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>스프링 데이터 JPA를 사용한 벌크성 수정 쿼리</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Modifying</span>
<span class="nd">@Query</span><span class="o">(</span><span class="s">"update Member m set m.age = m.age + 1 where m.age &gt;= :age"</span><span class="o">)</span>
<span class="kt">int</span> <span class="nf">bulkAgePlus</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"age"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
</code></pre></div></div>
<ul>
  <li>벌크성 수정, 삭제 쿼리는 <code class="language-plaintext highlighter-rouge">@Modifying</code> 어노테이션을 사용</li>
  <li>벌크성 쿼리를 실행하고 나서 영속성 컨텍스트 초기화: <code class="language-plaintext highlighter-rouge">@Modifying(clearAutomatically = true)</code> (이 옵션의 기본값은 <code class="language-plaintext highlighter-rouge">false</code> )
    <ul>
      <li>이 옵션 없이 회원을 <code class="language-plaintext highlighter-rouge">findById</code>로 다시 조회하면 영속성 컨텍스트에 과거 값이 남아서 문제가 될 수 있다. 만약 다시 조회해야 하면 꼭 영속성 컨텍스트를 초기화 하자.</li>
    </ul>
  </li>
  <li>권장하는 방안
    <ol>
      <li>영속성 컨텍스트에 엔티티가 없는 상태에서 벌크 연산을 먼저 실행한다.</li>
      <li>부득이하게 영속성 컨텍스트에 엔티티가 있으면 벌크 연산 직후 영속성 컨텍스트를 초기화 한다.</li>
    </ol>
  </li>
</ul>

<h3 id="entitygraph"><code class="language-plaintext highlighter-rouge">@EntityGraph</code></h3>
<ul>
  <li>JPQL 페치 조인</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="s">"select m from Member m left join fetch m.team"</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findMemberFetchJoin</span><span class="o">();</span>
</code></pre></div></div>
<ul>
  <li>스프링 데이터 JPA는 JPA가 제공하는 엔티티 그래프 기능을 편리하게 사용하게 도와준다. 이 기능을 사용하면 JPQL 없이 페치 조인을 사용할 수 있다. (JPQL + 엔티티 그래프도 가능)</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//공통 메서드 오버라이드</span>
<span class="nd">@Override</span>
<span class="nd">@EntityGraph</span><span class="o">(</span><span class="n">attributePaths</span> <span class="o">=</span> <span class="o">{</span><span class="s">"team"</span><span class="o">})</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>

<span class="c1">//JPQL + 엔티티 그래프 </span>
<span class="nd">@EntityGraph</span><span class="o">(</span><span class="n">attributePaths</span> <span class="o">=</span> <span class="o">{</span><span class="s">"team"</span><span class="o">})</span>
<span class="nd">@Query</span><span class="o">(</span><span class="s">"select m from Member m"</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findMemberEntityGraph</span><span class="o">();</span>

<span class="c1">//메서드 이름으로 쿼리에서 특히 편리하다. </span>
<span class="nd">@EntityGraph</span><span class="o">(</span><span class="n">attributePaths</span> <span class="o">=</span> <span class="o">{</span><span class="s">"team"</span><span class="o">})</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span>
</code></pre></div></div>
<ul>
  <li>사실상 페치 조인(FETCH JOIN)의 간편 버전</li>
  <li>LEFT OUTER JOIN 사용</li>
</ul>

<h3 id="jpa-hint--lock">JPA Hint &amp; Lock</h3>
<ul>
  <li>JPA 쿼리 힌트(SQL 힌트가 아니라 JPA 구현체에게 제공하는 힌트)</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@QueryHints</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nd">@QueryHint</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"org.hibernate.readOnly"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">"true"</span><span class="o">))</span>
<span class="nc">Member</span> <span class="nf">findReadOnlyByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">);</span>
</code></pre></div></div>
<p>–&gt; 변경 감지를 통한 update 쿼리가 실행되지 않는다.</p>

<h2 id="확장-기능">확장 기능</h2>
<h3 id="사용자-정의-리포지토리-구현">사용자 정의 리포지토리 구현</h3>
<ul>
  <li>스프링 데이터 JPA 리포지토리는 인터페이스만 정의하고 구현체는 스프링이 자동 생성</li>
  <li>스프링 데이터 JPA가 제공하는 인터페이스를 직접 구현하면 구현해야 하는 기능이 너무 많음</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepositoryCustom</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findMemberCustom</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRepositoryImpl</span> <span class="kd">implements</span> <span class="nc">MemberRepositoryCustom</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">EntityManager</span> <span class="n">em</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findMemberCustom</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select m from Member m"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;,</span> <span class="nc">MemberRepositoryCustom</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>스프링 데이터 JPA가 인식해서 스프링 빈으로 등록</li>
  <li>커스텀 인터페이스 이름은 자유</li>
  <li>규칙: 리포지토리 인터페이스 이름(<code class="language-plaintext highlighter-rouge">MemberRepository</code>) + <code class="language-plaintext highlighter-rouge">Impl</code> 또는 커스텀 리포지토리 인터페이스 이름(<code class="language-plaintext highlighter-rouge">MemberRepositoryCustom</code>) + <code class="language-plaintext highlighter-rouge">Impl</code></li>
  <li>항상 사용자 정의 리포지토리가 필요한 것은 아니다. 그냥 임의의 리포지토리를 만들어도 된다. 예를들어 <code class="language-plaintext highlighter-rouge">MemberQueryRepository</code>를 인터페이스가 아닌 클래스로 만들고 스프링 빈으로 등록해서 그냥 직접 사용해도 된다. 물론 이 경우 스프링 데이터 JPA와는 아무런 관계 없이 별도로 동작한다.</li>
</ul>

<p>–&gt; 핵심 비즈니스 로직이 필요한 리포지토리의 경우 굳이 인터페이스 커스톰을 통해 구현할 필요가 없다. 아키텍쳐 구조와 프레젠테이션 단계에서 필요한 로직 등을 종합적으로 고려하여 별도의 리포지토리 클래스를 만들지 아니면 하나의 커스텀 인터페이스로 구현할지를 정한다.</p>

<h3 id="auditing">Auditing</h3>
<ul>
  <li>엔티티를 생성, 변경할 때 변경한 사람과 시간을 추적</li>
  <li>순수 JPA 사용</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@MappedSuperclass</span>
<span class="nd">@Getter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JpaBaseEntity</span> <span class="o">{</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">createdDate</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">updatedDate</span><span class="o">;</span>

    <span class="nd">@PrePersist</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prePersist</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">LocalDateTime</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
        <span class="n">createdDate</span> <span class="o">=</span> <span class="n">now</span><span class="o">;</span>
        <span class="n">updatedDate</span> <span class="o">=</span> <span class="n">now</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@PreUpdate</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">preUpdate</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">updatedDate</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="kd">extends</span> <span class="nc">JpaBaseEntity</span> <span class="o">{}</span>
</code></pre></div></div>
<ul>
  <li>JPA 주요 이벤트 어노테이션: <code class="language-plaintext highlighter-rouge">@PrePersist</code>, <code class="language-plaintext highlighter-rouge">@PostPersist</code>, <code class="language-plaintext highlighter-rouge">@PreUpdate</code>, <code class="language-plaintext highlighter-rouge">@PostUpdate</code></li>
  <li>스프링 데이터 JPA 사용
    <ul>
      <li><code class="language-plaintext highlighter-rouge">@EnableJpaAuditing</code> -&gt; 스프링 부트 설정 클래스에 적용해야함</li>
      <li><code class="language-plaintext highlighter-rouge">@EntityListeners(AuditingEntityListener.class)</code> -&gt; 엔티티에 적용</li>
      <li>사용 어노테이션: <code class="language-plaintext highlighter-rouge">@CreatedDate</code>, <code class="language-plaintext highlighter-rouge">@LastModifiedDate</code>, <code class="language-plaintext highlighter-rouge">@CreatedBy</code>, <code class="language-plaintext highlighter-rouge">@LastModifiedBy</code></li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EntityListeners</span><span class="o">(</span><span class="nc">AuditingEntityListener</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@MappedSuperclass</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BaseEntity</span> <span class="o">{</span>
    <span class="nd">@CreatedDate</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">createdDate</span><span class="o">;</span>
    
    <span class="nd">@LastModifiedDate</span>
    <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">lastModifiedDate</span><span class="o">;</span>
    
    <span class="nd">@CreatedBy</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">createdBy</span><span class="o">;</span>
    
    <span class="nd">@LastModifiedBy</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lastModifiedBy</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">AuditorAware</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">auditorProvider</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>실무에서는 세션 정보나, 스프링 시큐리티 로그인 정보에서 ID를 받음</li>
  <li>특정 엔티티에 등록자, 수정자가 필요 없는 경우에는 Base 타입을 분리하고 필요에 따라 상속하면 된다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BaseTimeEntity</span> <span class="o">{</span>
    <span class="nd">@CreatedDate</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">createdDate</span><span class="o">;</span>
    <span class="nd">@LastModifiedDate</span>
    <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">lastModifiedDate</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BaseEntity</span> <span class="kd">extends</span> <span class="nc">BaseTimeEntity</span> <span class="o">{</span>
    <span class="nd">@CreatedBy</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">createdBy</span><span class="o">;</span>
    <span class="nd">@LastModifiedBy</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lastModifiedBy</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="web-확장---페이징과-정렬">Web 확장 - 페이징과 정렬</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/members"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">pageable</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">page</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>파라미터로 <code class="language-plaintext highlighter-rouge">Pageable</code> 을 받을 수 있다.</li>
  <li><code class="language-plaintext highlighter-rouge">Pageable</code> 은 인터페이스, 실제는 <code class="language-plaintext highlighter-rouge">org.springframework.data.domain.PageRequest</code> 객체 생성</li>
  <li>요청 파라미터(<code class="language-plaintext highlighter-rouge">/members?page=0&amp;size=3&amp;sort=id,desc&amp;sort=username,desc</code>)
    <ul>
      <li>page: 현재 페이지, 0부터 시작한다.</li>
      <li>size: 한 페이지에 노출할 데이터 건수</li>
    </ul>
  </li>
  <li>기본값</li>
  <li>글로벌 설정: 스프링 부트</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">spring.data.web.pageable.default-page-size=20 /# 기본 페이지 사이즈/</span> 
<span class="s">spring.data.web.pageable.max-page-size=2000 /# 최대 페이지 사이즈/</span>
</code></pre></div></div>
<ul>
  <li>개별 설정: <code class="language-plaintext highlighter-rouge">@PageableDefault</code> 어노테이션을 사용</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/members_page"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">list</span><span class="o">(</span><span class="nd">@PageableDefault</span><span class="o">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">12</span><span class="o">,</span> <span class="n">sort</span> <span class="o">=</span> <span class="err">“</span><span class="n">username</span><span class="err">”</span><span class="o">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">)</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>Page 내용을 DTO로 변환하기
    <ul>
      <li>엔티티를 API로 노출하면 다양한 문제가 발생한다. 그래서 엔티티를 꼭 DTO로 변환해서 반환해야 한다.</li>
      <li>Page는 <code class="language-plaintext highlighter-rouge">map()</code> 을 지원해서 내부 데이터를 다른 것으로 변경할 수 있다.</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/members"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">MemberDto</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">pageable</span><span class="o">);</span>
    <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">MemberDto</span><span class="o">&gt;</span> <span class="n">pageDto</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">MemberDto:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">pageDto</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>Page를 1부터 시작하기
    <ul>
      <li>스프링 데이터는 Page를 0부터 시작한다.</li>
      <li><code class="language-plaintext highlighter-rouge">Pageable</code>, <code class="language-plaintext highlighter-rouge">Page</code> 를 파리미터와 응답 값으로 사용히지 않고, 직접 클래스를 만들어서 처리한다.<br />
그리고 직접 <code class="language-plaintext highlighter-rouge">PageRequest</code>(<code class="language-plaintext highlighter-rouge">Pageable</code> 구현체)를 생성해서 리포지토리에 
넘긴다. 물론 응답값도 Page 대신에 직접 만들어서 제공해야 한다.</li>
    </ul>
  </li>
</ul>

<h2 id="스프링-데이터-jpa-분석">스프링 데이터 JPA 분석</h2>
<h3 id="스프링-데이터-jpa-구현체-분석">스프링 데이터 JPA 구현체 분석</h3>
<ul>
  <li>스프링 데이터 JPA가 제공하는 공통 인터페이스의 구현체(<code class="language-plaintext highlighter-rouge">org.springframework.data.jpa.repository.support.SimpleJpaRepositor</code>)</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Repository</span>
<span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleJpaRepository</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">ID</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">S</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="no">S</span> <span class="nf">save</span><span class="o">(</span><span class="no">S</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">entityInformation</span><span class="o">.</span><span class="na">isNew</span><span class="o">(</span><span class="n">entity</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">entity</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">em</span><span class="o">.</span><span class="na">merge</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">@Repository</code> 적용: JPA 예외를 스프링이 추상화한 예외로 변환</li>
  <li>@Transactional 트랜잭션 적용
    <ul>
      <li>JPA의 모든 변경은 트랜잭션 안에서 동작해야 한다.</li>
      <li>스프링 데이터 JPA는 변경(등록, 수정, 삭제) 메서드를 트랜잭션 처리</li>
      <li>서비스 계층에서 트랜잭션을 시작하지 않으면 리파지토리에서 트랜잭션 시작</li>
      <li>서비스 계층에서 트랜잭션을 시작하면 리파지토리는 해당 트랜잭션을 전파 받아서 사용</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">@Transactional(readOnly = true)</code>
    <ul>
      <li>데이터를 단순히 조회만 하고 변경하지 않는 트랜잭션에서 <code class="language-plaintext highlighter-rouge">readOnly = true</code> 옵션을 사용하면 플러시를 생략해서 약간의 성능 향상을 얻을 수 있음. 변경 감지 기능을 사용하지 않음.</li>
      <li>새로운 엔티티면 저장( <code class="language-plaintext highlighter-rouge">persist</code> ) - 식별자가 없을때</li>
      <li>새로운 엔티티가 아니면 병합( <code class="language-plaintext highlighter-rouge">merge</code> ) - 식별자가 있을때</li>
    </ul>
  </li>
</ul>

<h3 id="새로운-엔티티를-구별하는-방법">새로운 엔티티를 구별하는 방법</h3>
<ul>
  <li>새로운 엔티티를 판단하는 기본 전략
    <ul>
      <li>식별자가 객체일 때 <code class="language-plaintext highlighter-rouge">null</code> 로 판단</li>
      <li>식별자가 자바 기본 타입일 때 <code class="language-plaintext highlighter-rouge">0</code> 으로 판단</li>
      <li><code class="language-plaintext highlighter-rouge">Persistable</code> 인터페이스를 구현해서 판단 로직 변경 가능</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">org.springframework.data.domain</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Persistable</span><span class="o">&lt;</span><span class="no">ID</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="no">ID</span> <span class="nf">getId</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="nf">isNew</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>Persistable 구현</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@EntityListeners</span><span class="o">(</span><span class="nc">AuditingEntityListener</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@NoArgsConstructor</span><span class="o">(</span><span class="n">access</span> <span class="o">=</span> <span class="nc">AccessLevel</span><span class="o">.</span><span class="na">PROTECTED</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="kd">implements</span> <span class="nc">Persistable</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    
    <span class="nd">@CreatedDate</span>
    <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">createdDate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Item</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isNew</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">createdDate</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>JPA 식별자 생성 전략이 <code class="language-plaintext highlighter-rouge">@GenerateValue</code> 면 <code class="language-plaintext highlighter-rouge">save()</code> 호출 시점에 식별자가 없으므로 새로운 엔티티로 인식해서 정상 동작한다. 그런데 JPA 식별자 생성 전략이 <code class="language-plaintext highlighter-rouge">@Id</code> 만 사용해서 
직접 할당이면 이미 식별자 값이 있는 상태로 <code class="language-plaintext highlighter-rouge">save()</code> 를 호출한다. 따라서 이 경우 <code class="language-plaintext highlighter-rouge">merge()</code> 가 호출된다. <code class="language-plaintext highlighter-rouge">merge()</code> 는 우선 DB를 호출해서 값을 확인하고, DB에 값이 없으면 
새로운 엔티티로 인지하므로 매우 비효율 적이다.<br />
따라서 <code class="language-plaintext highlighter-rouge">Persistable</code> 를 사용해서 새로운 엔티티 확인 여부를 직접 구현하게는 효과적이다. 참고로 등록시간( <code class="language-plaintext highlighter-rouge">@CreatedDate</code> )을 
조합해서 사용하면 이 필드로 새로운 엔티티 여부를 편리하게 확인할 수 있다. 새로운 엔티티의 경우 <code class="language-plaintext highlighter-rouge">isNew()</code> 메소드 실행후 <code class="language-plaintext highlighter-rouge">persist()</code> 과정에서 JPA에 의해 <code class="language-plaintext highlighter-rouge">@CreatedDate</code> 가 
동작하기 때문이다.</li>
</ul>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#jpa" class="page__taxonomy-item" rel="tag">JPA</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#spring" class="page__taxonomy-item" rel="tag">Spring</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 카테고리: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#spring-jpa" class="page__taxonomy-item" rel="tag">Spring/JPA</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 업데이트:</strong> <time datetime="2021-10-24T00:00:00+09:00">October 24, 2021</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">공유하기</h4>
  

  <a href="https://twitter.com/intent/tweet?text=%5BSpring%5D%5BJPA%5D+%EC%8A%A4%ED%94%84%EB%A7%81+%EB%8D%B0%EC%9D%B4%ED%84%B0+JPA%20https%3A%2F%2Frere950303.github.io%2Fspring%2Fjpa%2FSpringDataJPA%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Frere950303.github.io%2Fspring%2Fjpa%2FSpringDataJPA%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Frere950303.github.io%2Fspring%2Fjpa%2FSpringDataJPA%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/spring/jpa/OSIV/" class="pagination--pager" title="[Spring][JPA] OSIV
">이전</a>
    
    
      <a href="/spring/jpa/save&merge/" class="pagination--pager" title="[Spring][JPA] 변경 감지와 병합
">다음</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">연관글</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/spring/security/SpringSecurity/" rel="permalink">[Spring][Security] 스프링 시큐리티
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2021-10-27T00:00:00+09:00">October 27, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          16 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/spring/jpa/querydsl/Querydsl/" rel="permalink">[Spring][JPA][Querydsl] Querydsl
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2021-10-27T00:00:00+09:00">October 27, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          11 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/spring/jpa/save&merge/" rel="permalink">[Spring][JPA] 변경 감지와 병합
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2021-10-24T00:00:00+09:00">October 24, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/spring/jpa/OSIV/" rel="permalink">[Spring][JPA] OSIV
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2021-10-20T00:00:00+09:00">October 20, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          최대 1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="검색어를 입력하세요..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      
        
      
        
      
        
          <li><a href="https://github.com/rere950303" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    
    
    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 yhw. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    <script>
  'use strict';

  (function() {
    var commentContainer = document.querySelector('#utterances-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://utteranc.es/client.js');
    script.setAttribute('repo', 'rere950303/rere950303.github.io');
    script.setAttribute('issue-term', 'title');
    script.setAttribute('theme', 'github-light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>

  





  </body>
</html>
