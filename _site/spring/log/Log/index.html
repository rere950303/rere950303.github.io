<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.20.2 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>[Spring][Log] 로깅 - YHW Blog</title>
<meta name="description" content="새로운 배움을 기록하고 공유합니다">


  <meta name="author" content="yhw">
  
  <meta property="article:author" content="yhw">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="YHW Blog">
<meta property="og:title" content="[Spring][Log] 로깅">
<meta property="og:url" content="https://rere950303.github.io/spring/log/Log/">


  <meta property="og:description" content="새로운 배움을 기록하고 공유합니다">







  <meta property="article:published_time" content="2021-12-23T00:00:00+09:00">





  

  


<link rel="canonical" href="https://rere950303.github.io/spring/log/Log/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "yhw",
      "url": "https://rere950303.github.io/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="YHW Blog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
<link rel="manifest" href="/favicon/site.webmanifest">
<link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          YHW Blog
          <span class="site-subtitle">새로운 배움을 기록하고 공유합니다</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/">categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">토글 메뉴</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://rere950303.github.io/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#spring" itemprop="item"><span itemprop="name">Spring</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#log" itemprop="item"><span itemprop="name">Log</span></a>
          <meta itemprop="position" content="3" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">[Spring][Log] 로깅</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/bio/photo.png" alt="yhw" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">yhw</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>어제와 다른 오늘, 오늘 같은 내일</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">팔로우</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Republic of Korea</span>
        </li>
      

      
        
          
            <li><a href="mailto:yhwjjang1995@naver.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
        
          
        
          
            <li><a href="https://github.com/rere950303" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="[Spring][Log] 로깅">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2021-12-23T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">[Spring][Log] 로깅
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2021-12-23T00:00:00+09:00">December 23, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 분 소요
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              
                <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
                <ul class="toc__menu">
  <li><a href="#로깅-라이브러리">로깅 라이브러리</a></li>
  <li><a href="#로그-선언">로그 선언</a></li>
  <li><a href="#로그-레벨-설정">로그 레벨 설정</a></li>
  <li><a href="#올바른-로그-사용법">올바른 로그 사용법</a></li>
  <li><a href="#쓰레드-로컬---threadlocal">쓰레드 로컬 - ThreadLocal</a>
    <ul>
      <li><a href="#필드-동기화---개발">필드 동기화 - 개발</a></li>
      <li><a href="#필드-동기화---동시성-문제">필드 동기화 - 동시성 문제</a></li>
      <li><a href="#threadlocal---소개">ThreadLocal - 소개</a></li>
      <li><a href="#쓰레드-로컬-동기화---개발">쓰레드 로컬 동기화 - 개발</a></li>
      <li><a href="#쓰레드-로컬-동기화---적용">쓰레드 로컬 동기화 - 적용</a></li>
      <li><a href="#쓰레드-로컬---주의사항">쓰레드 로컬 - 주의사항</a></li>
    </ul>
  </li>
</ul>

              
            </nav>
            <nav class="toc-custom">
              
            </nav>
          </aside>
        
        <h2 id="로깅-라이브러리">로깅 라이브러리</h2>
<p>스프링 부트 라이브러리를 사용하면 스프링 부트 로깅 라이브러리( <code class="language-plaintext highlighter-rouge">spring-boot-starter-logging</code> )가 함께 포함된다. 스프링 부트 로깅 라이브러리는 기본으로 다음 로깅 라이브러리를 사용한다.</p>
<ul>
  <li>SLF4J, Logback</li>
  <li>로그 라이브러리는 Logback, Log4J, Log4J2 등등 수 많은 라이브러리가 있는데, 그것을 통합해서 인터페이스로 제공하는 것이 바로 SLF4J 라이브러리다. 쉽게 이야기해서 SLF4J는 인터페이스이고, 그 구현체로 Logback 같은 로그 라이브러리를 선택하면 된다. 실무에서는 스프링 부트가 기본으로 제공하는 Logback을 대부분 사용한다.</li>
</ul>

<h2 id="로그-선언">로그 선언</h2>
<ul>
  <li><code class="language-plaintext highlighter-rouge">private Logger log = LoggerFactory.getLogger(getClass());</code></li>
  <li><code class="language-plaintext highlighter-rouge">@Slf4j</code> : 롬복 사용 가능</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//@Slf4j</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogTestController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">getClass</span><span class="o">());</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/log-test"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">logTest</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"Spring"</span><span class="o">;</span>
        <span class="n">log</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"trace log={}"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"debug log={}"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">" info log={}"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">" warn log={}"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"error log={}"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
        <span class="c1">//로그를 사용하지 않아도 a+b 계산 로직이 먼저 실행됨, 이런 방식으로 사용하면 X </span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"String concat log="</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"ok"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>LEVEL: TRACE &gt; DEBUG &gt; INFO &gt; WARN &gt; ERROR</li>
  <li>개발 서버는 debug 출력</li>
  <li>운영 서버는 info 출력</li>
</ul>

<h2 id="로그-레벨-설정">로그 레벨 설정</h2>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#전체 로그 레벨 설정(기본 info) </span>
<span class="s">logging.level.root=info</span>

<span class="c1">#hello.springmvc 패키지와 그 하위 로그 레벨 설정 </span>
<span class="s">logging.level.hello.springmvc=debug</span>
</code></pre></div></div>

<h2 id="올바른-로그-사용법">올바른 로그 사용법</h2>
<ul>
  <li><code class="language-plaintext highlighter-rouge">log.debug("data="+data)</code>: 로그 출력 레벨을 info로 설정해도 해당 코드에 있는 “data=”+data가 실제 실행이 되어 버린다. 결과적으로 문자 더하기 연산이 발생한다.</li>
  <li><code class="language-plaintext highlighter-rouge">log.debug("data={}", data)</code>: 로그 출력 레벨을 info로 설정하면 아무일도 발생하지 않는다. 따라서 앞과 같은 의미없는 연산이 발생하지 않는다.</li>
</ul>

<h2 id="쓰레드-로컬---threadlocal">쓰레드 로컬 - ThreadLocal</h2>
<h3 id="필드-동기화---개발">필드 동기화 - 개발</h3>
<p><code class="language-plaintext highlighter-rouge">TraceId</code> 를 파라미터로 넘기지 않고 동기화를 할 수 없을까?</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FieldLogTrace</span> <span class="kd">implements</span> <span class="nc">LogTrace</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">START_PREFIX</span> <span class="o">=</span> <span class="s">"--&gt;"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">COMPLETE_PREFIX</span> <span class="o">=</span> <span class="s">"&lt;--"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">EX_PREFIX</span> <span class="o">=</span> <span class="s">"&lt;X-"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">TraceId</span> <span class="n">traceIdHolder</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">TraceStatus</span> <span class="nf">begin</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">syncTraceId</span><span class="o">();</span>
        <span class="nc">TraceId</span> <span class="n">traceId</span> <span class="o">=</span> <span class="n">traceIdHolder</span><span class="o">;</span>
        <span class="nc">Long</span> <span class="n">startTimeMs</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[{}] {}{}"</span><span class="o">,</span> <span class="n">traceId</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">addSpace</span><span class="o">(</span><span class="no">START_PREFIX</span><span class="o">,</span> <span class="n">traceId</span><span class="o">.</span><span class="na">getLevel</span><span class="o">()),</span> <span class="n">message</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">TraceStatus</span><span class="o">(</span><span class="n">traceId</span><span class="o">,</span> <span class="n">startTimeMs</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">syncTraceId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">traceIdHolder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">traceIdHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TraceId</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">traceIdHolder</span> <span class="o">=</span> <span class="n">traceIdHolder</span><span class="o">.</span><span class="na">createNextId</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">complete</span><span class="o">(</span><span class="nc">TraceStatus</span> <span class="n">status</span><span class="o">,</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>

        <span class="n">releaseTraceId</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">releaseTraceId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">traceIdHolder</span><span class="o">.</span><span class="na">isFirstLevel</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">traceIdHolder</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">traceIdHolder</span> <span class="o">=</span> <span class="n">traceIdHolder</span><span class="o">.</span><span class="na">createPreviousId</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogTraceConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">LogTrace</span> <span class="nf">logTrace</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">FieldLogTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">TraceId</code> 를 동기화 하는 부분만 파라미터를 사용하는 것에서 <code class="language-plaintext highlighter-rouge">TraceId traceIdHolder</code> 필드를 사용하도록 변경되었다.</li>
  <li>이제 직전 로그의 <code class="language-plaintext highlighter-rouge">TraceId</code> 는 파라미터로 전달되는 것이 아니라 <code class="language-plaintext highlighter-rouge">FieldLogTrace</code> 의 필드인 <code class="language-plaintext highlighter-rouge">traceIdHolder</code> 에 저장된다.</li>
</ul>

<h3 id="필드-동기화---동시성-문제">필드 동기화 - 동시성 문제</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">FieldLogTrace</code> 는 싱글톤으로 등록된 스프링 빈이다. 이 객체의 인스턴스가 애플리케이션에 딱 1 존재한다는 뜻이다. 이렇게 하나만 있는 인스턴스의 <code class="language-plaintext highlighter-rouge">FieldLogTrace.traceIdHolder</code> 필드를 여러 쓰레드가 동시에 접근하기 때문에 문제가 발생한다.</li>
  <li>결과적으로 <code class="language-plaintext highlighter-rouge">Thread-A</code> 입장에서는 저장한 데이터와 조회한 데이터가 다른 문제가 발생한다. 이처럼 여러 쓰레드가 동시에 같은 인스턴스의 필드 값을 변경하면서 발생하는 문제를 동시성 문제라 한다. 이런 동시성 문제는 여러 쓰레드가 같은 인스턴스의 필드에 접근해야 하기 때문에 트래픽이 적은 상황에서는 확률상 잘 나타나지 않고, 트래픽이 점점 많아질 수 록 자주 발생한다.
특히 스프링 빈 처럼 싱글톤 객체의 필드를 변경하며 사용할 때 이러한 동시성 문제를 조심해야 한다.</li>
  <li>동시성 문제가 발생하는 곳은 같은 인스턴스의 필드(주로 싱글톤에서 자주 발생), 또는 static 같은 공용 필드에 접근할 때 발생한다. 동시성 문제는 값을 읽기만 하면 발생하지 않는다. 어디선가 값을 변경하기 때문에 발생한다.</li>
</ul>

<h3 id="threadlocal---소개">ThreadLocal - 소개</h3>
<ul>
  <li>쓰레드 로컬은 해당 쓰레드만 접근할 수 있는 특별한 저장소를 말한다. 쉽게 이야기해서 물건 보관 창구를 떠올리면 된다. 쓰레드 단위로 map를 이용하여 필드값을 저장한다.</li>
  <li>자바는 언어차원에서 쓰레드 로컬을 지원하기 위한 <code class="language-plaintext highlighter-rouge">java.lang.ThreadLocal</code> 클래스를 제공한다.</li>
  <li>ThreadLocal 사용법
    <ul>
      <li>값 저장: <code class="language-plaintext highlighter-rouge">ThreadLocal.set(xxx)</code></li>
      <li>값 조회: <code class="language-plaintext highlighter-rouge">ThreadLocal.get()</code></li>
      <li>값 제거: <code class="language-plaintext highlighter-rouge">ThreadLocal.remove()</code></li>
    </ul>
  </li>
</ul>

<h3 id="쓰레드-로컬-동기화---개발">쓰레드 로컬 동기화 - 개발</h3>
<p><code class="language-plaintext highlighter-rouge">FieldLogTrace</code> 에서 발생했던 동시성 문제를 <code class="language-plaintext highlighter-rouge">ThreadLocal</code> 로 해결해보자. <code class="language-plaintext highlighter-rouge">TraceId traceIdHolder</code> 필드를 쓰레드 로컬을 사용하도록 <code class="language-plaintext highlighter-rouge">ThreadLocal&lt;TraceId&gt; traceIdHolder</code> 로 변경하면 된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span>  <span class="nc">ThreadLocalLogTrace</span> <span class="kd">implements</span> <span class="nc">LogTrace</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">START_PREFIX</span> <span class="o">=</span> <span class="s">"--&gt;"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">COMPLETE_PREFIX</span> <span class="o">=</span> <span class="s">"&lt;--"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">EX_PREFIX</span> <span class="o">=</span> <span class="s">"&lt;X-"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">TraceId</span><span class="o">&gt;</span> <span class="n">traceIdHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;&gt;();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">TraceStatus</span> <span class="nf">begin</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">syncTraceId</span><span class="o">();</span>
        <span class="nc">TraceId</span> <span class="n">traceId</span> <span class="o">=</span> <span class="n">traceIdHolder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="nc">Long</span> <span class="n">startTimeMs</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[{}] {}{}"</span><span class="o">,</span> <span class="n">traceId</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">addSpace</span><span class="o">(</span><span class="no">START_PREFIX</span><span class="o">,</span> <span class="n">traceId</span><span class="o">.</span><span class="na">getLevel</span><span class="o">()),</span> <span class="n">message</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">TraceStatus</span><span class="o">(</span><span class="n">traceId</span><span class="o">,</span> <span class="n">startTimeMs</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">syncTraceId</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">TraceId</span> <span class="n">traceId</span> <span class="o">=</span> <span class="n">traceIdHolder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">traceId</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">traceIdHolder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">new</span> <span class="nc">TraceId</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">traceIdHolder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">traceId</span><span class="o">.</span><span class="na">createNextId</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">complete</span><span class="o">(</span><span class="nc">TraceStatus</span> <span class="n">status</span><span class="o">,</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>

        <span class="n">releaseTraceId</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">releaseTraceId</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">TraceId</span> <span class="n">traceId</span> <span class="o">=</span> <span class="n">traceIdHolder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">traceId</span><span class="o">.</span><span class="na">isFirstLevel</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">traceIdHolder</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">traceIdHolder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">traceId</span><span class="o">.</span><span class="na">createPreviousId</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="쓰레드-로컬-동기화---적용">쓰레드 로컬 동기화 - 적용</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogTraceConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">LogTrace</span> <span class="nf">logTrace</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//return new FieldLogTrace();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ThreadLocalLogTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="쓰레드-로컬---주의사항">쓰레드 로컬 - 주의사항</h3>
<ul>
  <li>WAS는 HTTP 요청이 들어오면 쓰레드풀에서 쓰레드를 할당한다. 만약 사용자 A의 HTTP요청이 끝나고 나갈때 쓰레드 로컬에서 해당 쓰레드에 대응되는 value(TraceId)값을 삭제하지 않는다면 사용자 A에 대한 데이터는 그대로 남게된다. 이후 사용자 B의 HTTP요청에 대해 같은 쓰레트가 할당된다면 사용자 B는 쓰레드 로컬에서 사용자 A에 대한 데이터를 조회할 수 있게 된다. 이는 매우 심각한 문제이다.</li>
  <li>이런 문제를 예방하려면 사용자A의 요청이 끝날 때 쓰레드 로컬의 값을 <code class="language-plaintext highlighter-rouge">ThreadLocal.remove()</code> 를 통해서 꼭 제거해야 한다. 쓰레드 로컬을 사용할 때는 이 부분을 꼭! 기억하자.</li>
</ul>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#logback" class="page__taxonomy-item" rel="tag">Logback</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#log" class="page__taxonomy-item" rel="tag">Log</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#slf4j" class="page__taxonomy-item" rel="tag">SLF4J</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#spring" class="page__taxonomy-item" rel="tag">Spring</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 카테고리: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#spring-log" class="page__taxonomy-item" rel="tag">Spring/Log</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 업데이트:</strong> <time datetime="2021-12-23T00:00:00+09:00">December 23, 2021</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">공유하기</h4>
  

  <a href="https://twitter.com/intent/tweet?text=%5BSpring%5D%5BLog%5D+%EB%A1%9C%EA%B9%85%20https%3A%2F%2Frere950303.github.io%2Fspring%2Flog%2FLog%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Frere950303.github.io%2Fspring%2Flog%2FLog%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Frere950303.github.io%2Fspring%2Flog%2FLog%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/docker/Docker&CI/" class="pagination--pager" title="[Docker] 도커와 CI환경
">이전</a>
    
    
      <a href="/spring/restful/RESTful/" class="pagination--pager" title="[Spring][RESTful] RESTful Web Services 개발
">다음</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">연관글</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/aws/AWS_EBS/" rel="permalink">[AWS] EBS
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-01-30T00:00:00+09:00">January 30, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          최대 1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/spring/security/SpringSecurity2/" rel="permalink">[Spring][Security] 스프링 시큐리티
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-01-25T00:00:00+09:00">January 25, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          8 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/spring/core/SpringCore_advanced/" rel="permalink">[Spring][Core] 스프링 핵심 원리-고급편
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-01-23T00:00:00+09:00">January 23, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          50 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/spring/deploy/JenkinsCICD/" rel="permalink">[Spring][Deploy] Jenkins를 이용한 CI, CD
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-01-18T00:00:00+09:00">January 18, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          2 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="검색어를 입력하세요..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      
        
      
        
      
        
          <li><a href="https://github.com/rere950303" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    
    
    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 yhw. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    <script>
  'use strict';

  (function() {
    var commentContainer = document.querySelector('#utterances-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://utteranc.es/client.js');
    script.setAttribute('repo', 'rere950303/rere950303.github.io');
    script.setAttribute('issue-term', 'title');
    script.setAttribute('theme', 'github-light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>

  





  </body>
</html>
