<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.20.2 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>[Spring][Security] 스프링 시큐리티 재정리 - YHW Blog</title>
<meta name="description" content="새로운 배움을 기록하고 공유합니다">


  <meta name="author" content="yhw">
  
  <meta property="article:author" content="yhw">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="YHW Blog">
<meta property="og:title" content="[Spring][Security] 스프링 시큐리티 재정리">
<meta property="og:url" content="https://rere950303.github.io/spring/security/SpringSecurity2/">


  <meta property="og:description" content="새로운 배움을 기록하고 공유합니다">







  <meta property="article:published_time" content="2022-02-05T00:00:00+09:00">





  

  


<link rel="canonical" href="https://rere950303.github.io/spring/security/SpringSecurity2/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "yhw",
      "url": "https://rere950303.github.io/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="YHW Blog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
<link rel="manifest" href="/favicon/site.webmanifest">
<link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          YHW Blog
          <span class="site-subtitle">새로운 배움을 기록하고 공유합니다</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/">categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">토글 메뉴</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://rere950303.github.io/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#spring" itemprop="item"><span itemprop="name">Spring</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#security" itemprop="item"><span itemprop="name">Security</span></a>
          <meta itemprop="position" content="3" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">[Spring][Security] 스프링 시큐리티 재정리</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/bio/photo.jpg" alt="yhw" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">yhw</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>어제와 다른 오늘, 오늘 같은 내일</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">팔로우</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Republic of Korea</span>
        </li>
      

      
        
          
            <li><a href="mailto:yhwjjang1995@naver.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
        
          
        
          
            <li><a href="https://github.com/rere950303" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="[Spring][Security] 스프링 시큐리티 재정리">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2022-02-05T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">[Spring][Security] 스프링 시큐리티 재정리
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-02-05T00:00:00+09:00">February 5, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          18 분 소요
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              
                <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
                <ul class="toc__menu">
  <li><a href="#들어가며">들어가며</a></li>
  <li><a href="#스프링-시큐리티-기본-api-및-filter-이해">스프링 시큐리티 기본 API 및 Filter 이해</a>
    <ul>
      <li><a href="#사용자-정의-보안-기능-구현">사용자 정의 보안 기능 구현</a></li>
      <li><a href="#http-basic-인증-basicauthenticationfilter">HTTP Basic 인증, BasicAuthenticationFilter</a>
        <ul>
          <li><a href="#http-basic-인증">HTTP Basic 인증</a></li>
          <li><a href="#basicauthenticationfilter">BasicAuthenticationFilter</a></li>
        </ul>
      </li>
      <li><a href="#form-인증">Form 인증</a></li>
      <li><a href="#usernamepasswordauthenticationfilter">UsernamePasswordAuthenticationFilter</a></li>
      <li><a href="#logout-logoutfilter">Logout, LogoutFilter</a></li>
      <li><a href="#remember-me--remembermeauthenticationfilter">Remember Me &amp; RememberMeAuthenticationFilter</a></li>
      <li><a href="#anonymousauthenticationfilter">AnonymousAuthenticationFilter</a></li>
      <li><a href="#동시-세션-제어--세션고정보호--세션-정책">동시 세션 제어 / 세션고정보호 / 세션 정책</a>
        <ul>
          <li><a href="#동시-세션-제어">동시 세션 제어</a></li>
          <li><a href="#세션-고정-보호-사용자">세션 고정 보호 사용자</a></li>
          <li><a href="#세션-정책">세션 정책</a></li>
        </ul>
      </li>
      <li><a href="#sessionmanagementfilter--concurrentsessionfilter">SessionManagementFilter &amp; ConcurrentSessionFilter</a>
        <ul>
          <li><a href="#sessionmanagementfilter">SessionManagementFilter</a></li>
          <li><a href="#concurrentsessionfilter">ConcurrentSessionFilter</a></li>
        </ul>
      </li>
      <li><a href="#권한-설정-및-표현식">권한 설정 및 표현식</a></li>
      <li><a href="#exceptiontranslationfilter--requestcacheawarefilter">ExceptionTranslationFilter &amp; RequestCacheAwareFilter</a>
        <ul>
          <li><a href="#exceptiontranslationfilter">ExceptionTranslationFilter</a></li>
          <li><a href="#requestcacheawarefilter">RequestCacheAwareFilter</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#스프링-시큐리티-주요-아키텍처-이해">스프링 시큐리티 주요 아키텍처 이해</a>
    <ul>
      <li><a href="#delegatingfilterproxy--filterchainproxy">DelegatingFilterProxy &amp; FilterChainProxy</a>
        <ul>
          <li><a href="#delegatingfilterproxy">DelegatingFilterProxy</a></li>
          <li><a href="#filterchainproxy">FilterChainProxy</a></li>
        </ul>
      </li>
      <li><a href="#필터-초기화와-다중-보안-설정">필터 초기화와 다중 보안 설정</a></li>
      <li><a href="#authentication">Authentication</a></li>
      <li><a href="#securitycontextholder-securitycontext">SecurityContextHolder, SecurityContext</a>
        <ul>
          <li><a href="#securitycontext">SecurityContext</a></li>
          <li><a href="#securitycontextholder">SecurityContextHolder</a></li>
        </ul>
      </li>
      <li><a href="#securitycontextpersistencefilter">SecurityContextPersistenceFilter</a></li>
      <li><a href="#authentication-flow">Authentication Flow</a></li>
      <li><a href="#authenticationmanager">AuthenticationManager</a></li>
      <li><a href="#authenticationprovider">AuthenticationProvider</a></li>
      <li><a href="#authorization-filtersecurityinterceptor">Authorization, FilterSecurityInterceptor</a>
        <ul>
          <li><a href="#authorization">Authorization</a></li>
          <li><a href="#filtersecurityinterceptor">FilterSecurityInterceptor</a></li>
        </ul>
      </li>
      <li><a href="#accessdecisionmanager-accessdecisionvoter">AccessDecisionManager, AccessDecisionVoter</a>
        <ul>
          <li><a href="#accessdecisionmanager">AccessDecisionManager</a></li>
          <li><a href="#accessdecisionvoter">AccessDecisionVoter</a></li>
        </ul>
      </li>
      <li><a href="#스프링-시큐리티-필터-및-아키텍처-정리">스프링 시큐리티 필터 및 아키텍처 정리</a></li>
    </ul>
  </li>
  <li><a href="#실전프로젝트--인증-프로세스-form-인증-구현">실전프로젝트 -인증 프로세스 Form 인증 구현</a>
    <ul>
      <li><a href="#customauthenticationprovider">CustomAuthenticationProvider</a></li>
      <li><a href="#로그아웃">로그아웃</a></li>
      <li><a href="#webauthenticationdetails-authenticationdetailssource">WebAuthenticationDetails, AuthenticationDetailsSource</a></li>
      <li><a href="#customauthenticationsuccesshandler">CustomAuthenticationSuccessHandler</a></li>
      <li><a href="#customauthenticationfailurehandler">CustomAuthenticationFailureHandler</a></li>
    </ul>
  </li>
  <li><a href="#실전프로젝트---인증-프로세스-ajax-인증-구현">실전프로젝트 - 인증 프로세스 Ajax 인증 구현</a>
    <ul>
      <li><a href="#흐름-및-개요">흐름 및 개요</a></li>
      <li><a href="#ajaxauthenticationfilter">AjaxAuthenticationFilter</a></li>
      <li><a href="#ajaxauthenticationprovider">AjaxAuthenticationProvider</a></li>
      <li><a href="#ajaxauthenticationsuccesshandler-ajaxauthenticationfailurehandler">AjaxAuthenticationSuccessHandler, AjaxAuthenticationFailureHandler</a>
        <ul>
          <li><a href="#ajaxauthenticationsuccesshandler">AjaxAuthenticationSuccessHandler</a></li>
          <li><a href="#ajaxauthenticationfailurehandler">AjaxAuthenticationFailureHandler</a></li>
        </ul>
      </li>
      <li><a href="#ajaxloginurlauthenticationentrypoint-ajaxaccessdeniedhandler">AjaxLoginUrlAuthenticationEntryPoint, AjaxAccessDeniedHandler</a>
        <ul>
          <li><a href="#ajaxloginurlauthenticationentrypoint">AjaxLoginUrlAuthenticationEntryPoint</a></li>
          <li><a href="#ajaxaccessdeniedhandler">AjaxAccessDeniedHandler</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#실전프로젝트---인가-프로세스-db-연동-웹-계층-구현">실전프로젝트 - 인가 프로세스 DB 연동 웹 계층 구현</a>
    <ul>
      <li><a href="#개요">개요</a></li>
      <li><a href="#url-방식---주요-아키텍처-이해">Url 방식 - 주요 아키텍처 이해</a></li>
      <li><a href="#filterinvocationsecuritymetadatasource">FilterInvocationSecurityMetadataSource</a></li>
      <li><a href="#map-기반-db-연동">Map 기반 DB 연동</a></li>
      <li><a href="#인가처리-실시간-반영하기">인가처리 실시간 반영하기</a></li>
      <li><a href="#permitallfilter-구현">PermitAllFilter 구현</a></li>
      <li><a href="#계층-권한-적용하기">계층 권한 적용하기</a></li>
      <li><a href="#아이피-접속-제한하기">아이피 접속 제한하기</a></li>
      <li><a href="#여러-종류의-voter">여러 종류의 voter</a></li>
    </ul>
  </li>
  <li><a href="#실전프로젝트---인가-프로세스-db-연동-서비스-계층-구현">실전프로젝트 - 인가 프로세스 DB 연동 서비스 계층 구현</a>
    <ul>
      <li><a href="#개요-1">개요</a></li>
      <li><a href="#어노테이션-권한-설정">어노테이션 권한 설정</a></li>
      <li><a href="#주요-아키텍처">주요 아키텍처</a></li>
      <li><a href="#map-기반-db-연동-1">Map 기반 DB 연동 (1)</a></li>
      <li><a href="#-map-기반-db-연동-2">### Map 기반 DB 연동 (2)</a></li>
      <li><a href="#protectpointcutpostprocessor">ProtectPointcutPostProcessor</a></li>
    </ul>
  </li>
</ul>

              
            </nav>
            <nav class="toc-custom">
              
            </nav>
          </aside>
        
        <h2 id="들어가며">들어가며</h2>
<p>해당 게시글은 인프런 정수원 강사님의 <a href="https://www.inflearn.com/course/코어-스프링-시큐리티/dashboard">스프링 시큐리티 - Spring Boot 기반으로 개발하는 Spring Security</a> 강의를 바탕으로 쓰였음을 미리 밝힙니다.</p>

<h2 id="스프링-시큐리티-기본-api-및-filter-이해">스프링 시큐리티 기본 API 및 Filter 이해</h2>
<h3 id="사용자-정의-보안-기능-구현">사용자 정의 보안 기능 구현</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">WebSecurityConfigurerAdapter</code> 상속</li>
  <li>인증 API</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">http</span><span class="o">.</span><span class="na">formLogin</span><span class="o">()</span>
<span class="n">http</span><span class="o">.</span><span class="na">logout</span><span class="o">()</span>
<span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">()</span>
<span class="n">http</span><span class="o">.</span><span class="na">httpBasic</span><span class="o">()</span>
<span class="n">http</span><span class="o">.</span><span class="na">SessionManagement</span><span class="o">()</span>
<span class="n">http</span><span class="o">.</span><span class="na">RememberMe</span><span class="o">()</span>
<span class="n">http</span><span class="o">.</span><span class="na">ExceptionHandling</span> <span class="o">()</span>
<span class="n">http</span><span class="o">.</span><span class="na">addFilter</span><span class="o">()</span>
</code></pre></div></div>
<ul>
  <li>인가 API</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
    <span class="o">.</span><span class="na">antMatchers</span><span class="o">(/</span><span class="n">admin</span><span class="o">)</span>
    <span class="o">.</span><span class="na">hasRole</span><span class="o">(</span><span class="no">USER</span><span class="o">)</span>
    <span class="o">.</span><span class="na">permitAll</span><span class="o">()</span>
    <span class="o">.</span><span class="na">authenticated</span><span class="o">()</span>
    <span class="o">.</span><span class="na">fullyAuthentication</span><span class="o">()</span>
    <span class="o">.</span><span class="na">acess</span><span class="o">(</span><span class="n">hasRole</span><span class="o">(</span><span class="no">USER</span><span class="o">))</span>
</code></pre></div></div>

<h3 id="http-basic-인증-basicauthenticationfilter">HTTP Basic 인증, BasicAuthenticationFilter</h3>
<h4 id="http-basic-인증">HTTP Basic 인증</h4>
<ul>
  <li>HTTP는 자체적인 인증 관련 기능을 제공하며 HTTP 표준에 정의된 가장 단순한 인증 기법이다</li>
  <li>간단한 설정과 Stateless가 장점 - Session Cookie(JSESSIONID) 사용하지 않음</li>
  <li>보호자원 접근시 서버가 클라이언트에게 401 Unauthorized 응답과 함께 WWW-Authenticate header를 기술해서 인증요구를 보냄</li>
  <li>Client는 ID:Password 값을 Base64로 Encoding한 문자열을 Authorization Header에 추가한 뒤 Server에게 Resource를 요청(Authorization: Basic cmVzdDpyZXN0)</li>
  <li>ID, Password가 Base64로 Encoding되어 있어 ID, Password가 외부에 쉽게 노출되는 구조이기 때문에 SSL이나 TLS는 필수이다</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span><span class="o">.</span><span class="na">httpBasic</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="basicauthenticationfilter">BasicAuthenticationFilter</h4>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/1.png">
          <img src="/assets/images/post/Spring/Security2/1.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="form-인증">Form 인증</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/2.png">
          <img src="/assets/images/post/Spring/Security2/2.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>세션 아이디(JSESSIONID)를 키로 해서 <code class="language-plaintext highlighter-rouge">SecurityContext</code>를 세션 저장소에 저장</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span>
            <span class="o">.</span><span class="na">formLogin</span><span class="o">()</span>
            <span class="o">.</span><span class="na">loginPage</span><span class="o">(</span><span class="s">"/login.html"</span><span class="o">)</span> <span class="c1">// URI 설정도 가능</span>
            <span class="o">.</span><span class="na">defaultSuccessUrl</span><span class="o">(</span><span class="s">"/home"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">failureUrl</span><span class="o">(</span><span class="s">"/login.html?error=true"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">usernameParameter</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">passwordParameter</span><span class="o">(</span><span class="s">"password"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="usernamepasswordauthenticationfilter">UsernamePasswordAuthenticationFilter</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/3.png">
          <img src="/assets/images/post/Spring/Security2/3.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">User</code>는 <code class="language-plaintext highlighter-rouge">UserDetails</code> 구현체</li>
  <li><code class="language-plaintext highlighter-rouge">UsernamePasswordAuthenticationFilter</code>에서 발생한 <code class="language-plaintext highlighter-rouge">AuthenticationException</code>의 경우 <code class="language-plaintext highlighter-rouge">AbstractAuthenticationProcessingFilter</code>에서 처리</li>
</ul>

<h3 id="logout-logoutfilter">Logout, LogoutFilter</h3>
<ul>
  <li>세션 저장소에 있는 세션을 없애고 쿠키 정보를 삭제</li>
  <li>로그인 페이지로 리다이렉트</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span>
            <span class="o">.</span><span class="na">logout</span><span class="o">()</span>
            <span class="o">.</span><span class="na">logoutUrl</span><span class="o">(</span><span class="s">"/logout"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">logoutSuccessUrl</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span> <span class="c1">// 여러가지 기본 구현체를 제공</span>
            <span class="o">.</span><span class="na">deleteCookies</span><span class="o">(</span><span class="s">"JSESSIONID"</span><span class="o">,</span> <span class="s">"remember-me"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">addLogoutHandler</span><span class="o">(</span><span class="n">logoutHandler</span><span class="o">())</span> <span class="c1">// 여러가지 기본 구현체를 제공</span>
            <span class="o">.</span><span class="na">logoutSuccessHandler</span><span class="o">(</span><span class="n">logoutSuccessHandler</span><span class="o">())</span>
<span class="o">}</span>
</code></pre></div></div>

<figure class="half ">
  
    
      <a href="/assets/images/post/Spring/Security2/4.png">
          <img src="/assets/images/post/Spring/Security2/4.png" alt="" />
      </a>
    
  
    
      <a href="/assets/images/post/Spring/Security2/5.png">
          <img src="/assets/images/post/Spring/Security2/5.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="remember-me--remembermeauthenticationfilter">Remember Me &amp; RememberMeAuthenticationFilter</h3>
<ul>
  <li>세션이 만료되고 웹 브라우저가 종료된 후에도 어플리케이션이 사용자를 기억하는 기능</li>
  <li>Remember-Me 쿠키에 대한 Http 요청을 확인한 후 토큰 유효성 검사후 <code class="language-plaintext highlighter-rouge">RememberMeAuthenticationToken</code>를 생성해서 인증 과정을 진행한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span><span class="o">.</span><span class="na">rememberMe</span><span class="o">()</span>
            <span class="o">.</span><span class="na">rememberMeParameter</span><span class="o">(</span><span class="err">“</span><span class="n">remember</span><span class="err">”</span><span class="o">)</span> <span class="c1">// 기본 파라미터명은 remember-me</span>
            <span class="o">.</span><span class="na">tokenValiditySeconds</span><span class="o">(</span><span class="mi">3600</span><span class="o">)</span> <span class="c1">// Default 는 14일</span>
            <span class="o">.</span><span class="na">alwaysRemember</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
            <span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userDetailsService</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>현재 <code class="language-plaintext highlighter-rouge">SecurityContext</code>에 <code class="language-plaintext highlighter-rouge">Authentication</code>이 null이고 http 헤더에 <code class="language-plaintext highlighter-rouge">remember-me</code> 쿠키값이 있을때만 필터를 거친다.</li>
  <li><code class="language-plaintext highlighter-rouge">AuthenticationManager</code>(<code class="language-plaintext highlighter-rouge">ProvideManager</code>)를 통한 인증이 성공하면 <code class="language-plaintext highlighter-rouge">RememberMeAuthenticationToken</code>를 <code class="language-plaintext highlighter-rouge">SecurityContext</code>에 저장한다.</li>
</ul>

<figure class="half ">
  
    
      <a href="/assets/images/post/Spring/Security2/6.png">
          <img src="/assets/images/post/Spring/Security2/6.png" alt="" />
      </a>
    
  
    
      <a href="/assets/images/post/Spring/Security2/7.png">
          <img src="/assets/images/post/Spring/Security2/7.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="anonymousauthenticationfilter">AnonymousAuthenticationFilter</h3>
<ul>
  <li>익명사용자 인증 처리 필터</li>
  <li>익명사용자와 인증 사용자를 구분해서 처리하기 위한 용도로 사용</li>
  <li>화면에서 인증 여부를 구현할 때 <code class="language-plaintext highlighter-rouge">isAnonymous()</code>와 <code class="language-plaintext highlighter-rouge">isAuthenticated()</code>로 구분해서 사용</li>
  <li>인증객체를 세션에 저장하지 않는다.</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/8.png">
          <img src="/assets/images/post/Spring/Security2/8.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="동시-세션-제어--세션고정보호--세션-정책">동시 세션 제어 / 세션고정보호 / 세션 정책</h3>
<h4 id="동시-세션-제어">동시 세션 제어</h4>
<ul>
  <li>최대 세션 허용 개수 초과
    <ul>
      <li>이전 사용자 세션 만료</li>
      <li>현재 사용자 인증 실패</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span><span class="o">.</span><span class="na">sessionManagement</span><span class="o">()</span>
            <span class="o">.</span><span class="na">maximumSessions</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="c1">// 최대 허용 가능 세션 수 , -1 : 무제한 로그인 세션 허용</span>
            <span class="o">.</span><span class="na">maxSessionsPreventsLogin</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="c1">// 동시 로그인 차단함, false : 기존 세션 만료(default)</span>
            <span class="o">.</span><span class="na">invalidSessionUrl</span><span class="o">(</span><span class="s">"/invalid"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">expiredUrl</span><span class="o">(</span><span class="s">"/expired "</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="세션-고정-보호-사용자">세션 고정 보호 사용자</h4>
<ul>
  <li>공격자가 본인의 <code class="language-plaintext highlighter-rouge">JSESSIONID</code>를 사용자 쿠키에 심어넣고 해당 사용자가 공격자의 쿠키로 로그인시에 공격자는 사용자의 정보 공유 가능</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span><span class="o">.</span><span class="na">sessionManagement</span><span class="o">()</span>
            <span class="o">.</span><span class="na">sessionFixation</span><span class="o">()</span>
            <span class="o">.</span><span class="na">changeSessionId</span><span class="o">()</span> <span class="c1">// 기본값 // none, migrateSession, newSession</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="세션-정책">세션 정책</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span><span class="o">.</span><span class="na">sessionManagement</span><span class="o">()</span>
            <span class="o">.</span><span class="na">sessionCreationPolicy</span><span class="o">(</span><span class="nc">SessionCreationPolicy</span><span class="o">.</span><span class="na">If_Required</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">SessionCreationPolicy.Always</code>: 스프링 시큐리티가 항상 세션 생성</li>
  <li><code class="language-plaintext highlighter-rouge">SessionCreationPolicy.If_Required</code>: 스프링 시큐리티가 필요시 생성(기본값)</li>
  <li><code class="language-plaintext highlighter-rouge">SessionCreationPolicy.Never</code>: 스프링 시큐리티가 생성하지 않지만 이미 존재하면 사용</li>
  <li><code class="language-plaintext highlighter-rouge">SessionCreationPolicy.Stateless</code>: 스프링 시큐리티가 생성하지 않고 존재해도 사용하지 않음</li>
</ul>

<h3 id="sessionmanagementfilter--concurrentsessionfilter">SessionManagementFilter &amp; ConcurrentSessionFilter</h3>
<h4 id="sessionmanagementfilter">SessionManagementFilter</h4>
<ol>
  <li>세션 관리: 인증 시 사용자의 세션정보를 등록, 조회, 삭제 등의 세션 이력을 관리한다. <code class="language-plaintext highlighter-rouge">HttpSession</code>이 아니라 <code class="language-plaintext highlighter-rouge">SessionRegistry</code>의 기본 구현체인 <code class="language-plaintext highlighter-rouge">SessionRegistryImpl</code>의 <code class="language-plaintext highlighter-rouge">Map&lt;String, SessionInformation&gt; sessionIds</code>에 JSESSIONID를 키로 하고 <code class="language-plaintext highlighter-rouge">principal</code>를 포함하는 <code class="language-plaintext highlighter-rouge">SessionInformation</code>를 값으로 해서 저장한다.</li>
  <li>동시적 세션 제어: 동일 계정으로 접속이 허용되는 최대 세션수를 제한</li>
  <li>세션 고정 보호: 인증 할 때마다 세션쿠키를 새로 발급하여 공격자의 쿠키 조작을 방지</li>
  <li>세션 생성 정책: Always, If_Required, Never, Stateless</li>
</ol>

<h4 id="concurrentsessionfilter">ConcurrentSessionFilter</h4>
<ul>
  <li>매 요청 마다 현재 사용자의 세션 만료 여부 체크</li>
  <li>세션이 만료로 설정되었을 경우 즉시 로그아웃 처리</li>
  <li><code class="language-plaintext highlighter-rouge">session.isExpired() == true</code>: 로그아웃 처리, 오류 페이지 응답</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/9.png">
          <img src="/assets/images/post/Spring/Security2/9.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="권한-설정-및-표현식">권한 설정 및 표현식</h3>
<ul>
  <li>선언적 방식
    <ul>
      <li>URL: <code class="language-plaintext highlighter-rouge">http.antMatchers("/users/**").hasRole(“USER")</code></li>
      <li>Method: <code class="language-plaintext highlighter-rouge">@PreAuthorize("hasRole(‘USER’)")</code></li>
    </ul>
  </li>
  <li>동적 방식 – DB 연동 프로그래밍
    <ul>
      <li>URL</li>
      <li>Method</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/shop/login"</span><span class="o">,</span> <span class="s">"/shop/users/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">" / shop / mypage"</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">"USER"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/shop/admin/pay"</span><span class="o">).</span><span class="na">access</span><span class="o">(</span><span class="s">"hasRole('ADMIN')"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/shop/admin/**"</span><span class="o">).</span><span class="na">access</span><span class="o">(</span><span class="s">"hasRole('ADMIN') or hasRole('SYS')"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
<span class="o">}</span>
</code></pre></div></div>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/10.png">
          <img src="/assets/images/post/Spring/Security2/10.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="exceptiontranslationfilter--requestcacheawarefilter">ExceptionTranslationFilter &amp; RequestCacheAwareFilter</h3>
<h4 id="exceptiontranslationfilter">ExceptionTranslationFilter</h4>
<ul>
  <li>AuthenticationException
    <ul>
      <li>인증 예외 처리</li>
      <li><code class="language-plaintext highlighter-rouge">AuthenticationEntryPoint</code> 호출: 로그인 페이지 이동, 401 오류 코드 전달 등</li>
      <li>인증 예외가 발생하기 전의 요청 정보를 저장</li>
      <li><code class="language-plaintext highlighter-rouge">RequestCache</code> - 사용자의 이전 요청 정보을 세션에 <strong>저장</strong>하고 이를 <strong>꺼내</strong> 오는 캐시 메카니즘</li>
      <li><code class="language-plaintext highlighter-rouge">SavedRequest</code> - 사용자가 요청했던 request 파라미터 값들, 그 당시의 헤더값들 등이 저장</li>
    </ul>
  </li>
  <li>AccessDeniedException
    <ul>
      <li>인가 예외 처리</li>
      <li><code class="language-plaintext highlighter-rouge">AccessDeniedHandler</code>에서 예외 처리하도록 제공</li>
    </ul>
  </li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/11.png">
          <img src="/assets/images/post/Spring/Security2/11.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>익명 사용자는 <code class="language-plaintext highlighter-rouge">AccessDeniedException</code>이 발생해도 <code class="language-plaintext highlighter-rouge">AuthenticationException</code>으로 처리해서 <code class="language-plaintext highlighter-rouge">AuthenticationEntryPoint</code> 실행</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span><span class="o">.</span><span class="na">exceptionHandling</span><span class="o">()</span>
            <span class="o">.</span><span class="na">authenticationEntryPoint</span><span class="o">(</span><span class="n">authenticationEntryPoint</span><span class="o">())</span>
            <span class="o">.</span><span class="na">accessDeniedHandler</span><span class="o">(</span><span class="n">accessDeniedHandler</span><span class="o">())</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="requestcacheawarefilter">RequestCacheAwareFilter</h4>
<p><code class="language-plaintext highlighter-rouge">HttpSessionRequestCache</code>에서 세션에 저장된 <code class="language-plaintext highlighter-rouge">DefaultSavedRequest</code>를 조회하고 있다면 캐쉬된 URI로 보낸다.</p>

<h2 id="스프링-시큐리티-주요-아키텍처-이해">스프링 시큐리티 주요 아키텍처 이해</h2>
<h3 id="delegatingfilterproxy--filterchainproxy">DelegatingFilterProxy &amp; FilterChainProxy</h3>
<h4 id="delegatingfilterproxy">DelegatingFilterProxy</h4>
<ul>
  <li>서블릿 필터는 스프링에서 정의된 빈을 주입해서 사용할 수 없음</li>
  <li>특정한 이름을 가진 스프링 빈을 찾아 그 빈에게 요청을 위임
    <ul>
      <li><code class="language-plaintext highlighter-rouge">springSecurityFilterChain</code> 이름으로 생성된 빈을 <code class="language-plaintext highlighter-rouge">ApplicationContext</code> 에서 찾아 요청을 위임</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">DelegatingFilterProxy</code>는 서블리과 스프링의 징검다리 역할을 한다고 보면 된다.</li>
</ul>

<h4 id="filterchainproxy">FilterChainProxy</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">springSecurityFilterChain</code>의 이름으로 생성되는 필터 빈</li>
  <li><code class="language-plaintext highlighter-rouge">DelegatingFilterProxy</code>으로 부터 요청을 위임 받고 실제 보안 처리</li>
  <li>스프링 시큐리티 초기화 시 생성되는 필터들을 관리하고 제어
    <ul>
      <li>스프링 시큐리티가 기본적으로 생성하는 필터</li>
      <li>설정 클래스에서 API 추가 시 생성되는 필터</li>
    </ul>
  </li>
  <li>사용자의 요청을 필터 순서대로 호출하여 전달</li>
  <li>사용자정의 필터를 생성해서 기존의 필터 전.후로 추가 가능</li>
  <li>마지막 필터까지 인증 및 인가 예외가 발생하지 않으면 보안 통과</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/12.png">
          <img src="/assets/images/post/Spring/Security2/12.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>spring secuirty 검증을 통과하면 이후 여러가지 서블릿 필터를 거친후 <code class="language-plaintext highlighter-rouge">DispatcherServlet</code>을 통해 <code class="language-plaintext highlighter-rouge">Controller</code>에 매핑된다.</li>
</ul>

<h3 id="필터-초기화와-다중-보안-설정">필터 초기화와 다중 보안 설정</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/13.png">
          <img src="/assets/images/post/Spring/Security2/13.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>설정클래스 별로 보안 기능이 각각 작동</li>
  <li>설정클래스 별로 <code class="language-plaintext highlighter-rouge">RequestMatcher</code> 설정 (<code class="language-plaintext highlighter-rouge">http.antMatcher("/admin/**")</code>)</li>
  <li>설정클래스 별로 필터체인 생성</li>
  <li><code class="language-plaintext highlighter-rouge">FilterChainProxy</code>가 각 필터체인들 가지고 있음</li>
  <li>요청에 따라 <code class="language-plaintext highlighter-rouge">RequestMatcher</code>와 매칭되는 필터가 작동하도록 함</li>
  <li>여러개의 필터체인을 생성하기 위해서는 여러개의 설정 클래스를 작성해야 한다.</li>
</ul>

<h3 id="authentication">Authentication</h3>
<ul>
  <li>사용자의 인증 정보를 저장하는 토큰 개념</li>
  <li>인증 시 id와 password를 담고 인증 검증을 위해 전달되어 사용된다.</li>
  <li>인증 후 최종 인증 결과 (user 객체, 권한정보) 를 담고 <code class="language-plaintext highlighter-rouge">SecurityContext</code>에 저장되어 전역적으로 참조가 가능하다. (<code class="language-plaintext highlighter-rouge">Authentication authentication = SecurityContexHolder.getContext().getAuthentication()</code>)</li>
  <li>구조
    <ul>
      <li><code class="language-plaintext highlighter-rouge">principal</code>: 사용자 아이디 혹은 <code class="language-plaintext highlighter-rouge">User</code> 객체를 저장</li>
      <li><code class="language-plaintext highlighter-rouge">credentials</code>: 사용자 비밀번호</li>
      <li><code class="language-plaintext highlighter-rouge">authorities</code>: 인증된 사용자의 권한 목록</li>
      <li><code class="language-plaintext highlighter-rouge">details</code>: 인증 부가 정보</li>
      <li><code class="language-plaintext highlighter-rouge">Authenticated</code>: 인증 여부</li>
    </ul>
  </li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/14.png">
          <img src="/assets/images/post/Spring/Security2/14.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="securitycontextholder-securitycontext">SecurityContextHolder, SecurityContext</h3>
<h4 id="securitycontext">SecurityContext</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Authentication</code> 객체가 저장되는 보관소로 필요 시 언제든지 <code class="language-plaintext highlighter-rouge">Authentication</code> 객체를 꺼내어 쓸 수 있도록 제공되는 인터페이스</li>
  <li><code class="language-plaintext highlighter-rouge">ThreadLocal</code>에 저장되어 아무 곳에서나 참조가 가능하도록 설계함</li>
  <li>인증이 완료되면 <code class="language-plaintext highlighter-rouge">HttpSession</code>에 저장되어 어플리케이션 전반에 걸쳐 전역적인 참조가 가능하다.</li>
</ul>

<h4 id="securitycontextholder">SecurityContextHolder</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">SecurityContext</code> 객체 저장 방식
    <ul>
      <li><code class="language-plaintext highlighter-rouge">MODE_THREADLOCAL</code> : 스레드당 <code class="language-plaintext highlighter-rouge">SecurityContext</code> 객체를 할당, 기본값</li>
      <li><code class="language-plaintext highlighter-rouge">MODE_INHERITABLETHREADLOCAL</code> : 메인 스레드와 자식 스레드에 관하여 동일한 <code class="language-plaintext highlighter-rouge">SecurityContext</code>를 유지</li>
      <li><code class="language-plaintext highlighter-rouge">MODE_GLOBAL</code>: 응용 프로그램에서 단 하나의 <code class="language-plaintext highlighter-rouge">SecurityContext</code>를 저장한다.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">SecurityContextHolder.clearContext()</code>: <code class="language-plaintext highlighter-rouge">SecurityContext</code> 기존 정보 초기화</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/15.png">
          <img src="/assets/images/post/Spring/Security2/15.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="securitycontextpersistencefilter">SecurityContextPersistenceFilter</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">SecurityContext</code> 객체의 생성, 저장, 조회</li>
  <li>익명 사용자
    <ul>
      <li>새로운 <code class="language-plaintext highlighter-rouge">SecurityContext</code> 객체를 생성하여 <code class="language-plaintext highlighter-rouge">SecurityContextHolder</code>에 저장</li>
      <li><code class="language-plaintext highlighter-rouge">AnonymousAuthenticationFilter</code> 에서 <code class="language-plaintext highlighter-rouge">AnonymousAuthenticationToken</code> 객체를 <code class="language-plaintext highlighter-rouge">SecurityContext</code>에 저장</li>
    </ul>
  </li>
  <li>인증 시
    <ul>
      <li>새로운 <code class="language-plaintext highlighter-rouge">SecurityContext</code> 객체를 생성하여 <code class="language-plaintext highlighter-rouge">SecurityContextHolder</code>에 저장</li>
      <li><code class="language-plaintext highlighter-rouge">UsernamePasswordAuthenticationFilter</code>에서 인증 성공 후 <code class="language-plaintext highlighter-rouge">SecurityContext</code>에 <code class="language-plaintext highlighter-rouge">UsernamePasswordAuthentication</code> 객체를 <code class="language-plaintext highlighter-rouge">SecurityContext</code>에 저장</li>
      <li>인증이 최종 완료되면 <code class="language-plaintext highlighter-rouge">HttpSession</code>에 <code class="language-plaintext highlighter-rouge">SecurityContext</code>를 저장</li>
    </ul>
  </li>
  <li>인증 후
    <ul>
      <li><code class="language-plaintext highlighter-rouge">Session</code>에서 <code class="language-plaintext highlighter-rouge">SecurityContext</code> 꺼내어 <code class="language-plaintext highlighter-rouge">SecurityContextHolder</code>에서 저장</li>
      <li><code class="language-plaintext highlighter-rouge">SecurityContext</code> 안에 <code class="language-plaintext highlighter-rouge">Authentication</code> 객체가 존재하면 계속 인증을 유지한다.</li>
    </ul>
  </li>
  <li>최종 응답시 공통: <code class="language-plaintext highlighter-rouge">SecurityContextHolder.clearContext()</code></li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/16.png">
          <img src="/assets/images/post/Spring/Security2/16.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">HttpSecurityContextRepository</code>는 세션이 존재하면 기존 <code class="language-plaintext highlighter-rouge">SecurityContext</code>를 반환하고 세션이 없다면 새로운 <code class="language-plaintext highlighter-rouge">SecurityContext</code>를 생성해서 반환한다.</li>
  <li><code class="language-plaintext highlighter-rouge">SecurityContextPersistenceFilter</code>는 반환된 <code class="language-plaintext highlighter-rouge">SecurityContext</code>를 <code class="language-plaintext highlighter-rouge">SecurityContextHolder</code>에 담고 그 다음 필터를 호출한다.</li>
  <li>응답시에는 <code class="language-plaintext highlighter-rouge">AnonymousAuthenticationToken</code>이 아니라면 <code class="language-plaintext highlighter-rouge">SecurityContext</code>를 세션에 저장하고 응답한다.</li>
</ul>

<h3 id="authentication-flow">Authentication Flow</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/17.png">
          <img src="/assets/images/post/Spring/Security2/17.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="authenticationmanager">AuthenticationManager</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/18.png">
          <img src="/assets/images/post/Spring/Security2/18.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AuthenticationProvider</code> 목록 중에서 인증 처리 요건에 맞는 <code class="language-plaintext highlighter-rouge">AuthenticationProvider</code>를 찾아 인증 처리를 위임한다.</li>
  <li>부모 <code class="language-plaintext highlighter-rouge">ProviderManager</code>를 설정하여 <code class="language-plaintext highlighter-rouge">AuthenticationProvider</code>를 계속 탐색 할 수 있다.</li>
  <li>스프링 시큐리티 초기화 과정에서 부모 관계를 적절히 커스텀하면 커스텀한 모든 <code class="language-plaintext highlighter-rouge">AuthenticationProvider</code> 탐색이 가능하다.</li>
</ul>

<h3 id="authenticationprovider">AuthenticationProvider</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/19.png">
          <img src="/assets/images/post/Spring/Security2/19.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="authorization-filtersecurityinterceptor">Authorization, FilterSecurityInterceptor</h3>
<h4 id="authorization">Authorization</h4>
<ul>
  <li>스프링 시큐리티가 지원하는 권한 계층
    <ul>
      <li>웹 계층: URL 요청에 따른 메뉴 혹은 화면단위의 레벨 보안</li>
      <li>서비스 계층: 화면 단위가 아닌 메소드 같은 기능 단위의 레벨 보안</li>
      <li>도메인 계층(Access Control List, 접근제어목록): 객체 단위의 레벨 보안</li>
    </ul>
  </li>
</ul>

<h4 id="filtersecurityinterceptor">FilterSecurityInterceptor</h4>
<ul>
  <li>마지막에 위치한 필터로써 인증된 사용자에 대하여 특정 요청의 승인 / 거부 여부를 최종적으로 결정</li>
  <li>인증 객체 없이 보호자원에 접근을 시도할 경우 <code class="language-plaintext highlighter-rouge">AuthenticationException</code>을 발생</li>
  <li>인증후 자원에 접근 가능한 권한이 존재하지 않을 경우 <code class="language-plaintext highlighter-rouge">AccessDeniedException</code>을 발생, 여러번 말하지만 익명 사용자의 경우 <code class="language-plaintext highlighter-rouge">AuthenticationException</code>로 처리하여 <code class="language-plaintext highlighter-rouge">AuthenticationEntryPoint</code> 실행</li>
  <li>권한 제어 방식중 HTTP 자원의 보안을 처리하는 필터</li>
  <li>권한처리를 <code class="language-plaintext highlighter-rouge">AccessDecisionManager</code>에게 맡김</li>
</ul>

<figure class="half ">
  
    
      <a href="/assets/images/post/Spring/Security2/20.png">
          <img src="/assets/images/post/Spring/Security2/20.png" alt="" />
      </a>
    
  
    
      <a href="/assets/images/post/Spring/Security2/21.png">
          <img src="/assets/images/post/Spring/Security2/21.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="accessdecisionmanager-accessdecisionvoter">AccessDecisionManager, AccessDecisionVoter</h3>
<h4 id="accessdecisionmanager">AccessDecisionManager</h4>
<ul>
  <li>인증 정보, 요청정보, 권한정보를 이용해서 사용자의 자원접근을 허용할 것인지 거부할 것인지를 최종 결정하는 주체</li>
  <li>여러 개의 Voter 들을 가질 수있으며 Voter 들로부터 접근허용, 거부, 보류에 해당하는 각각의 값을 리턴받고 판단 및 결정</li>
  <li>최종 접근 거부 시 예외 발생</li>
  <li>접근결정의 세가지 유형
    <ul>
      <li>AffirmativeBased: 여러개의 Voter 클래스 중 하나라도 접근 허가로 결론을 내면 접근 허가로 판단한다.</li>
      <li>ConsensusBased: 다수표(승인 및 거부)에 의해 최종 결정을 판단한다. 동수일경우 기본은 접근허가이나 <code class="language-plaintext highlighter-rouge">allowIfEqualGrantedDeniedDecisions</code>을 <code class="language-plaintext highlighter-rouge">false</code>로 설정할 경우 접근거부로 결정된다.</li>
      <li>UnanimousBased: 모든 Voter가 만장일치로 접근을 승인해야 하며 그렇지 않은 경우 접근을 거부한다.</li>
    </ul>
  </li>
</ul>

<h4 id="accessdecisionvoter">AccessDecisionVoter</h4>
<ul>
  <li>Voter가 권한 부여 과정에서 판단하는 자료
    <ul>
      <li>Authentication - 인증 정보(<code class="language-plaintext highlighter-rouge">user</code>, <code class="language-plaintext highlighter-rouge">anonymous</code>, <code class="language-plaintext highlighter-rouge">admin</code>)</li>
      <li>FilterInvocation – 요청 정보(<code class="language-plaintext highlighter-rouge">antMatcher("/user")</code>)</li>
      <li>ConfigAttributes - 권한 정보 (<code class="language-plaintext highlighter-rouge">hasRole("USER")</code>)</li>
    </ul>
  </li>
  <li>결정 방식
    <ul>
      <li><code class="language-plaintext highlighter-rouge">ACCESS_GRANTED</code>: 접근허용(1)</li>
      <li><code class="language-plaintext highlighter-rouge">ACCESS_DENIED</code>: 접근 거부(-1)</li>
      <li><code class="language-plaintext highlighter-rouge">ACCESS_ABSTAIN</code>: 접근 보류(0)</li>
    </ul>
  </li>
  <li>커스텀한 <code class="language-plaintext highlighter-rouge">AccessDecisionVoter</code> 추가도 가능하다.</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/22.png">
          <img src="/assets/images/post/Spring/Security2/22.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="스프링-시큐리티-필터-및-아키텍처-정리">스프링 시큐리티 필터 및 아키텍처 정리</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/23.png">
          <img src="/assets/images/post/Spring/Security2/23.png" alt="" />
      </a>
    
  
  
</figure>

<h2 id="실전프로젝트--인증-프로세스-form-인증-구현">실전프로젝트 -인증 프로세스 Form 인증 구현</h2>
<h3 id="customauthenticationprovider">CustomAuthenticationProvider</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/24.png">
          <img src="/assets/images/post/Spring/Security2/24.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="로그아웃">로그아웃</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginController</span> <span class="o">{</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/logout"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">logout</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">SecurityContextLogoutHandler</span><span class="o">().</span><span class="na">logout</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">authentication</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="s">"redirect:/login"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>로그아웃 방법
    <ul>
      <li><code class="language-plaintext highlighter-rouge">&lt;form&gt;</code> 태그를 사용해서 POST로 요청</li>
      <li><code class="language-plaintext highlighter-rouge">&lt;a&gt;</code> 태크를 사용해서 GET으로 요청 – <code class="language-plaintext highlighter-rouge">SecurityContextLogoutHandler</code> 활용</li>
    </ul>
  </li>
</ul>

<h3 id="webauthenticationdetails-authenticationdetailssource">WebAuthenticationDetails, AuthenticationDetailsSource</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/25.png">
          <img src="/assets/images/post/Spring/Security2/25.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>WebAuthenticationDetails(클래스)
    <ul>
      <li>인증 과정 중 전달된 데이터를 저장</li>
      <li><code class="language-plaintext highlighter-rouge">Authentication</code>의 <code class="language-plaintext highlighter-rouge">details</code> 속성에 저장</li>
      <li>상속으로 커스텀한 클래스를 만들수 있다. 따라서 기본적으로 갖고 있는 프로퍼티외 파라미터 등 인증 단계에서 필요한 데이터를 추가할 수 있다.</li>
    </ul>
  </li>
  <li>AuthenticationDetailsSource(인터페이스)
    <ul>
      <li><code class="language-plaintext highlighter-rouge">WebAuthenticationDetails</code> 객체를 생성</li>
      <li>인터페이스 구현으로 커스텀한 클래스를 만들 수 있다.</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">AuthenticationDetailsSource</span> <span class="n">authenticationDetailsSource</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">http</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
                <span class="o">.</span><span class="na">formLogin</span><span class="o">()</span>
                <span class="o">.</span><span class="na">loginPage</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">loginProcessingUrl</span><span class="o">(</span><span class="s">"/login_proc"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">authenticationDetailsSource</span><span class="o">(</span><span class="n">authenticationDetailsSource</span><span class="o">)</span>
                <span class="o">.</span><span class="na">defaultSuccessUrl</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="o">...</span>  
<span class="o">}</span>
</code></pre></div></div>

<h3 id="customauthenticationsuccesshandler">CustomAuthenticationSuccessHandler</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAuthenticationHandler</span> <span class="kd">extends</span> <span class="nc">SimpleUrlAuthenticationSuccessHandler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">RequestCache</span> <span class="n">requestCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpSessionRequestCache</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nc">RedirectStrategy</span> <span class="n">redirectStrategy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultRedirectStrategy</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationSuccess</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setDefaultTargetUrl</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
        <span class="nc">SavedRequest</span> <span class="n">savedRequest</span> <span class="o">=</span> <span class="n">requestCache</span><span class="o">.</span><span class="na">getRequest</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">savedRequest</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">targetUrl</span> <span class="o">=</span> <span class="n">savedRequest</span><span class="o">.</span><span class="na">getRedirectUrl</span><span class="o">();</span>
            <span class="n">redirectStrategy</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">targetUrl</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">redirectStrategy</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getDefaultTargetUrl</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span>
            <span class="o">...</span>
            <span class="o">.</span><span class="na">successHandler</span><span class="o">(</span><span class="n">authenticationSuccessHandler</span><span class="o">)</span>
            <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="customauthenticationfailurehandler">CustomAuthenticationFailureHandler</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">UsernamePasswordAuthenticationFilter</code>에서 발생한 <code class="language-plaintext highlighter-rouge">UsernameNotFoundException</code>, <code class="language-plaintext highlighter-rouge">BadCredentialsException</code>과 같은 예외를 처리한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAuthenticationFailureHandler</span> <span class="kd">extends</span> <span class="nc">SimpleUrlAuthenticationFailureHandler</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationFailure</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">AuthenticationException</span> <span class="n">exception</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">errorMessage</span> <span class="o">=</span> <span class="s">"Invalid Username or Password"</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="nc">BadCredentialsException</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">errorMessage</span> <span class="o">=</span> <span class="s">"Invalid Username or Password"</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="nc">InsufficientAuthenticationException</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">errorMessage</span> <span class="o">=</span> <span class="s">"Invalid Secret Key"</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">this</span><span class="o">.</span><span class="na">setDefaultFailureUrl</span><span class="o">(</span><span class="s">"/login?error=true&amp;exception="</span> <span class="o">+</span> <span class="n">errorMessage</span><span class="o">);</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onAuthenticationFailure</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">exception</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span>
            <span class="o">...</span>
            <span class="o">.</span><span class="na">failureHandler</span><span class="o">(</span><span class="n">authenticationFailureHandler</span><span class="o">)</span>
            <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="실전프로젝트---인증-프로세스-ajax-인증-구현">실전프로젝트 - 인증 프로세스 Ajax 인증 구현</h2>
<h3 id="흐름-및-개요">흐름 및 개요</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/26.png">
          <img src="/assets/images/post/Spring/Security2/26.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="ajaxauthenticationfilter">AjaxAuthenticationFilter</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AjaxLoginProcessingFilter</span> <span class="kd">extends</span> <span class="nc">AbstractAuthenticationProcessingFilter</span> <span class="o">{</span> <span class="c1">// config에서 UsernamePasswordAuthenticationFilter 앞에 추가 필요</span>

    <span class="kd">private</span> <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nf">AjaxLoginProcessingFilter</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="k">new</span> <span class="nc">AntPathRequestMatcher</span><span class="o">(</span><span class="s">"/api/login"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Authentication</span> <span class="nf">attemptAuthentication</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isAjax</span><span class="o">(</span><span class="n">request</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Authentication is not supported"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">AccountDto</span> <span class="n">accountDto</span> <span class="o">=</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">readValue</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getReader</span><span class="o">(),</span> <span class="nc">AccountDto</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">accountDto</span><span class="o">.</span><span class="na">getUsername</span><span class="o">())</span> <span class="o">||</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">accountDto</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"username or Password is empty"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">AjaxAuthenticationToken</span> <span class="n">ajaxAuthenticationToken</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AjaxAuthenticationToken</span><span class="o">(</span><span class="n">accountDto</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">accountDto</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">getAuthenticationManager</span><span class="o">().</span><span class="na">authenticate</span><span class="o">(</span><span class="n">ajaxAuthenticationToken</span><span class="o">);</span> <span class="c1">// config에서 AuthenticationManager 설정 필요</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isAjax</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="s">"XMLHttpRequest"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"X-Requested-With"</span><span class="o">)))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AjaxAuthenticationToken</span> <span class="kd">extends</span> <span class="nc">AbstractAuthenticationToken</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="nc">SpringSecurityCoreVersion</span><span class="o">.</span><span class="na">SERIAL_VERSION_UID</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">principal</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">Object</span> <span class="n">credentials</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AjaxAuthenticationToken</span><span class="o">(</span><span class="nc">Object</span> <span class="n">principal</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">credentials</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">principal</span> <span class="o">=</span> <span class="n">principal</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">credentials</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">;</span>
        <span class="n">setAuthenticated</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">AjaxAuthenticationToken</span><span class="o">(</span><span class="nc">Object</span> <span class="n">principal</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">credentials</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">authorities</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">principal</span> <span class="o">=</span> <span class="n">principal</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">credentials</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">;</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">setAuthenticated</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span> <span class="c1">// must use super, as we override</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getCredentials</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">credentials</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getPrincipal</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">principal</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAuthenticated</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">isAuthenticated</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IllegalArgumentException</span> <span class="o">{</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(!</span><span class="n">isAuthenticated</span><span class="o">,</span>
                <span class="s">"Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead"</span><span class="o">);</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">setAuthenticated</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eraseCredentials</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">eraseCredentials</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">credentials</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>기존 <code class="language-plaintext highlighter-rouge">SecurityConfig</code>와 다른 새로운 <code class="language-plaintext highlighter-rouge">AjaxSecurityConfig</code> 클래스를 생성하고 적절히 오버라이딩한다. 그러면 필터체인이 2개가 생성되고 각 config에서 설정한 <code class="language-plaintext highlighter-rouge">mvcMatcher()</code>에 따라 체인이 선택된다.</li>
</ul>

<h3 id="ajaxauthenticationprovider">AjaxAuthenticationProvider</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AjaxAuthenticationProvider</span> <span class="kd">implements</span> <span class="nc">AuthenticationProvider</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">UserDetailsService</span> <span class="n">userDetailsService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="nc">Authentication</span> <span class="nf">authenticate</span><span class="o">(</span><span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getCredentials</span><span class="o">();</span>

        <span class="nc">AccountContext</span> <span class="n">accountContext</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AccountContext</span><span class="o">)</span> <span class="n">userDetailsService</span><span class="o">.</span><span class="na">loadUserByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">password</span><span class="o">,</span> <span class="n">accountContext</span><span class="o">.</span><span class="na">getAccount</span><span class="o">().</span><span class="na">getPassword</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BadCredentialsException</span><span class="o">(</span><span class="s">"BadCredentialsException"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">FormWebAuthenticationDetails</span> <span class="n">details</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FormWebAuthenticationDetails</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getDetails</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">secretKey</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="na">getSecretKey</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">secretKey</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">secretKey</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"secret"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InsufficientAuthenticationException</span><span class="o">(</span><span class="s">"InsufficientAuthenticationException"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">AjaxAuthenticationToken</span><span class="o">(</span><span class="n">accountContext</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">accountContext</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">AjaxAuthenticationToken</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">auth</span><span class="o">.</span><span class="na">authenticationProvider</span><span class="o">(</span><span class="n">ajaxAuthenticationProvider</span><span class="o">());</span>
<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">AuthenticationProvider</span> <span class="nf">ajaxAuthenticationProvider</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">AjaxAuthenticationProvider</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="ajaxauthenticationsuccesshandler-ajaxauthenticationfailurehandler">AjaxAuthenticationSuccessHandler, AjaxAuthenticationFailureHandler</h3>
<h4 id="ajaxauthenticationsuccesshandler">AjaxAuthenticationSuccessHandler</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AjaxAuthenticationSuccessHandler</span> <span class="kd">implements</span> <span class="nc">AuthenticationSuccessHandler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationSuccess</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">AccountContext</span> <span class="n">principal</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AccountContext</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_OK</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON_VALUE</span><span class="o">);</span>

        <span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValue</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">(),</span> <span class="n">principal</span><span class="o">.</span><span class="na">getAccount</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="ajaxauthenticationfailurehandler">AjaxAuthenticationFailureHandler</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AjaxAuthenticationFailureHandler</span> <span class="kd">implements</span> <span class="nc">AuthenticationFailureHandler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationFailure</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">AuthenticationException</span> <span class="n">exception</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">errorMsg</span> <span class="o">=</span> <span class="s">"Invalid Username or Password"</span><span class="o">;</span>

        <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_UNAUTHORIZED</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON_VALUE</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="nc">BadCredentialsException</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">errorMsg</span> <span class="o">=</span> <span class="s">"Invalid Username or Password"</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="nc">InsufficientAuthenticationException</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">errorMsg</span> <span class="o">=</span> <span class="s">"Invalid Secret Key"</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValue</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">(),</span> <span class="n">errorMsg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">AjaxLoginProcessingFilter</span> <span class="nf">ajaxLoginProcessingFilter</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">AjaxLoginProcessingFilter</span> <span class="n">ajaxLoginProcessingFilter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AjaxLoginProcessingFilter</span><span class="o">();</span>
    <span class="n">ajaxLoginProcessingFilter</span><span class="o">.</span><span class="na">setAuthenticationManager</span><span class="o">(</span><span class="n">authenticationManagerBean</span><span class="o">());</span>
    <span class="n">ajaxLoginProcessingFilter</span><span class="o">.</span><span class="na">setAuthenticationSuccessHandler</span><span class="o">(</span><span class="n">authenticationSuccessHandler</span><span class="o">());</span>
    <span class="n">ajaxLoginProcessingFilter</span><span class="o">.</span><span class="na">setAuthenticationFailureHandler</span><span class="o">(</span><span class="n">authenticationFailureHandler</span><span class="o">());</span>

    <span class="k">return</span> <span class="n">ajaxLoginProcessingFilter</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="ajaxloginurlauthenticationentrypoint-ajaxaccessdeniedhandler">AjaxLoginUrlAuthenticationEntryPoint, AjaxAccessDeniedHandler</h3>
<h4 id="ajaxloginurlauthenticationentrypoint">AjaxLoginUrlAuthenticationEntryPoint</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AjaxLoginAuthenticationEntryPoint</span> <span class="kd">implements</span> <span class="nc">AuthenticationEntryPoint</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commence</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">AuthenticationException</span> <span class="n">authException</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="n">response</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_UNAUTHORIZED</span><span class="o">,</span> <span class="s">"UnAuthorized"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="ajaxaccessdeniedhandler">AjaxAccessDeniedHandler</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AjaxAccessDeniedHandler</span> <span class="kd">implements</span> <span class="nc">AccessDeniedHandler</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">AccessDeniedException</span> <span class="n">accessDeniedException</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="n">response</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_FORBIDDEN</span><span class="o">,</span> <span class="s">"Access is denied"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="실전프로젝트---인가-프로세스-db-연동-웹-계층-구현">실전프로젝트 - 인가 프로세스 DB 연동 웹 계층 구현</h2>
<h3 id="개요">개요</h3>
<ul>
  <li>DB와 연동하여 자원 및 권한을 설정하고 제어함으로 동적 권한 관리가 가능하도록 한다.</li>
  <li>설정 클래스 소스에서 권한 관련 코드 모두 제거 ex)<code class="language-plaintext highlighter-rouge">antMatcher(“/user”).hasRole(“USER")</code></li>
  <li>관리자 시스템 구축
    <ul>
      <li>회원 관리 – 권한 부여</li>
      <li>권한 관리 – 권한 생성, 삭제</li>
      <li>자원 관리 – 자원 생성, 삭제, 수정, 권한매핑</li>
    </ul>
  </li>
  <li>권한 계층 구현
    <ul>
      <li>URL – Url 요청 시 인가 처리</li>
      <li>Method – 메소드 호출 시 인가 처리
        <ul>
          <li>Method</li>
          <li>Pointcut</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="url-방식---주요-아키텍처-이해">Url 방식 - 주요 아키텍처 이해</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">http.antMatchers(“/user”).access(“hasRole(‘USER’)”)</code></li>
  <li>사용자(인증 정보)가 <code class="language-plaintext highlighter-rouge">/user</code>(요청 정보) 자원에 접근하기 위해서는 <code class="language-plaintext highlighter-rouge">ROLE_USER</code>(권한 정보) 권한이 필요하다</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/27.png">
          <img src="/assets/images/post/Spring/Security2/27.png" alt="" />
      </a>
    
  
  
</figure>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/28.png">
          <img src="/assets/images/post/Spring/Security2/28.png" alt="" />
      </a>
    
  
  
</figure>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/29.png">
          <img src="/assets/images/post/Spring/Security2/29.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="filterinvocationsecuritymetadatasource">FilterInvocationSecurityMetadataSource</h3>
<ul>
  <li>사용자가 접근하고자 하는 Url 자원에 대한 권한 정보 추출</li>
  <li><code class="language-plaintext highlighter-rouge">AccessDecisionManager</code>에게 전달하여 인가처리 수행</li>
  <li>DB로부터 자원 및 권한정보를 매핑하여 맵으로 관리</li>
  <li>사용자의 매 요청마다 요청정보에 매핑된 권한 정보 확인</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/30.png">
          <img src="/assets/images/post/Spring/Security2/30.png" alt="" />
      </a>
    
  
  
</figure>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UrlFilterInvocationSecurityMetadataSource</span> <span class="kd">implements</span> <span class="nc">FilterInvocationSecurityMetadataSource</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;</span><span class="nc">RequestMatcher</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;&gt;</span> <span class="n">requestMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;</span> <span class="nf">getAttributes</span><span class="o">(</span><span class="nc">Object</span> <span class="n">object</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IllegalArgumentException</span> <span class="o">{</span>
        <span class="nc">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">((</span><span class="nc">FilterInvocation</span><span class="o">)</span> <span class="n">object</span><span class="o">).</span><span class="na">getRequest</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">requestMap</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">RequestMatcher</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">requestMap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">RequestMatcher</span> <span class="n">matcher</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">matcher</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">request</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// null을 반환하면 인가처리를 하지 않는다.</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;</span> <span class="nf">getAllConfigAttributes</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;</span> <span class="n">allAttributes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">requestMap</span><span class="o">.</span><span class="na">values</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="nl">allAttributes:</span><span class="o">:</span><span class="n">addAll</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">allAttributes</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">FilterInvocation</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSecurity</span>
<span class="nd">@Order</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">AuthenticationManager</span> <span class="nf">authenticationManagerBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">authenticationManagerBean</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">FilterSecurityInterceptor</span> <span class="nf">customFilterSecurityInterceptor</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">FilterSecurityInterceptor</span> <span class="n">filterSecurityInterceptor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FilterSecurityInterceptor</span><span class="o">();</span>
        <span class="n">filterSecurityInterceptor</span><span class="o">.</span><span class="na">setSecurityMetadataSource</span><span class="o">(</span><span class="n">urlFilterInvocationSecurityMetadataSource</span><span class="o">());</span>
        <span class="n">filterSecurityInterceptor</span><span class="o">.</span><span class="na">setAccessDecisionManager</span><span class="o">(</span><span class="n">affirmativeBased</span><span class="o">());</span>
        <span class="n">filterSecurityInterceptor</span><span class="o">.</span><span class="na">setAuthenticationManager</span><span class="o">(</span><span class="n">authenticationManagerBean</span><span class="o">());</span>

        <span class="k">return</span> <span class="n">filterSecurityInterceptor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">FilterInvocationSecurityMetadataSource</span> <span class="nf">urlFilterInvocationSecurityMetadataSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">UrlFilterInvocationSecurityMetadataSource</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">AccessDecisionManager</span> <span class="nf">affirmativeBased</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">AffirmativeBased</span> <span class="n">affirmativeBased</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AffirmativeBased</span><span class="o">(</span><span class="n">getAccessDecisionVoters</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">affirmativeBased</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">AccessDecisionVoter</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">getAccessDecisionVoters</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="k">new</span> <span class="nc">RoleVoter</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="o">...</span>

        <span class="n">http</span>
                <span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">customFilterSecurityInterceptor</span><span class="o">(),</span> <span class="nc">FilterSecurityInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>기존에 등록된 <code class="language-plaintext highlighter-rouge">FilterSecurityInterceptor</code>의 경우 커스텀한 <code class="language-plaintext highlighter-rouge">FilterSecurityInterceptor</code>에서 인가처리를 하게 되면 인가처리를 진행하지 않고 그 다음 필터로 넘기게 된다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">FilterInvocation</span> <span class="n">filterInvocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isApplied</span><span class="o">(</span><span class="n">filterInvocation</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">observeOncePerRequest</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// filter already applied to this request and user wants us to observe</span>
        <span class="c1">// once-per-request handling, so don't re-do security checking</span>
        <span class="n">filterInvocation</span><span class="o">.</span><span class="na">getChain</span><span class="o">().</span><span class="na">doFilter</span><span class="o">(</span><span class="n">filterInvocation</span><span class="o">.</span><span class="na">getRequest</span><span class="o">(),</span> <span class="n">filterInvocation</span><span class="o">.</span><span class="na">getResponse</span><span class="o">());</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// first time this request being called, so perform security checking</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">filterInvocation</span><span class="o">.</span><span class="na">getRequest</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">observeOncePerRequest</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">filterInvocation</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">setAttribute</span><span class="o">(</span><span class="no">FILTER_APPLIED</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">InterceptorStatusToken</span> <span class="n">token</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">beforeInvocation</span><span class="o">(</span><span class="n">filterInvocation</span><span class="o">);</span> <span class="c1">// 인가 로직</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">filterInvocation</span><span class="o">.</span><span class="na">getChain</span><span class="o">().</span><span class="na">doFilter</span><span class="o">(</span><span class="n">filterInvocation</span><span class="o">.</span><span class="na">getRequest</span><span class="o">(),</span> <span class="n">filterInvocation</span><span class="o">.</span><span class="na">getResponse</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">finally</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">finallyInvocation</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">afterInvocation</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="map-기반-db-연동">Map 기반 DB 연동</h3>
<p>DB와 연동하여 <code class="language-plaintext highlighter-rouge">LinkedHashMap&lt;RequestMatcher, List&lt;ConfigAttribute&gt;&gt; resourceMap</code>를 생성하는 <code class="language-plaintext highlighter-rouge">service</code>를 만든다. 해당 서비스를 이용하여 <code class="language-plaintext highlighter-rouge">resourceMap</code>를 빈으로 생성하는 <code class="language-plaintext highlighter-rouge">FactoryBean</code> 구현체를 생성하고 <code class="language-plaintext highlighter-rouge">UrlFilterInvocationSecurityMetadataSource</code> 생성시에 <code class="language-plaintext highlighter-rouge">resourceMap</code>를 주입한다. <code class="language-plaintext highlighter-rouge">FilterSecurityInterceptor</code>에 해당 <code class="language-plaintext highlighter-rouge">UrlFilterInvocationSecurityMetadataSource</code>을 주입하고 <code class="language-plaintext highlighter-rouge">FilterSecurityInterceptor</code> 필터를 기존 <code class="language-plaintext highlighter-rouge">FilterSecurityInterceptor</code> 필터 앞에 추가하면 된다. 여기서 핵심은 Resources와 Role 테이블을 설계하고 조인으로 원하는 결과를 가져오는 것이다. rquest pattern과 mvaPattern이 매칭되는 순서가 중요하므로 order 프로퍼티를 정해 정렬하여 데이터를 가져오고 기본 <code class="language-plaintext highlighter-rouge">HashMap</code>이 아닌 순서가 보장되는 <code class="language-plaintext highlighter-rouge">LinkedHashMap</code>을 사용한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UrlResourcesMapFactoryBean</span> <span class="kd">implements</span> <span class="nc">FactoryBean</span><span class="o">&lt;</span><span class="nc">LinkedHashMap</span><span class="o">&lt;</span><span class="nc">RequestMatcher</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;&gt;&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">SecurityResourceService</span> <span class="n">securityResourceService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;</span><span class="nc">RequestMatcher</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;&gt;</span> <span class="n">resourceMap</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSecurityResourceService</span><span class="o">(</span><span class="nc">SecurityResourceService</span> <span class="n">securityResourceService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">securityResourceService</span> <span class="o">=</span> <span class="n">securityResourceService</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;</span><span class="nc">RequestMatcher</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;&gt;</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">resourceMap</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">init</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">resourceMap</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">resourceMap</span> <span class="o">=</span> <span class="n">securityResourceService</span><span class="o">.</span><span class="na">getResourceList</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">LinkedHashMap</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="인가처리-실시간-반영하기">인가처리 실시간 반영하기</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UrlFilterInvocationSecurityMetadataSource</span> <span class="kd">implements</span> <span class="nc">FilterInvocationSecurityMetadataSource</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;</span><span class="nc">RequestMatcher</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;&gt;</span> <span class="n">requestMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span>

    <span class="o">...</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reload</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// controller와 매핑하여 trigger 가능</span>
        <span class="nc">LinkedHashMap</span><span class="o">&lt;</span><span class="nc">RequestMatcher</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;&gt;</span> <span class="n">reloadedMap</span> <span class="o">=</span> <span class="n">securityResourceService</span><span class="o">.</span><span class="na">getResourceList</span><span class="o">();</span>
        <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">RequestMatcher</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;&gt;&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">reloadedMap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>

        <span class="n">requestMap</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">RequestMatcher</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;&gt;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="n">reloadedMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="permitallfilter-구현">PermitAllFilter 구현</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/31.png">
          <img src="/assets/images/post/Spring/Security2/31.png" alt="" />
      </a>
    
  
  
</figure>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PermitAllFilter</span> <span class="kd">extends</span> <span class="nc">FilterSecurityInterceptor</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">FILTER_APPLIED</span> <span class="o">=</span> <span class="s">"__spring_security_filterSecurityInterceptor_filterApplied"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">observeOncePerRequest</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">RequestMatcher</span><span class="o">&gt;</span> <span class="n">permitAllRequestMatchers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="nf">PermitAllFilter</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">permitAllResources</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">permitAllResource</span> <span class="o">:</span> <span class="n">permitAllResources</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">permitAllRequestMatchers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">AntPathRequestMatcher</span><span class="o">(</span><span class="n">permitAllResource</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isApplied</span><span class="o">(</span><span class="nc">FilterInvocation</span> <span class="n">filterInvocation</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">filterInvocation</span><span class="o">.</span><span class="na">getRequest</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">filterInvocation</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="no">FILTER_APPLIED</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">InterceptorStatusToken</span> <span class="nf">beforeInvocation</span><span class="o">(</span><span class="nc">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">permitAll</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="nc">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">((</span><span class="nc">FilterInvocation</span><span class="o">)</span> <span class="n">object</span><span class="o">).</span><span class="na">getRequest</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">RequestMatcher</span> <span class="n">requestMatcher</span> <span class="o">:</span> <span class="n">permitAllRequestMatchers</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">requestMatcher</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">request</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">permitAll</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">permitAll</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">beforeInvocation</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">FilterInvocation</span> <span class="n">filterInvocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isApplied</span><span class="o">(</span><span class="n">filterInvocation</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">observeOncePerRequest</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// filter already applied to this request and user wants us to observe</span>
            <span class="c1">// once-per-request handling, so don't re-do security checking</span>
            <span class="n">filterInvocation</span><span class="o">.</span><span class="na">getChain</span><span class="o">().</span><span class="na">doFilter</span><span class="o">(</span><span class="n">filterInvocation</span><span class="o">.</span><span class="na">getRequest</span><span class="o">(),</span> <span class="n">filterInvocation</span><span class="o">.</span><span class="na">getResponse</span><span class="o">());</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// first time this request being called, so perform security checking</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">filterInvocation</span><span class="o">.</span><span class="na">getRequest</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">observeOncePerRequest</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">filterInvocation</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">setAttribute</span><span class="o">(</span><span class="no">FILTER_APPLIED</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">InterceptorStatusToken</span> <span class="n">token</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">beforeInvocation</span><span class="o">(</span><span class="n">filterInvocation</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">filterInvocation</span><span class="o">.</span><span class="na">getChain</span><span class="o">().</span><span class="na">doFilter</span><span class="o">(</span><span class="n">filterInvocation</span><span class="o">.</span><span class="na">getRequest</span><span class="o">(),</span> <span class="n">filterInvocation</span><span class="o">.</span><span class="na">getResponse</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">finally</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">finallyInvocation</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">afterInvocation</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>permiAll 리소스의 경우 불필요한 로직을 타는것을 방지하기 위해 <code class="language-plaintext highlighter-rouge">permitAllRequestMatchers</code>에 매칭된다면 인가 로직을 태우지 않고 <code class="language-plaintext highlighter-rouge">null</code>을 반환하고 그 다음 필터를 호출하게 된다. 물론 그 다음 필터는 <code class="language-plaintext highlighter-rouge">FilterSecurityInterceptor</code>인데 이 역시 전에서 말한대로 한번 이미 필터를 거쳤으므로 로직을 태우지 않고 바로 다음 필터를 호출한다.</li>
</ul>

<h3 id="계층-권한-적용하기">계층 권한 적용하기</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/32.png">
          <img src="/assets/images/post/Spring/Security2/32.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>RoleHierarchy
    <ul>
      <li>상위 계층 Role은 하위 계층 Role의 자원에 접근 가능함</li>
      <li><code class="language-plaintext highlighter-rouge">ROLE_ADMIN &gt; ROLE_MANAGER &gt; ROLE_USER</code> 일 경우 <code class="language-plaintext highlighter-rouge">ROLE_ADMIN</code>만 있으면 하위 ROLE의 권한을 모두 포함한다.</li>
    </ul>
  </li>
  <li>RoleHierarchyVoter
    <ul>
      <li>RoleHierarchy를 생성자로 받으며 이 클래스에서 설정한 규칙이 적용되어 심사함</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSecurity</span>
<span class="nd">@Order</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">FilterSecurityInterceptor</span> <span class="nf">customFilterSecurityInterceptor</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">FilterSecurityInterceptor</span> <span class="n">filterSecurityInterceptor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FilterSecurityInterceptor</span><span class="o">();</span>
        <span class="n">filterSecurityInterceptor</span><span class="o">.</span><span class="na">setSecurityMetadataSource</span><span class="o">(</span><span class="n">urlFilterInvocationSecurityMetadataSource</span><span class="o">());</span>
        <span class="n">filterSecurityInterceptor</span><span class="o">.</span><span class="na">setAccessDecisionManager</span><span class="o">(</span><span class="n">affirmativeBased</span><span class="o">());</span>
        <span class="n">filterSecurityInterceptor</span><span class="o">.</span><span class="na">setAuthenticationManager</span><span class="o">(</span><span class="n">authenticationManagerBean</span><span class="o">());</span>

        <span class="k">return</span> <span class="n">filterSecurityInterceptor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">AccessDecisionManager</span> <span class="nf">affirmativeBased</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">AffirmativeBased</span> <span class="n">affirmativeBased</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AffirmativeBased</span><span class="o">(</span><span class="n">getAccessDecisionVoters</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">affirmativeBased</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">AccessDecisionVoter</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">getAccessDecisionVoters</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">AccessDecisionVoter</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">accessDecisionVoters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="n">accessDecisionVoters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">roleVoter</span><span class="o">());</span>

        <span class="k">return</span> <span class="n">accessDecisionVoters</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">AccessDecisionVoter</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">roleVoter</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">RoleHierarchyVoter</span> <span class="n">roleHierarchyVoter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RoleHierarchyVoter</span><span class="o">(</span><span class="n">roleHierarchy</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">roleHierarchyVoter</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">RoleHierarchyImpl</span> <span class="nf">roleHierarchy</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">RoleHierarchyImpl</span> <span class="n">roleHierarchy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RoleHierarchyImpl</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">roleHierarchy</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityInitializer</span> <span class="kd">implements</span> <span class="nc">ApplicationRunner</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">RoleHierarchyImpl</span> <span class="n">roleHierarchy</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">RoleHierarchyService</span> <span class="n">roleHierarchyService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="nc">ApplicationArguments</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">allHierarchy</span> <span class="o">=</span> <span class="n">roleHierarchyService</span><span class="o">.</span><span class="na">findAllHierarchy</span><span class="o">();</span>
        <span class="n">roleHierarchy</span><span class="o">.</span><span class="na">setHierarchy</span><span class="o">(</span><span class="n">allHierarchy</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">RoleHierarchyVoter</code>를 추가하는 것 외에 기존 <code class="language-plaintext highlighter-rouge">WebExpressionVoter</code>에 위계를 이해할 수 있는 <code class="language-plaintext highlighter-rouge">handler</code>를 커스터마이징 해도 된다.</li>
</ul>

<h3 id="아이피-접속-제한하기">아이피 접속 제한하기</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/33.png">
          <img src="/assets/images/post/Spring/Security2/33.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>특정한 IP만 접근이 가능하도록 심의하는 Voter 추가</li>
  <li>Voter 중에서 가장 먼저 심사하도록 하여 허용된 IP일 경우에만 최종 승인 및 거부 결정을 하도록 한다.</li>
  <li>허용된 IP면 <code class="language-plaintext highlighter-rouge">ACCESS_GRANTED</code>가 아닌 <code class="language-plaintext highlighter-rouge">ACCESS_ABSTAIN</code>을 리턴해서 추가 심의를 계속 진행하도록 한다.</li>
  <li>허용된 IP가 아니면 <code class="language-plaintext highlighter-rouge">ACCESS_DENIED</code>를 리턴하지 않고 즉시 예외 발생하여 최종 자원 접근 거부</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">IpAddressVoter</span> <span class="kd">implements</span> <span class="nc">AccessDecisionVoter</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">SecurityResourceService</span> <span class="n">securityResourceService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">IpAddressVoter</span><span class="o">(</span><span class="nc">SecurityResourceService</span> <span class="n">securityResourceService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">securityResourceService</span> <span class="o">=</span> <span class="n">securityResourceService</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">ConfigAttribute</span> <span class="n">attribute</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">Class</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">vote</span><span class="o">(</span><span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">object</span><span class="o">,</span> <span class="nc">Collection</span> <span class="n">collection</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">WebAuthenticationDetails</span> <span class="n">details</span> <span class="o">=</span> <span class="o">(</span><span class="nc">WebAuthenticationDetails</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getDetails</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">remoteAddress</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">accessIpList</span> <span class="o">=</span> <span class="n">securityResourceService</span><span class="o">.</span><span class="na">getAccessIpList</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">ipAddress</span> <span class="o">:</span> <span class="n">accessIpList</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">remoteAddress</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ipAddress</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="no">ACCESS_ABSTAIN</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nf">AccessDeniedException</span><span class="o">(</span><span class="s">"Invalid IpAddress"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>DB에서 허용되는 IP 목록을 가져오고 매칭시켜 본다.</li>
</ul>

<h3 id="여러-종류의-voter">여러 종류의 voter</h3>
<p><code class="language-plaintext highlighter-rouge">AccessDecisionVoter</code> 구현체는 다양하다. 기본적으로 사용되는 <code class="language-plaintext highlighter-rouge">WebExpressionVoter</code> 뿐만 아니라 <code class="language-plaintext highlighter-rouge">RoleVoter</code>, <code class="language-plaintext highlighter-rouge">RoleHierarchyVoter</code> 등 종류가 다양하다. 각 voter에서 지원하는 <code class="language-plaintext highlighter-rouge">ConfigAttribute</code> 구현체의 종류가 다르며 voter안에서 권한 검증 로직 또한 다르다. 따라서 user에 저장된 <code class="language-plaintext highlighter-rouge">authorities</code>와 <code class="language-plaintext highlighter-rouge">ConfigAttribute</code> 등을 종합적으로 고려하여 voter를 커스터마이징 해야한다.</p>

<h2 id="실전프로젝트---인가-프로세스-db-연동-서비스-계층-구현">실전프로젝트 - 인가 프로세스 DB 연동 서비스 계층 구현</h2>
<h3 id="개요-1">개요</h3>
<ul>
  <li>서비스 계층의 인가처리 방식
    <ul>
      <li>화면, 메뉴 단위가 아닌 기능 단위로 인가처리</li>
      <li>메소드 처리 전.후로 보안 검사 수행하여 인가처리</li>
    </ul>
  </li>
  <li>AOP 기반으로 동작
    <ul>
      <li>프록시와 어드바이스로 메소드 인가처리 수행</li>
    </ul>
  </li>
  <li>보안 설정 방식
    <ul>
      <li>어노테이션 권한 설정 방식
        <ul>
          <li><code class="language-plaintext highlighter-rouge">@PreAuthorize(“hasRole(‘USER’)”), @PostAuthorize(“hasRole(‘USER’)”), @Secured(“ROLE_USER”)</code></li>
        </ul>
      </li>
      <li>맵 기반 권한 설정 방식
        <ul>
          <li>맵 기반 방식으로 외부와 연동하여 메소드 보안 설정 구현</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="어노테이션-권한-설정">어노테이션 권한 설정</h3>
<ul>
  <li>보안이 필요한 메소드에 설정한다.</li>
  <li>@PreAuthorize, @PostAuthorize
    <ul>
      <li>SpEL 지원</li>
      <li><code class="language-plaintext highlighter-rouge">@PreAuthorize("hasRole('ROLE_USER’) and (#account.username == principal.username)")</code></li>
      <li>PrePostAnnotationSecurityMetadataSource가 담당</li>
    </ul>
  </li>
  <li>@Secured, @RolesAllowed
    <ul>
      <li>SpEL 미지원</li>
      <li><code class="language-plaintext highlighter-rouge">@Secured ("ROLE_USER")</code>, <code class="language-plaintext highlighter-rouge">@RolesAllowed("ROLE_USER")</code></li>
      <li>SecuredAnnotationSecurityMetadataSource, Jsr250MethodSecurityMetadataSource가 담당</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)</code></li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/34.png">
          <img src="/assets/images/post/Spring/Security2/34.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">GlobalMethodSecurityConfiguration</code>에서 <code class="language-plaintext highlighter-rouge">@EnableGlobalMethodSecurity</code> 설정을 기반으로 <code class="language-plaintext highlighter-rouge">PrePostAnnotationSecurityMetadataSource</code> 등으로 이루어진 list를 담은 <code class="language-plaintext highlighter-rouge">DelegatingMethodSecurityMetadataSource</code>를 반환한다. <code class="language-plaintext highlighter-rouge">MethodSecurityInterceptor</code>에서는 <code class="language-plaintext highlighter-rouge">DelegatingMethodSecurityMetadataSource</code>를 이용하여 인가 로직을 태운 다음 실제 호출된 메소드를 호출한다. 즉 <code class="language-plaintext highlighter-rouge">MethodInterceptor</code>는 <code class="language-plaintext highlighter-rouge">MethodInterceptor</code>를 구현하고 있다. <code class="language-plaintext highlighter-rouge">DelegatingMethodSecurityMetadataSource</code>에서는 <code class="language-plaintext highlighter-rouge">List&lt;MethodSecurityMetadataSource&gt; methodSecurityMetadataSources</code>를 돌아가면서 <code class="language-plaintext highlighter-rouge">method</code>와 <code class="language-plaintext highlighter-rouge">targetClass</code>의 정보를 이용하여 <code class="language-plaintext highlighter-rouge">Collection&lt;ConfigAttribute&gt; attributes</code>를 반환한다.(캐시용 맵이 존재한다.)</li>
</ul>

<h3 id="주요-아키텍처">주요 아키텍처</h3>
<ul>
  <li>인가 처리를 위한 초기화 과정과 진행
    <ul>
      <li>초기화 과정
        <ul>
          <li>초기화 시 전체 빈을 검사하면서 보안이 설정된 메소드가 있는지 탐색</li>
          <li>빈의 프록시 객체를 생성</li>
          <li>보안 메소드에 인가처리(권한심사) 기능을 하는 Advice를 등록</li>
          <li>빈 참조시 실제 빈이 아닌 프록시 빈 객체를 참조</li>
        </ul>
      </li>
      <li>진행과정
        <ul>
          <li>메소드 호출 시 프록시 객체를 통해 메소드를 호출</li>
          <li>Advice가 등록되어 있다면 Advice를 작동하게 하여 인가 처리</li>
          <li>권한 심사 통과하면 실제 빈의 메소드를 호출한다.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/35.png">
          <img src="/assets/images/post/Spring/Security2/35.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>정리하면 다음과 같다. 스프링은 Advisor를 등록하고 컨테이너에 등록되는 빈을 pointcut를 이용하여 검사한다. pointcut에 해당되면 프록시 객체를 생성하고 프록시를 빈으로 등록하게 된다. <code class="language-plaintext highlighter-rouge">MethodSecurityMetadataSourcePointcut</code>은 <code class="language-plaintext highlighter-rouge">method</code>와 <code class="language-plaintext highlighter-rouge">targetClass</code>의 정보를 이용하여 애노테이션이 붙었는지 여부를 검사함으로써 매칭 여부를 검사한다. 매칭이 되면 Advice(<code class="language-plaintext highlighter-rouge">MethodSecurityInterceptor</code>)를 적용한 프록시 객체를 생성하고 빈으로 등록한다. 프록시 참조가 호출되면 먼저 Advice가 적용된 메소드인지 판단한다. 적용되어 있다면 호출된 method 정보와 함께 <code class="language-plaintext highlighter-rouge">MethodSecurityInterceptor</code>를 호출한다. <code class="language-plaintext highlighter-rouge">MethodSecurityInterceptor</code>에서는 <code class="language-plaintext highlighter-rouge">pointcut</code>과 유사하게 <code class="language-plaintext highlighter-rouge">method</code>와 <code class="language-plaintext highlighter-rouge">targetClass</code>의 정보를 이용하여 <code class="language-plaintext highlighter-rouge">Collection&lt;ConfigAttribute&gt; attributes</code>를 가져오고 인가 로직을 태운다. 이후 예외가 발생하거나 그렇지 않다면 실체 호출된 메소드가 호출된다.</li>
</ul>

<h3 id="map-기반-db-연동-1">Map 기반 DB 연동 (1)</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/36.png">
          <img src="/assets/images/post/Spring/Security2/36.png" alt="" />
      </a>
    
  
  
</figure>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MethodSecurityConfig</span> <span class="kd">extends</span> <span class="nc">GlobalMethodSecurityConfiguration</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">MethodSecurityMetadataSource</span> <span class="nf">customMethodSecurityMetadataSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">MapBasedMethodSecurityMetadataSource</span><span class="o">(</span> <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="-map-기반-db-연동-2">### Map 기반 DB 연동 (2)</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/37.png">
          <img src="/assets/images/post/Spring/Security2/37.png" alt="" />
      </a>
    
  
  
</figure>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MethodSecurityConfig</span> <span class="kd">extends</span> <span class="nc">GlobalMethodSecurityConfiguration</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">SecurityResourceService</span> <span class="n">securityResourceService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">MethodSecurityMetadataSource</span> <span class="nf">customMethodSecurityMetadataSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">MapBasedMethodSecurityMetadataSource</span><span class="o">(</span><span class="n">methodResourcesMapFactoryBean</span><span class="o">().</span><span class="na">getObject</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">FactoryBean</span> <span class="nf">methodResourcesMapFactoryBean</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">MethodResourcesFactoryBean</span> <span class="n">methodResourcesFactoryBean</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MethodResourcesFactoryBean</span><span class="o">();</span>
        <span class="n">methodResourcesFactoryBean</span><span class="o">.</span><span class="na">setSecurityResourceService</span><span class="o">(</span><span class="n">securityResourceService</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">methodResourcesFactoryBean</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MethodResourcesFactoryBean</span> <span class="kd">implements</span> <span class="nc">FactoryBean</span><span class="o">&lt;</span><span class="nc">LinkedHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;&gt;&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">SecurityResourceService</span> <span class="n">securityResourceService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;&gt;</span> <span class="n">resourceMap</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSecurityResourceService</span><span class="o">(</span><span class="nc">SecurityResourceService</span> <span class="n">securityResourceService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">securityResourceService</span> <span class="o">=</span> <span class="n">securityResourceService</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;&gt;</span> <span class="nf">getObject</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// String: Package + Class + Method</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">resourceMap</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">init</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">resourceMap</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">resourceMap</span> <span class="o">=</span> <span class="n">securityResourceService</span><span class="o">.</span><span class="na">getResourceList</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">LinkedHashMap</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="protectpointcutpostprocessor">ProtectPointcutPostProcessor</h3>
<ul>
  <li>메소드 방식의 인가처리를 위한 자원 및 권한정보 설정시 자원에 포인트 컷 표현식을 사용할 수 있도록 지원하는 클래스</li>
  <li>빈 후처리기로서 스프링 초기화 과정에서 빈 들을 검사하여 빈이 가진 메소드 중에서 포인트 컷 표현식과 matching 되는 클래스, 메소드, 권한 정보를 <code class="language-plaintext highlighter-rouge">MapBasedMethodSecurityMetadataSource</code>에 전달하여 인가처리가 되도록 제공되는 클래스</li>
  <li>설정 클래스에서 빈 생성시 접근제한자가 package 범위로 되어 있기 때문에 직접 <code class="language-plaintext highlighter-rouge">ProtectPointcutPostProcessor</code>을 만들어서 빈으로 등록해야 한다. <code class="language-plaintext highlighter-rouge">attemptMatch</code> 메소드는 <code class="language-plaintext highlighter-rouge">try~catch</code> 문으로 감싸야 에러처리가 가능해진다.</li>
  <li><code class="language-plaintext highlighter-rouge">ProtectPointcutPostProcessor</code>는 <code class="language-plaintext highlighter-rouge">BeanPostProcessor</code>를 구현하고 있는데 <code class="language-plaintext highlighter-rouge">postProcessBeforeInitialization</code> 메소드 안에서 <code class="language-plaintext highlighter-rouge">attemptMatch</code>를 호출한다. <code class="language-plaintext highlighter-rouge">attemptMatch</code>는 포인트컷 매칭여부를 검사하고 메소드가 포인트컷에 매칭이 되면 <code class="language-plaintext highlighter-rouge">Map&lt;String, List&lt;ConfigAttribute&gt;&gt; pointcutMap</code>에서(String: 포인트컷) 권한 정보를 가져와서 <code class="language-plaintext highlighter-rouge">MapBasedMethodSecurityMetadataSource</code>로 넘긴다. 그러면 <code class="language-plaintext highlighter-rouge">MapBasedMethodSecurityMetadataSource</code>에서 <code class="language-plaintext highlighter-rouge">Map&lt;RegisteredMethod, List&lt;ConfigAttribute&gt;&gt; methodMap</code>에 저장을 한다. 이렇게 되면 프록시 팩토리에서 Advisor의 포인트컷으로 매칭여부를 검사하고 해당되면 Advice를 적용하고 프록시 객체를 생성한 후 빈으로 등록한다.</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Security2/38.png">
          <img src="/assets/images/post/Spring/Security2/38.png" alt="" />
      </a>
    
  
  
</figure>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#security" class="page__taxonomy-item" rel="tag">Security</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#spring" class="page__taxonomy-item" rel="tag">Spring</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 카테고리: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#spring-security" class="page__taxonomy-item" rel="tag">Spring/Security</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 업데이트:</strong> <time datetime="2022-02-05T00:00:00+09:00">February 5, 2022</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">공유하기</h4>
  

  <a href="https://twitter.com/intent/tweet?text=%5BSpring%5D%5BSecurity%5D+%EC%8A%A4%ED%94%84%EB%A7%81+%EC%8B%9C%ED%81%90%EB%A6%AC%ED%8B%B0+%EC%9E%AC%EC%A0%95%EB%A6%AC%20https%3A%2F%2Frere950303.github.io%2Fspring%2Fsecurity%2FSpringSecurity2%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Frere950303.github.io%2Fspring%2Fsecurity%2FSpringSecurity2%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Frere950303.github.io%2Fspring%2Fsecurity%2FSpringSecurity2%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/spring/security/SecurityTest/" class="pagination--pager" title="[Spring][Security] 스프링 시큐리티 테스트
">이전</a>
    
    
      <a href="/kubernetes/Kubernetes2/" class="pagination--pager" title="[Kubernetes] 쿠버네티스
">다음</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">연관글</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/java/newoperaiton/" rel="permalink">[Java] 불필요한 객체 생성을 피하라
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-05-27T00:00:00+09:00">May 27, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          최대 1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/java/di/" rel="permalink">[Java] 자원을 직접 명시하지 말고 의존 객체 주입을 사용하라
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-05-23T00:00:00+09:00">May 23, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          최대 1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/java/utility/" rel="permalink">[Java] 인스턴스화를 막으려거든 private 생성자를 사용하라
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-05-22T00:00:00+09:00">May 22, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          최대 1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/java/singleton/" rel="permalink">[Java] 생성자나 열거 타입으로 싱글턴임을 보증하라
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-05-21T00:00:00+09:00">May 21, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="검색어를 입력하세요..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      
        
      
        
      
        
          <li><a href="https://github.com/rere950303" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    
    
    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 yhw. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    <script>
  'use strict';

  (function() {
    var commentContainer = document.querySelector('#utterances-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://utteranc.es/client.js');
    script.setAttribute('repo', 'rere950303/rere950303.github.io');
    script.setAttribute('issue-term', 'title');
    script.setAttribute('theme', 'github-light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>

  





  </body>
</html>
