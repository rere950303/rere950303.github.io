<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.20.2 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>[Spring][DB] 스프링 DB 1편 - 데이터 접근 핵심 원리 - YHW Blog</title>
<meta name="description" content="새로운 배움을 기록하고 공유합니다">


  <meta name="author" content="yhw">
  
  <meta property="article:author" content="yhw">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="YHW Blog">
<meta property="og:title" content="[Spring][DB] 스프링 DB 1편 - 데이터 접근 핵심 원리">
<meta property="og:url" content="https://rere950303.github.io/spring/db/springdb/">


  <meta property="og:description" content="새로운 배움을 기록하고 공유합니다">







  <meta property="article:published_time" content="2022-07-08T00:00:00+09:00">





  

  


<link rel="canonical" href="https://rere950303.github.io/spring/db/springdb/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "yhw",
      "url": "https://rere950303.github.io/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="YHW Blog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
<link rel="manifest" href="/favicon/site.webmanifest">
<link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          YHW Blog
          <span class="site-subtitle">새로운 배움을 기록하고 공유합니다</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/">categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">토글 메뉴</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://rere950303.github.io/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#spring" itemprop="item"><span itemprop="name">Spring</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#db" itemprop="item"><span itemprop="name">Db</span></a>
          <meta itemprop="position" content="3" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">[Spring][DB] 스프링 DB 1편 - 데이터 접근 핵심 원리</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/bio/photo.jpg" alt="yhw" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">yhw</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>어제와 다른 오늘, 오늘 같은 내일</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">팔로우</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Republic of Korea</span>
        </li>
      

      
        
          
            <li><a href="mailto:yhwjjang1995@naver.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
        
          
        
          
            <li><a href="https://github.com/rere950303" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="[Spring][DB] 스프링 DB 1편 - 데이터 접근 핵심 원리">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2022-07-08T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">[Spring][DB] 스프링 DB 1편 - 데이터 접근 핵심 원리
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-07-08T00:00:00+09:00">July 8, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          35 분 소요
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              
                <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
                <ul class="toc__menu">
  <li><a href="#들어가며">들어가며</a></li>
  <li><a href="#jdbc-이해">JDBC 이해</a>
    <ul>
      <li><a href="#jdbc-등장-이유">JDBC 등장 이유</a></li>
      <li><a href="#jdbc-표준-인터페이스">JDBC 표준 인터페이스</a></li>
      <li><a href="#jdbc-표준-인터페이스의-장점">JDBC 표준 인터페이스의 장점</a></li>
      <li><a href="#jdbc와-최신-데이터-접근-기술">JDBC와 최신 데이터 접근 기술</a>
        <ul>
          <li><a href="#sql-mapper">SQL Mapper</a></li>
          <li><a href="#orm-기술">ORM 기술</a></li>
        </ul>
      </li>
      <li><a href="#데이터베이스-연결">데이터베이스 연결</a></li>
      <li><a href="#jdbc-개발---등록">JDBC 개발 - 등록</a></li>
      <li><a href="#jdbc-개발---조회">JDBC 개발 - 조회</a>
        <ul>
          <li><a href="#resultset">ResultSet</a></li>
        </ul>
      </li>
      <li><a href="#jdbc-개발---수정-삭제">JDBC 개발 - 수정, 삭제</a></li>
    </ul>
  </li>
  <li><a href="#커넥션풀과-데이터소스-이해">커넥션풀과 데이터소스 이해</a>
    <ul>
      <li><a href="#커넥션-풀-이해">커넥션 풀 이해</a>
        <ul>
          <li><a href="#데이터베이스-커넥션을-매번-획득">데이터베이스 커넥션을 매번 획득</a></li>
          <li><a href="#커넥션-풀-초기화">커넥션 풀 초기화</a></li>
        </ul>
      </li>
      <li><a href="#datasource-이해">DataSource 이해</a></li>
      <li><a href="#datasource-예제1---drivermanager">DataSource 예제1 - DriverManager</a>
        <ul>
          <li><a href="#설정과-사용의-분리">설정과 사용의 분리</a></li>
        </ul>
      </li>
      <li><a href="#datasource-예제2---커넥션-풀">DataSource 예제2 - 커넥션 풀</a>
        <ul>
          <li><a href="#yhw-connection-adder">yhw connection adder</a></li>
        </ul>
      </li>
      <li><a href="#datasource-적용">DataSource 적용</a></li>
    </ul>
  </li>
  <li><a href="#트랜잭션-이해">트랜잭션 이해</a>
    <ul>
      <li><a href="#트랜잭션---개념-이해">트랜잭션 - 개념 이해</a>
        <ul>
          <li><a href="#트랜잭션-격리-수준---isolation-level">트랜잭션 격리 수준 - Isolation level</a></li>
          <li><a href="#낙관적-락과-비관적-락">낙관적 락과 비관적 락</a></li>
          <li><a href="#jpa-낙관적-락">JPA 낙관적 락</a></li>
          <li><a href="#jpa-비관적-락">JPA 비관적 락</a></li>
        </ul>
      </li>
      <li><a href="#데이터베이스-연결-구조와-db-세션">데이터베이스 연결 구조와 DB 세션</a></li>
      <li><a href="#트랜잭션---적용1">트랜잭션 - 적용1</a></li>
      <li><a href="#트랜잭션---적용2">트랜잭션 - 적용2</a></li>
    </ul>
  </li>
  <li><a href="#스프링과-문제-해결---트랜잭션">스프링과 문제 해결 - 트랜잭션</a>
    <ul>
      <li><a href="#문제점들">문제점들</a>
        <ul>
          <li><a href="#트랜잭션-문제">트랜잭션 문제</a></li>
          <li><a href="#예외-누수">예외 누수</a></li>
          <li><a href="#jdbc-반복-문제">JDBC 반복 문제</a></li>
        </ul>
      </li>
      <li><a href="#트랜잭션-추상화">트랜잭션 추상화</a>
        <ul>
          <li><a href="#스프링의-트랜잭션-추상화">스프링의 트랜잭션 추상화</a></li>
        </ul>
      </li>
      <li><a href="#트랜잭션-동기화">트랜잭션 동기화</a>
        <ul>
          <li><a href="#workflow">workflow</a></li>
        </ul>
      </li>
      <li><a href="#트랜잭션-문제-해결---트랜잭션-매니저">트랜잭션 문제 해결 - 트랜잭션 매니저</a>
        <ul>
          <li><a href="#workflow-1">workflow</a></li>
        </ul>
      </li>
      <li><a href="#트랜잭션-문제-해결---트랜잭션-템플릿">트랜잭션 문제 해결 - 트랜잭션 템플릿</a></li>
      <li><a href="#트랜잭션-문제-해결---트랜잭션-aop-이해">트랜잭션 문제 해결 - 트랜잭션 AOP 이해</a></li>
      <li><a href="#트랜잭션-문제-해결---트랜잭션-aop-적용">트랜잭션 문제 해결 - 트랜잭션 AOP 적용</a></li>
      <li><a href="#트랜잭션-문제-해결---트랜잭션-aop-정리">트랜잭션 문제 해결 - 트랜잭션 AOP 정리</a></li>
      <li><a href="#스프링-부트의-자동-리소스-등록">스프링 부트의 자동 리소스 등록</a>
        <ul>
          <li><a href="#데이터소스---자동-등록">데이터소스 - 자동 등록</a></li>
          <li><a href="#트랜잭션-매니저---자동-등록">트랜잭션 매니저 - 자동 등록</a></li>
          <li><a href="#데이터소스와-트랜잭션-매니저-자동-등록">데이터소스와 트랜잭션 매니저 자동 등록</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#자바-예외-이해">자바 예외 이해</a>
    <ul>
      <li><a href="#체크-예외-활용">체크 예외 활용</a>
        <ul>
          <li><a href="#복구-불가능한-예외">복구 불가능한 예외</a></li>
          <li><a href="#의존-관계에-대한-문제">의존 관계에 대한 문제</a></li>
          <li><a href="#throws-exception">throws Exception</a></li>
        </ul>
      </li>
      <li><a href="#언체크-예외-활용">언체크 예외 활용</a></li>
    </ul>
  </li>
  <li><a href="#스프링과-문제-해결---예외-처리-반복">스프링과 문제 해결 - 예외 처리, 반복</a>
    <ul>
      <li><a href="#체크-예외와-인터페이스">체크 예외와 인터페이스</a></li>
      <li><a href="#런타임-예외-적용">런타임 예외 적용</a></li>
      <li><a href="#데이터-접근-예외-직접-만들기">데이터 접근 예외 직접 만들기</a></li>
      <li><a href="#스프링-예외-추상화-이해">스프링 예외 추상화 이해</a>
        <ul>
          <li><a href="#스프링이-제공하는-예외-변환기">스프링이 제공하는 예외 변환기</a></li>
        </ul>
      </li>
      <li><a href="#jdbc-반복-문제-해결---jdbctemplate">JDBC 반복 문제 해결 - JdbcTemplate</a>
        <ul>
          <li><a href="#jdbc-반복-문제-1">JDBC 반복 문제</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

              
            </nav>
            <nav class="toc-custom">
              
            </nav>
          </aside>
        
        <h2 id="들어가며">들어가며</h2>
<p>해당 게시글은 인프런 김영한 강사님의 <a href="https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-db-1/dashboard">스프링 DB 1편 - 데이터 접근 핵심 원리</a> 강의를 바탕으로 쓰였음을 미리 밝힙니다.</p>

<h2 id="jdbc-이해">JDBC 이해</h2>
<h3 id="jdbc-등장-이유">JDBC 등장 이유</h3>
<ul>
  <li>데이터베이스를 다른 종류의 데이터베이스로 변경하면 애플리케이션 서버에 개발된 데이터베이스 사용 코드도 함께 변경해야 한다.</li>
  <li>개발자가 각각의 데이터베이스마다 커넥션 연결, SQL 전달, 그리고 그 결과를 응답 받는 방법을 새로 학습해야 한다.</li>
</ul>

<h3 id="jdbc-표준-인터페이스">JDBC 표준 인터페이스</h3>
<p>JDBC(Java Database Connectivity)는 자바에서 데이터베이스에 접속할 수 있도록 하는 자바 API다. JDBC는 데이터베이스에서 자료를 쿼리하거나 업데이트하는 방법을 제공한다.</p>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/1.png">
          <img src="/assets/images/post/Spring/db1/1.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">java.sql.Connection</code> - 연결</li>
  <li><code class="language-plaintext highlighter-rouge">java.sql.Statement</code> - SQL을 담은 내용</li>
  <li><code class="language-plaintext highlighter-rouge">java.sql.ResultSet</code> - SQL 요청 응답</li>
</ul>

<h3 id="jdbc-표준-인터페이스의-장점">JDBC 표준 인터페이스의 장점</h3>
<ul>
  <li>애플리케이션 로직은 이제 JDBC 표준 인터페이스에만 의존한다. 따라서 데이터베이스를 다른 종류의 데이터베이스로 변경하고 싶으면 JDBC 구현 라이브러리(드라이버)만 변경하면 된다</li>
  <li>개발자는 JDBC 표준 인터페이스 사용법만 학습하면 된다. 한번 배워두면 수십개의 데이터베이스에 모두 동일하게 적용할 수 있다.</li>
</ul>

<h3 id="jdbc와-최신-데이터-접근-기술">JDBC와 최신 데이터 접근 기술</h3>
<h4 id="sql-mapper">SQL Mapper</h4>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/2.png">
          <img src="/assets/images/post/Spring/db1/2.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>JDBC를 편리하게 사용하도록 도와준다.</li>
  <li>SQL 응답 결과를 객체로 편리하게 변환해준다.</li>
  <li>JDBC의 반복 코드를 제거해준다.</li>
  <li>개발자가 SQL을 직접 작성해야한다.</li>
</ul>

<h4 id="orm-기술">ORM 기술</h4>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/3.png">
          <img src="/assets/images/post/Spring/db1/3.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>ORM은 객체를 관계형 데이터베이스 테이블과 매핑해주는 기술이다. 이 기술 덕분에 개발자는 반복적인 SQL을 직접 작성하지 않고, ORM 기술이 개발자 대신에 SQL을 동적으로 만들어 실행해준다. 추가로 각각의 데이터베이스마다 다른 SQL을 사용하는 문제도 중간에서 해결해준다.</li>
  <li>JPA는 자바 진영의 ORM 표준 인터페이스이고, 이것을 구현한 것으로 하이버네이트와 이클립스 링크 등의 구현 기술이 있다.</li>
</ul>

<h3 id="데이터베이스-연결">데이터베이스 연결</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DBConnectionUtil</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="no">URL</span><span class="o">,</span> <span class="no">USERNAME</span><span class="o">,</span> <span class="no">PASSWORD</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"get connection={}, class={}"</span><span class="o">,</span> <span class="n">connection</span><span class="o">,</span> <span class="n">connection</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">connection</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>데이터베이스에 연결하려면 JDBC가 제공하는 <code class="language-plaintext highlighter-rouge">DriverManager.getConnection(..)</code> 를 사용하면 된다. 이렇게 하면 라이브러리에 있는 데이터베이스 드라이버를 찾아서 해당 드라이버가 제공하는 커넥션을 반환해준다. 물론 이 커넥션은 JDBC 표준 커넥션 인터페이스인 <code class="language-plaintext highlighter-rouge">java.sql.Connection</code> 인터페이스를 구현하고 있다.</p>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/4.png">
          <img src="/assets/images/post/Spring/db1/4.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>JDBC가 제공하는 <code class="language-plaintext highlighter-rouge">DriverManager</code> 는 라이브러리에 등록된 DB 드라이버들을 관리하고, 커넥션을 획득하는 기능을 제공한다.</li>
  <li>애플리케이션 로직에서 커넥션이 필요하면 <code class="language-plaintext highlighter-rouge">DriverManager.getConnection()</code> 을 호출한다.</li>
  <li><code class="language-plaintext highlighter-rouge">DriverManager</code> 는 라이브러리에 등록된 드라이버 목록을 자동으로 인식한다. 이 드라이버들에게 순서대로(h2 -&gt; MySQL -&gt; …) 다음 정보를 넘겨서 커넥션을 획득할 수 있는지 확인한다.</li>
</ul>

<h3 id="jdbc-개발---등록">JDBC 개발 - 등록</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRepositoryV0</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into member(member_id, money) values(?, ?)"</span><span class="o">;</span>

        <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">PreparedStatement</span> <span class="n">pstmt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">getConnection</span><span class="o">();</span>
            <span class="n">pstmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getMoney</span><span class="o">());</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>

            <span class="k">return</span> <span class="n">member</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"db error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">pstmt</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">Statement</span> <span class="n">stmt</span><span class="o">,</span> <span class="nc">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">rs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">stmt</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">con</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">DBConnectionUtil</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">con.prepareStatement(sql)</code> : 데이터베이스에 전달할 SQL과 파라미터로 전달할 데이터들을 준비한다.</li>
  <li><code class="language-plaintext highlighter-rouge">pstmt.setString(1, member.getMemberId())</code> : SQL의 첫번째 <code class="language-plaintext highlighter-rouge">?</code> 에 값을 지정한다. 문자이므로 <code class="language-plaintext highlighter-rouge">setString</code> 을 사용한다.</li>
  <li><code class="language-plaintext highlighter-rouge">pstmt.setInt(2, member.getMoney())</code> : SQL의 두번째 <code class="language-plaintext highlighter-rouge">?</code> 에 값을 지정한다. <code class="language-plaintext highlighter-rouge">Int</code> 형 숫자이므로 <code class="language-plaintext highlighter-rouge">setInt</code> 를 지정한다.</li>
  <li>쿼리를 실행하고 나면 리소스를 정리해야 한다. 여기서는 <code class="language-plaintext highlighter-rouge">Connection</code> , <code class="language-plaintext highlighter-rouge">PreparedStatement</code> 를 사용했다. 리소스를 정리할 때는 항상 역순으로 해야한다. 예외가 발생하든, 하지 않든 항상 수행되어야 하므로 <code class="language-plaintext highlighter-rouge">finally</code> 구문에 주의해서 작성해야한다.</li>
  <li><code class="language-plaintext highlighter-rouge">PreparedStatement</code> 는 <code class="language-plaintext highlighter-rouge">Statement</code> 의 자식 타입인데, <code class="language-plaintext highlighter-rouge">?</code> 를 통한 파라미터 바인딩을 가능하게 해준다. SQL Injection 공격을 예방하려면 <code class="language-plaintext highlighter-rouge">PreparedStatement</code> 를 통한 파라미터 바인딩 방식을 사용해야 한다.</li>
</ul>

<h3 id="jdbc-개발---조회">JDBC 개발 - 조회</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRepositoryV0</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from member where member_id = ?"</span><span class="o">;</span>

        <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">PreparedStatement</span> <span class="n">pstmt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">getConnection</span><span class="o">();</span>
            <span class="n">pstmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">memberId</span><span class="o">);</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">pstmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">();</span>
                <span class="n">member</span><span class="o">.</span><span class="na">setMemberId</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"member_id"</span><span class="o">));</span>
                <span class="n">member</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"money"</span><span class="o">));</span>

                <span class="k">return</span> <span class="n">member</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">(</span><span class="s">"member not found memberId="</span> <span class="o">+</span> <span class="n">memberId</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"db error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">pstmt</span><span class="o">,</span> <span class="n">rs</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">Statement</span> <span class="n">stmt</span><span class="o">,</span> <span class="nc">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">rs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">stmt</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">con</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">DBConnectionUtil</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<h4 id="resultset">ResultSet</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">ResultSet</code> 은 다음과 같이 생긴 데이터 구조이다. 보통 <code class="language-plaintext highlighter-rouge">select</code> 쿼리의 결과가 순서대로 들어간다. 예를 들어서 <code class="language-plaintext highlighter-rouge">select member_id, money</code> 라고 지정하면 <code class="language-plaintext highlighter-rouge">member_id</code> , <code class="language-plaintext highlighter-rouge">money</code> 라는 이름으로 데이터가 저장된다.</li>
  <li><code class="language-plaintext highlighter-rouge">ResultSet</code> 내부에 있는 커서( <code class="language-plaintext highlighter-rouge">cursor</code> )를 이동해서 다음 데이터를 조회할 수 있다.</li>
  <li><code class="language-plaintext highlighter-rouge">rs.next()</code> : 이것을 호출하면 커서가 다음으로 이동한다. 참고로 최초의 커서는 데이터를 가리키고 있지 않기 때문에 <code class="language-plaintext highlighter-rouge">rs.next()</code> 를 최초 한번은 호출해야 데이터를 조회할 수 있다.</li>
  <li><code class="language-plaintext highlighter-rouge">rs.next()</code> 의 결과가 <code class="language-plaintext highlighter-rouge">true</code> 면 커서의 이동 결과 데이터가 있다는 뜻이다.</li>
  <li><code class="language-plaintext highlighter-rouge">rs.next()</code> 의 결과가 <code class="language-plaintext highlighter-rouge">false</code> 면 더이상 커서가 가리키는 데이터가 없다는 뜻이다.</li>
  <li><code class="language-plaintext highlighter-rouge">rs.getString("member_id")</code> : 현재 커서가 가리키고 있는 위치의 <code class="language-plaintext highlighter-rouge">member_id</code> 데이터를 <code class="language-plaintext highlighter-rouge">String</code> 타입으로 반환한다.</li>
  <li><code class="language-plaintext highlighter-rouge">rs.getInt("money")</code> : 현재 커서가 가리키고 있는 위치의 <code class="language-plaintext highlighter-rouge">money</code> 데이터를 <code class="language-plaintext highlighter-rouge">int</code> 타입으로 반환한다.</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/5.png">
          <img src="/assets/images/post/Spring/db1/5.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="jdbc-개발---수정-삭제">JDBC 개발 - 수정, 삭제</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRepositoryV0</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"update member set money=? where member_id=?"</span><span class="o">;</span>

        <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">PreparedStatement</span> <span class="n">pstmt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">getConnection</span><span class="o">();</span>
            <span class="n">pstmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">memberId</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">resultSize</span> <span class="o">=</span> <span class="n">pstmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"db error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">pstmt</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"delete from member where member_id=?"</span><span class="o">;</span>

        <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">PreparedStatement</span> <span class="n">pstmt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">getConnection</span><span class="o">();</span>
            <span class="n">pstmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">memberId</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"db error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">pstmt</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">Statement</span> <span class="n">stmt</span><span class="o">,</span> <span class="nc">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">rs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">stmt</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">con</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">DBConnectionUtil</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="커넥션풀과-데이터소스-이해">커넥션풀과 데이터소스 이해</h2>
<h3 id="커넥션-풀-이해">커넥션 풀 이해</h3>
<h4 id="데이터베이스-커넥션을-매번-획득">데이터베이스 커넥션을 매번 획득</h4>
<ol>
  <li>애플리케이션 로직은 DB 드라이버를 통해 커넥션을 조회한다.</li>
  <li>DB 드라이버는 DB와 <code class="language-plaintext highlighter-rouge">TCP/IP</code> 커넥션을 연결한다. 물론 이 과정에서 3 way handshake 같은 <code class="language-plaintext highlighter-rouge">TCP/IP</code> 연결을 위한 네트워크 동작이 발생한다.</li>
  <li>DB 드라이버는 <code class="language-plaintext highlighter-rouge">TCP/IP</code> 커넥션이 연결되면 ID, PW와 기타 부가정보를 DB에 전달한다.</li>
  <li>DB는 ID, PW를 통해 내부 인증을 완료하고, 내부에 DB 세션을 생성한다.</li>
  <li>DB는 커넥션 생성이 완료되었다는 응답을 보낸다.</li>
  <li>DB 드라이버는 커넥션 객체를 생성해서 클라이언트에 반환한다.</li>
</ol>

<h4 id="커넥션-풀-초기화">커넥션 풀 초기화</h4>
<ul>
  <li>애플리케이션을 시작하는 시점에 커넥션 풀은 필요한 만큼 커넥션을 미리 확보해서 풀에 보관한다. 보통 얼마나 보관할 지는 서비스의 특징과 서버 스펙에 따라 다르지만 기본값은 보통 10개이다.</li>
  <li>애플리케이션 로직에서 이제는 DB 드라이버를 통해서 새로운 커넥션을 획득하는 것이 아니다.</li>
  <li>이제는 커넥션 풀을 통해 이미 생성되어 있는 커넥션을 객체 참조로 그냥 가져다 쓰기만 하면 된다.</li>
  <li>커넥션 풀에 커넥션을 요청하면 커넥션 풀은 자신이 가지고 있는 커넥션 중에 하나를 반환한다.</li>
  <li>커넥션을 모두 사용하고 나면 이제는 커넥션을 종료하는 것이 아니라, 다음에 다시 사용할 수 있도록 해당 커넥션을 그대로 커넥션 풀에 반환하면 된다. 여기서 주의할 점은 커넥션을 <strong>종료</strong>하는 것이 아니라 커넥션이 살아있는 상태로 커넥션 풀에 반환해야 한다는 것이다.</li>
  <li>성능과 사용의 편리함 측면에서 최근에는 <code class="language-plaintext highlighter-rouge">hikariCP</code> 를 주로 사용한다. 스프링 부트 2.0 부터는 기본 커넥션 풀로 <code class="language-plaintext highlighter-rouge">hikariCP</code> 를 제공한다. 성능, 사용의 편리함, 안전성 측면에서 이미 검증이 되었기 때문에 커넥션 풀을 사용할 때는 고민할 것 없이 <code class="language-plaintext highlighter-rouge">hikariCP</code> 를 사용하면 된다.</li>
</ul>

<figure class="half ">
  
    
      <a href="/assets/images/post/Spring/db1/6.png">
          <img src="/assets/images/post/Spring/db1/6.png" alt="" />
      </a>
    
  
    
      <a href="/assets/images/post/Spring/db1/7.png">
          <img src="/assets/images/post/Spring/db1/7.png" alt="" />
      </a>
    
  
    
      <a href="/assets/images/post/Spring/db1/8.png">
          <img src="/assets/images/post/Spring/db1/8.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="datasource-이해">DataSource 이해</h3>
<ul>
  <li>예를 들어서 애플리케이션 로직에서 <code class="language-plaintext highlighter-rouge">DriverManager</code> 를 사용해서 커넥션을 획득하다가 <code class="language-plaintext highlighter-rouge">HikariCP</code> 같은 커넥션 풀을 사용하도록 변경하면 커넥션을 획득하는 애플리케이션 코드도 함께 변경해야 한다. 의존관계가 <code class="language-plaintext highlighter-rouge">DriverManager</code> 에서 <code class="language-plaintext highlighter-rouge">HikariCP</code> 로 변경되기 때문이다. 물론 둘의 사용법도 조금씩 다를 것이다.</li>
  <li>자바에서는 이런 문제를 해결하기 위해 <code class="language-plaintext highlighter-rouge">javax.sql.DataSource</code> 라는 인터페이스를 제공한다.</li>
  <li><code class="language-plaintext highlighter-rouge">DataSource</code> 는 커넥션을 획득하는 방법을 추상화 하는 인터페이스이다.</li>
  <li>대부분의 커넥션 풀은 <code class="language-plaintext highlighter-rouge">DataSource</code> 인터페이스를 이미 구현해두었다. 따라서 개발자는 <code class="language-plaintext highlighter-rouge">DBCP2 커넥션 풀</code> , <code class="language-plaintext highlighter-rouge">HikariCP 커넥션 풀</code> 의 코드를 직접 의존하는 것이 아니라 <code class="language-plaintext highlighter-rouge">DataSource</code> 인터페이스에만 의존하도록 애플리케이션 로직을 작성하면 된다.</li>
  <li><code class="language-plaintext highlighter-rouge">DriverManager</code> 는 <code class="language-plaintext highlighter-rouge">DataSource</code> 인터페이스를 사용하지 않는다. 따라서 <code class="language-plaintext highlighter-rouge">DriverManager</code> 는 직접 사용해야 한다. 따라서 <code class="language-plaintext highlighter-rouge">DriverManager</code> 를 사용하다가 <code class="language-plaintext highlighter-rouge">DataSource</code> 기반의 커넥션 풀을 사용하도록 변경하면 관련 코드를 다 고쳐야 한다. 이런 문제를 해결하기 위해 스프링은 <code class="language-plaintext highlighter-rouge">DriverManager</code> 도 <code class="language-plaintext highlighter-rouge">DataSource</code> 를 통해서 사용할 수 있도록 <code class="language-plaintext highlighter-rouge">DriverManagerDataSource</code> 라는 <code class="language-plaintext highlighter-rouge">DataSource</code> 를 구현한 클래스를 제공한다.</li>
  <li>자바는 <code class="language-plaintext highlighter-rouge">DataSource</code> 를 통해 커넥션을 획득하는 방법을 추상화했다. 이제 애플리케이션 로직은 <code class="language-plaintext highlighter-rouge">DataSource</code> 인터페이스에만 의존하면 된다. 덕분에 <code class="language-plaintext highlighter-rouge">DriverManagerDataSource</code> 를 통해서 <code class="language-plaintext highlighter-rouge">DriverManager</code> 를 사용하다가 커넥션 풀을 사용하도록 코드를 변경해도 애플리케이션 로직은 변경하지 않아도 된다.</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/9.png">
          <img src="/assets/images/post/Spring/db1/9.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="datasource-예제1---drivermanager">DataSource 예제1 - DriverManager</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConnectionTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">driverManager</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Connection</span> <span class="n">con1</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="no">URL</span><span class="o">,</span> <span class="no">USERNAME</span><span class="o">,</span> <span class="no">PASSWORD</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">con2</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="no">URL</span><span class="o">,</span> <span class="no">USERNAME</span><span class="o">,</span> <span class="no">PASSWORD</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"connection={}, class={}"</span><span class="o">,</span> <span class="n">con1</span><span class="o">,</span> <span class="n">con1</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"connection={}, class={}"</span><span class="o">,</span> <span class="n">con2</span><span class="o">,</span> <span class="n">con2</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dataSourceDriverManager</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// 항상 새로운 커넥션 획득</span>
        <span class="nc">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DriverManagerDataSource</span><span class="o">(</span><span class="no">URL</span><span class="o">,</span> <span class="no">USERNAME</span><span class="o">,</span> <span class="no">PASSWORD</span><span class="o">);</span>
        <span class="n">userDataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">userDataSource</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">Connection</span> <span class="n">con1</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="nc">Connection</span> <span class="n">con2</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"connection={}, class={}"</span><span class="o">,</span> <span class="n">con1</span><span class="o">,</span> <span class="n">con1</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"connection={}, class={}"</span><span class="o">,</span> <span class="n">con2</span><span class="o">,</span> <span class="n">con2</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">DriverManager</code> 는 커넥션을 획득할 때 마다 <code class="language-plaintext highlighter-rouge">URL</code> , <code class="language-plaintext highlighter-rouge">USERNAME</code> , <code class="language-plaintext highlighter-rouge">PASSWORD</code> 같은 파라미터를 계속 전달해야 한다. 반면에 <code class="language-plaintext highlighter-rouge">DataSource</code> 를 사용하는 방식은 처음 객체를 생성할 때만 필요한 파리미터를 넘겨두고, 커넥션을 획득할 때는 단순히 <code class="language-plaintext highlighter-rouge">dataSource.getConnection()</code> 만 호출하면 된다</li>
</ul>

<h4 id="설정과-사용의-분리">설정과 사용의 분리</h4>
<ul>
  <li>설정: <code class="language-plaintext highlighter-rouge">DataSource</code> 를 만들고 필요한 속성들을 사용해서 <code class="language-plaintext highlighter-rouge">URL</code> , <code class="language-plaintext highlighter-rouge">USERNAME</code> , <code class="language-plaintext highlighter-rouge">PASSWORD</code> 같은 부분을 입력하는 것을 말한다. 이렇게 설정과 관련된 속성들은 한 곳에 있는 것이 향후 변경에 더 유연하게 대처할 수 있다.</li>
  <li>사용: 설정은 신경쓰지 않고, <code class="language-plaintext highlighter-rouge">DataSource</code> 의 <code class="language-plaintext highlighter-rouge">getConnection()</code> 만 호출해서 사용하면 된다.</li>
  <li>이 부분이 작아보이지만 큰 차이를 만들어내는데, 필요한 데이터를 <code class="language-plaintext highlighter-rouge">DataSource</code> 가 만들어지는 시점에 미리 다 넣어두게 되면, <code class="language-plaintext highlighter-rouge">DataSource</code> 를 사용하는 곳에서는 <code class="language-plaintext highlighter-rouge">dataSource.getConnection()</code> 만 호출하면 되므로 <code class="language-plaintext highlighter-rouge">URL</code> , <code class="language-plaintext highlighter-rouge">USERNAME</code> , <code class="language-plaintext highlighter-rouge">PASSWORD</code> 같은 속성들에 의존하지 않아도 된다. 그냥 <code class="language-plaintext highlighter-rouge">DataSource</code> 만 주입받아서 <code class="language-plaintext highlighter-rouge">getConnection()</code> 만 호출하면 된다.</li>
</ul>

<h3 id="datasource-예제2---커넥션-풀">DataSource 예제2 - 커넥션 풀</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConnectionTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dataSourceConnectionPool</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// 커넥션 풀링</span>
        <span class="nc">HikariDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariDataSource</span><span class="o">();</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setJdbcUrl</span><span class="o">(</span><span class="no">URL</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="no">USERNAME</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="no">PASSWORD</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setMaximumPoolSize</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setPoolName</span><span class="o">(</span><span class="s">"yhw"</span><span class="o">);</span>

        <span class="n">userDataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">userDataSource</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">Connection</span> <span class="n">con1</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="nc">Connection</span> <span class="n">con2</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"connection={}, class={}"</span><span class="o">,</span> <span class="n">con1</span><span class="o">,</span> <span class="n">con1</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"connection={}, class={}"</span><span class="o">,</span> <span class="n">con2</span><span class="o">,</span> <span class="n">con2</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>커넥션 풀에서 커넥션을 생성하는 작업은 애플리케이션 실행 속도에 영향을 주지 않기 위해 별도의 쓰레드에서 작동한다. 별도의 쓰레드에서 동작하기 때문에 테스트가 먼저 종료되어 버린다. 예제처럼 <code class="language-plaintext highlighter-rouge">Thread.sleep</code> 을 통해 대기 시간을 주어야 쓰레드 풀에 커넥션이 생성되는 로그를 확인할 수 있다.</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/10.png">
          <img src="/assets/images/post/Spring/db1/10.png" alt="" />
      </a>
    
  
  
</figure>

<h4 id="yhw-connection-adder">yhw connection adder</h4>
<p>별도의 쓰레드 사용해서 커넥션 풀에 커넥션을 채우고 있는 것을 확인할 수 있다. 이 쓰레드는 커넥션 풀에 커넥션을 최대 풀 수( <code class="language-plaintext highlighter-rouge">10</code> )까지 채운다. 그렇다면 왜 별도의 쓰레드를 사용해서 커넥션 풀에 커넥션을 채우는 것일까?
커넥션 풀에 커넥션을 채우는 것은 상대적으로 오래 걸리는 일이다. 애플리케이션을 실행할 때 커넥션 풀을 채울 때 까지 마냥 대기하고 있다면 애플리케이션 실행 시간이 늦어진다. 따라서 이렇게 별도의 쓰레드를 사용해서 커넥션 풀을 채워야 애플리케이션 실행 시간에 영향을 주지 않는다.</p>

<h3 id="datasource-적용">DataSource 적용</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRepositoryV1</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span> <span class="c1">// 의존관계 주입</span>

    <span class="o">...</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">Statement</span> <span class="n">stmt</span><span class="o">,</span> <span class="nc">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 편의 메서드</span>
        <span class="nc">JdbcUtils</span><span class="o">.</span><span class="na">closeResultSet</span><span class="o">(</span><span class="n">rs</span><span class="o">);</span>
        <span class="nc">JdbcUtils</span><span class="o">.</span><span class="na">closeStatement</span><span class="o">(</span><span class="n">stmt</span><span class="o">);</span>
        <span class="nc">JdbcUtils</span><span class="o">.</span><span class="na">closeConnection</span><span class="o">(</span><span class="n">con</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"get connection={}, class={}"</span><span class="o">,</span> <span class="n">con</span><span class="o">,</span> <span class="n">con</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">con</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">class</span> <span class="nc">MemberRepositoryV1Test</span> <span class="o">{</span>

    <span class="nc">MemberRepositoryV1</span> <span class="n">repository</span><span class="o">;</span>

    <span class="nd">@BeforeEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">beforeEach</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">DriverManagerDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DriverManagerDataSource</span><span class="o">(</span><span class="no">URL</span><span class="o">,</span> <span class="no">USERNAME</span><span class="o">,</span> <span class="no">PASSWORD</span><span class="o">);</span>
<span class="c1">//        DriverManagerDataSource dataSource = new HikariDataSource();</span>
<span class="c1">//        dataSource.setUrl(URL);</span>
<span class="c1">//        dataSource.setUsername(USERNAME);</span>
<span class="c1">//        dataSource.setPassword(PASSWORD);</span>

        <span class="n">repository</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MemberRepositoryV1</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">crud</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="s">"memberV100"</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>

        <span class="nc">Member</span> <span class="n">findMember</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"findMember={}"</span><span class="o">,</span> <span class="n">findMember</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMember</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">member</span><span class="o">);</span> <span class="c1">// @Data</span>

        <span class="n">repository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">(),</span> <span class="mi">20000</span><span class="o">);</span>
        <span class="nc">Member</span> <span class="n">updatedMember</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">updatedMember</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">20000</span><span class="o">);</span> <span class="c1">// @Data</span>

        <span class="n">repository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>
        <span class="n">assertThatThrownBy</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">repository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">())).</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="nc">NoSuchElementException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">DataSource</code> 의존관계 주입
    <ul>
      <li>외부에서 <code class="language-plaintext highlighter-rouge">DataSource</code> 를 주입 받아서 사용한다. 이제 직접 만든 <code class="language-plaintext highlighter-rouge">DBConnectionUtil</code> 을 사용하지 않아도 된다.</li>
      <li><code class="language-plaintext highlighter-rouge">DataSource</code> 는 표준 인터페이스 이기 때문에 <code class="language-plaintext highlighter-rouge">DriverManagerDataSource</code> 에서 <code class="language-plaintext highlighter-rouge">HikariDataSource</code> 로 변경되어도 해당 코드를 변경하지 않아도 된다.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">JdbcUtils</code> 편의 메서드
    <ul>
      <li>스프링은 JDBC를 편리하게 다룰 수 있는 <code class="language-plaintext highlighter-rouge">JdbcUtils</code> 라는 편의 메서드를 제공한다.</li>
      <li><code class="language-plaintext highlighter-rouge">JdbcUtils</code> 을 사용하면 커넥션을 좀 더 편리하게 닫을 수 있다.</li>
    </ul>
  </li>
</ul>

<h2 id="트랜잭션-이해">트랜잭션 이해</h2>
<h3 id="트랜잭션---개념-이해">트랜잭션 - 개념 이해</h3>
<ul>
  <li>데이터베이스의 작업 단위, 트랜잭션 단위로 커밋 또는 롤백</li>
  <li>원자성: 트랜잭션 내에서 실행한 작업들은 마치 하나의 작업인 것처럼 모두 성공 하거나 모두 실패해야 한다.</li>
  <li>일관성: 모든 트랜잭션은 일관성 있는 데이터베이스 상태를 유지해야 한다. 예를 들어 데이터베이스에서 정한 무결성 제약 조건을 항상 만족해야 한다.</li>
  <li>격리성: 동시에 실행되는 트랜잭션들이 서로에게 영향을 미치지 않도록 격리한다. 예를 들어 동시에 같은 데이터를 수정하지 못하도록 해야 한다. 격리성은 동시성과 관련된 성능 이슈로 인해 트랜잭션 격리 수준 (Isolation level)을 선택할 수 있다.</li>
  <li>지속성: 트랜잭션을 성공적으로 끝내면 그 결과가 항상 기록되어야 한다. 중간에 시스템에 문제가 발생해도 데이터베이스 로그 등을 사용해서 성공한 트랜잭션 내용을 복구해야 한다.</li>
</ul>

<h4 id="트랜잭션-격리-수준---isolation-level">트랜잭션 격리 수준 - Isolation level</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">READ UNCOMMITED</code>: <code class="language-plaintext highlighter-rouge">DIRTY READ</code> 발생(아직 커밋되지 않은 트랜잭션에서 수정된 데이터가 조회됨)</li>
  <li><code class="language-plaintext highlighter-rouge">READ COMMITTED</code>: <code class="language-plaintext highlighter-rouge">DIRTY READ</code>는 발생하지 않지만 <code class="language-plaintext highlighter-rouge">NON-REPEATABLE READ</code> 발생(중간에 다른 트랜잭션이 커밋 되면 다른 데이터가 조회됨)</li>
  <li><code class="language-plaintext highlighter-rouge">REPEATABLE READ</code>: <code class="language-plaintext highlighter-rouge">NON-REPEATABLE READ</code>는 발생하지 않지만 <code class="language-plaintext highlighter-rouge">PHANTOM READ</code> 발생(다른 트랜잭션에서 커밋 되어 데이터가 추가되면 데이터가 추가되어 새롭게 조회됨)</li>
  <li><code class="language-plaintext highlighter-rouge">SERIALIZABLE</code>: 가장 엄격한 트랜잭션 격리 수준</li>
</ul>

<h4 id="낙관적-락과-비관적-락">낙관적 락과 비관적 락</h4>
<p>JPA의 영속성 컨텍스트를 적절히 활용하면 데이터베이스 트랜잭션이 <code class="language-plaintext highlighter-rouge">READ COMMITTED</code> 수준이어도 <code class="language-plaintext highlighter-rouge">REPEATABLE READ</code>가 가능하다(영속성 컨텍트스는 1차 캐시의 역할을 하므로 엔티티 조회 시 같은 객체를 반환한다). JPA는 데이터베이스 트랜잭션 격리 수준을 <code class="language-plaintext highlighter-rouge">READ COMMITTED</code> 정도로 가정한다. 만약 일부 로직에 더 높은 격리 수준이 필요하면 낙관적 락과 비관적 락 중 하나를 사용하면 된다.</p>

<ul>
  <li>낙관적 락: JPA가 제공하는 버전 관리 기능을 사용한다. 쉽게 이야기해서 애플리케이션이 제공하는 락이다. 낙관적 락은 트랜잭션을 커밋 하기 전까지는 트랜잭션의 충돌을 알 수 없다는 특징이 있다.</li>
  <li>비관적 락: 트랜잭션의 충돌이 발생한다고 가정하고 우선 락을 걸고 보는 방법이다. 이것은 데이터베이스가 제공하는 락 기능을 사용한다.</li>
</ul>

<h4 id="jpa-낙관적-락">JPA 낙관적 락</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">NONE</code>: 락 옵션을 적용하지 않아도 엔티티에 <code class="language-plaintext highlighter-rouge">@Version</code>이 적용된 필드만 있으면 낙관적 락이 적용된다. <code class="language-plaintext highlighter-rouge">두 번의 갱신 분실 문제</code>를 예방한다.</li>
  <li><code class="language-plaintext highlighter-rouge">OPTIMISTIC</code>: 엔티티를 수정할 때뿐만 아니라 조회만 해도 버전을 체크한다. 즉 <code class="language-plaintext highlighter-rouge">DIRTY READ</code>, <code class="language-plaintext highlighter-rouge">NON-REPEATABLE READ</code>를 방지한다.</li>
</ul>

<h4 id="jpa-비관적-락">JPA 비관적 락</h4>
<p>데이터베이스 트랜잭션 락 메커니즘에 의존하는 방법이다. 주로 SQL 쿼리에 <code class="language-plaintext highlighter-rouge">select for update</code> 구문을 사용하고 버전 정보를 이용하지 않는다.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">PESSIMISTIC_WRITE</code>: 데이터베이스에 쓰기 락을 걸때 사용한다. <code class="language-plaintext highlighter-rouge">NON-REPEATABLE READ</code>를 방지한다. 락이 걸린 로우는 다른 트랜잭션이 수정할 수 없다.</li>
</ul>

<h3 id="데이터베이스-연결-구조와-db-세션">데이터베이스 연결 구조와 DB 세션</h3>
<ul>
  <li>사용자는 웹 애플리케이션 서버(WAS)나 DB 접근 툴 같은 클라이언트를 사용해서 데이터베이스 서버에 접근할 수 있다. 클라이언트는 데이터베이스 서버에 연결을 요청하고 커넥션을 맺게 된다. 이때 데이터베이스 서버는 내부에 세션이라는 것을 만든다. 그리고 앞으로 해당 커넥션을 통한 모든 요청은 이 세션을 통해서 실행하게 된다.</li>
  <li>세션은 트랜잭션을 시작하고, 커밋 또는 롤백을 통해 트랜잭션을 종료한다. 그리고 이후에 새로운 트랜잭션을 다시 시작할 수 있다.</li>
  <li>사용자가 커넥션을 닫거나, 또는 DBA(DB 관리자)가 세션을 강제로 종료하면 세션은 종료된다.</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/11.png">
          <img src="/assets/images/post/Spring/db1/11.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="트랜잭션---적용1">트랜잭션 - 적용1</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberServiceV1</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MemberRepositoryV1</span> <span class="n">memberRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accountTransfer</span><span class="o">(</span><span class="nc">String</span> <span class="n">fromId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">toId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">fromMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">fromId</span><span class="o">);</span>
        <span class="nc">Member</span> <span class="n">toMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">toId</span><span class="o">);</span>

        <span class="n">memberRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">fromId</span><span class="o">,</span> <span class="n">fromMember</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">-</span> <span class="n">money</span><span class="o">);</span>
        <span class="n">validation</span><span class="o">(</span><span class="n">toMember</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">toId</span><span class="o">,</span> <span class="n">toMember</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">+</span> <span class="n">money</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">validation</span><span class="o">(</span><span class="nc">Member</span> <span class="n">toMember</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">toMember</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"ex"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"이체중 예외 발생"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MemberServiceV1Test</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_A</span> <span class="o">=</span> <span class="s">"memberA"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_B</span> <span class="o">=</span> <span class="s">"memberB"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_EX</span> <span class="o">=</span> <span class="s">"ex"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">MemberRepositoryV1</span> <span class="n">memberRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">MemberServiceV1</span> <span class="n">memberService</span><span class="o">;</span>

    <span class="nd">@BeforeEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">DriverManagerDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DriverManagerDataSource</span><span class="o">(</span><span class="no">URL</span><span class="o">,</span> <span class="no">USERNAME</span><span class="o">,</span> <span class="no">PASSWORD</span><span class="o">);</span>
        <span class="n">memberRepository</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MemberRepositoryV1</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
        <span class="n">memberService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MemberServiceV1</span><span class="o">(</span><span class="n">memberRepository</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@AfterEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">after</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">MEMBER_A</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">MEMBER_B</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">MEMBER_EX</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accountTransfer</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">memberA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="no">MEMBER_A</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="nc">Member</span> <span class="n">memberB</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="no">MEMBER_B</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">memberA</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">memberB</span><span class="o">);</span>

        <span class="n">memberService</span><span class="o">.</span><span class="na">accountTransfer</span><span class="o">(</span><span class="n">memberA</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">(),</span> <span class="n">memberB</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">(),</span> <span class="mi">2000</span><span class="o">);</span>

        <span class="nc">Member</span> <span class="n">findMemberA</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">memberA</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>
        <span class="nc">Member</span> <span class="n">findMemberB</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">memberB</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMemberA</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">8000</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMemberB</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">12000</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accountTransferEx</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">memberA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="no">MEMBER_A</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="nc">Member</span> <span class="n">memberEx</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="no">MEMBER_EX</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">memberA</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">memberEx</span><span class="o">);</span>

        <span class="n">assertThatThrownBy</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">memberService</span><span class="o">.</span><span class="na">accountTransfer</span><span class="o">(</span><span class="n">memberA</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">(),</span> <span class="n">memberEx</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">(),</span> <span class="mi">2000</span><span class="o">))</span>
                <span class="o">.</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="nc">IllegalStateException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="nc">Member</span> <span class="n">findMemberA</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">memberA</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>
        <span class="nc">Member</span> <span class="n">findMemberB</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">memberEx</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMemberA</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">8000</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMemberB</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="트랜잭션---적용2">트랜잭션 - 적용2</h3>
<ul>
  <li>트랜잭션은 비즈니스 로직이 있는 서비스 계층에서 시작해야 한다. 비즈니스 로직이 잘못되면 해당 비즈니스 로직으로 인해 문제가 되는 부분을 함께 롤백해야 하기 때문이다.</li>
  <li>그런데 트랜잭션을 시작하려면 커넥션이 필요하다. 결국 서비스 계층에서 커넥션을 만들고, 트랜잭션 커밋 이후에 커넥션을 종료해야 한다.</li>
  <li>애플리케이션에서 DB 트랜잭션을 사용하려면 트랜잭션을 사용하는 동안 같은 커넥션을 유지해야한다. 그래야 같은 세션을 사용할 수 있다.</li>
  <li>애플리케이션에서 같은 커넥션을 유지하는 가장 단순한 방법은 커넥션을 파라미터로 전달해서 같은 커넥션이 사용되도록 유지하는 것이다.</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/12.png">
          <img src="/assets/images/post/Spring/db1/12.png" alt="" />
      </a>
    
  
  
</figure>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRepositoryV2</span> <span class="o">{</span>

    <span class="o">...</span>

    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">String</span> <span class="n">memberId</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from member where member_id = ?"</span><span class="o">;</span>

        <span class="nc">PreparedStatement</span> <span class="n">pstmt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">pstmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">memberId</span><span class="o">);</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">pstmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">();</span>
                <span class="n">member</span><span class="o">.</span><span class="na">setMemberId</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"member_id"</span><span class="o">));</span>
                <span class="n">member</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"money"</span><span class="o">));</span>

                <span class="k">return</span> <span class="n">member</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">(</span><span class="s">"member not found memberId="</span> <span class="o">+</span> <span class="n">memberId</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"db error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// con 닫으면 안됨</span>
            <span class="nc">JdbcUtils</span><span class="o">.</span><span class="na">closeResultSet</span><span class="o">(</span><span class="n">rs</span><span class="o">);</span>
            <span class="nc">JdbcUtils</span><span class="o">.</span><span class="na">closeStatement</span><span class="o">(</span><span class="n">pstmt</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">String</span> <span class="n">memberId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"update member set money=? where member_id=?"</span><span class="o">;</span>

        <span class="nc">PreparedStatement</span> <span class="n">pstmt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">pstmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">memberId</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">resultSize</span> <span class="o">=</span> <span class="n">pstmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"db error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// con 닫으면 안됨</span>
            <span class="nc">JdbcUtils</span><span class="o">.</span><span class="na">closeStatement</span><span class="o">(</span><span class="n">pstmt</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberServiceV2</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span> <span class="c1">// 비즈니스 계층에서 커넥션을 가져와서 같은 커넥션을 유지해야 트랜잭션 유지가 가능하므로 의존성 주입 필요함</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MemberRepositoryV2</span> <span class="n">memberRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accountTransfer</span><span class="o">(</span><span class="nc">String</span> <span class="n">fromId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">toId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//트랜잭션 시작</span>
            <span class="n">con</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="c1">// 비즈니스 로직</span>
            <span class="n">bizLogic</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">fromId</span><span class="o">,</span> <span class="n">toId</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>

            <span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span> <span class="c1">// 성공시 커밋</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span> <span class="c1">// 실패시 롤백</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">release</span><span class="o">(</span><span class="n">con</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">bizLogic</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">String</span> <span class="n">fromId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">toId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">fromMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">fromId</span><span class="o">);</span>
        <span class="nc">Member</span> <span class="n">toMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">toId</span><span class="o">);</span>

        <span class="n">memberRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">fromId</span><span class="o">,</span> <span class="n">fromMember</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">-</span> <span class="n">money</span><span class="o">);</span>
        <span class="n">validation</span><span class="o">(</span><span class="n">toMember</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">toId</span><span class="o">,</span> <span class="n">toMember</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">+</span> <span class="n">money</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">validation</span><span class="o">(</span><span class="nc">Member</span> <span class="n">toMember</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">toMember</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"ex"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"이체중 예외 발생"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">release</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">con</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">con</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span> <span class="c1">// 커넥션 풀 고려</span>
                <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>먼저 Service 계층에서 커넥션을 가져오고 해당 커넥션을 하나의 트랜잭션에서 계속 재활용한다. 즉 서비스 로직에서 같은 커넥션을 파라미터로 넘겨주어야 한다.</li>
  <li>커넥션 유지가 필요한 두 메서드는 파라미터로 넘어온 커넥션을 사용해야 한다. 따라서 Repository에 <code class="language-plaintext highlighter-rouge">con = getConnection()</code> 코드가 있으면 안된다.</li>
  <li>커넥션 유지가 필요한 두 메서드는 리포지토리에서 커넥션을 닫으면 안된다. 커넥션을 전달 받은 리포지토리 뿐만 아니라 이후에도 커넥션을 계속 이어서 사용하기 때문이다. 이후 서비스 로직이 끝날 때 트랜잭션을 종료하고 닫아야 한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MemberServiceV2Test</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_A</span> <span class="o">=</span> <span class="s">"memberA"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_B</span> <span class="o">=</span> <span class="s">"memberB"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_EX</span> <span class="o">=</span> <span class="s">"ex"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">MemberRepositoryV2</span> <span class="n">memberRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">MemberServiceV2</span> <span class="n">memberService</span><span class="o">;</span>

    <span class="nd">@BeforeEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">DriverManagerDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DriverManagerDataSource</span><span class="o">(</span><span class="no">URL</span><span class="o">,</span> <span class="no">USERNAME</span><span class="o">,</span> <span class="no">PASSWORD</span><span class="o">);</span>
        <span class="n">memberRepository</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MemberRepositoryV2</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
        <span class="n">memberService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MemberServiceV2</span><span class="o">(</span><span class="n">dataSource</span><span class="o">,</span> <span class="n">memberRepository</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@AfterEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">after</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">MEMBER_A</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">MEMBER_B</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">MEMBER_EX</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accountTransfer</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">memberA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="no">MEMBER_A</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="nc">Member</span> <span class="n">memberB</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="no">MEMBER_B</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">memberA</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">memberB</span><span class="o">);</span>

        <span class="n">memberService</span><span class="o">.</span><span class="na">accountTransfer</span><span class="o">(</span><span class="n">memberA</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">(),</span> <span class="n">memberB</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">(),</span> <span class="mi">2000</span><span class="o">);</span>

        <span class="nc">Member</span> <span class="n">findMemberA</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">memberA</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>
        <span class="nc">Member</span> <span class="n">findMemberB</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">memberB</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMemberA</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">8000</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMemberB</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">12000</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accountTransferEx</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">memberA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="no">MEMBER_A</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="nc">Member</span> <span class="n">memberEx</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="no">MEMBER_EX</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">memberA</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">memberEx</span><span class="o">);</span>

        <span class="n">assertThatThrownBy</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">memberService</span><span class="o">.</span><span class="na">accountTransfer</span><span class="o">(</span><span class="n">memberA</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">(),</span> <span class="n">memberEx</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">(),</span> <span class="mi">2000</span><span class="o">))</span>
                <span class="o">.</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="nc">IllegalStateException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="nc">Member</span> <span class="n">findMemberA</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">memberA</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>
        <span class="nc">Member</span> <span class="n">findMemberB</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">memberEx</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMemberA</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMemberB</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>애플리케이션에서 DB 트랜잭션을 적용하려면 서비스 계층이 매우 지저분해지고, 생각보다 매우 복잡한 코드를 요구한다. 추가로 커넥션을 유지하도록 <code class="language-plaintext highlighter-rouge">con</code>을 파라미터로 받는 메서드로 코드를 변경하는 것도 쉬운 일은 아니다.</li>
</ul>

<h2 id="스프링과-문제-해결---트랜잭션">스프링과 문제 해결 - 트랜잭션</h2>
<h3 id="문제점들">문제점들</h3>
<h4 id="트랜잭션-문제">트랜잭션 문제</h4>
<ul>
  <li>JDBC 구현 기술이 서비스 계층에 누수되는 문제
    <ul>
      <li>트랜잭션을 적용하기 위해 JDBC 구현 기술이 서비스 계층에 누수되었다.</li>
      <li>서비스 계층은 순수해야 한다. 구현 기술을 변경해도 서비스 계층 코드는 최대한 유지할 수 있어야 한다. (변화에 대응)그래서 데이터 접근 계층에 JDBC 코드를 다 몰아두는 것이다. 물론 데이터 접근 계층의 구현 기술이 변경될 수도 있으니 데이터 접근 계층은 인터페이스를 제공하는 것이 좋다.</li>
      <li>서비스 계층은 특정 기술에 종속되지 않아야 한다. 지금까지 그렇게 노력해서 데이터 접근 계층으로 JDBC 관련 코드를 모았는데, 트랜잭션을 적용하면서 결국 서비스 계층에 JDBC 구현 기술의 누수가 발생했다.</li>
    </ul>
  </li>
  <li>트랜잭션 동기화 문제
    <ul>
      <li>같은 트랜잭션을 유지하기 위해 커넥션을 파라미터로 넘겨야 한다.</li>
      <li>이때 파생되는 문제들도 있다. 똑같은 기능도 트랜잭션용 기능과 트랜잭션을 유지하지 않아도 되는 기능으로 분리해야 한다.</li>
    </ul>
  </li>
  <li>트랜잭션 적용 반복 문제
    <ul>
      <li>트랜잭션 적용 코드를 보면 반복이 많다. <code class="language-plaintext highlighter-rouge">try</code> , <code class="language-plaintext highlighter-rouge">catch</code> , <code class="language-plaintext highlighter-rouge">finally</code> …</li>
    </ul>
  </li>
</ul>

<h4 id="예외-누수">예외 누수</h4>
<ul>
  <li>데이터 접근 계층의 JDBC 구현 기술 예외가 서비스 계층으로 전파된다.</li>
  <li><code class="language-plaintext highlighter-rouge">SQLException</code> 은 체크 예외이기 때문에 데이터 접근 계층을 호출한 서비스 계층에서 해당 예외를 잡아서 처리하거나 명시적으로 <code class="language-plaintext highlighter-rouge">throws</code> 를 통해서 다시 밖으로 던져야한다.</li>
  <li><code class="language-plaintext highlighter-rouge">SQLException</code> 은 JDBC 전용 기술이다. 향후 JPA나 다른 데이터 접근 기술을 사용하면, 그에 맞는 다른 예외로 변경해야 하고, 결국 서비스 코드도 수정해야 한다.</li>
</ul>

<h4 id="jdbc-반복-문제">JDBC 반복 문제</h4>
<ul>
  <li>지금까지 작성한 <code class="language-plaintext highlighter-rouge">MemberRepository</code> 코드는 순수한 JDBC를 사용했다.</li>
  <li>이 코드들은 유사한 코드의 반복이 너무 많다.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">try</code> , <code class="language-plaintext highlighter-rouge">catch</code> , <code class="language-plaintext highlighter-rouge">finally</code> …</li>
      <li>커넥션을 열고, <code class="language-plaintext highlighter-rouge">PreparedStatement</code> 를 사용하고, 결과를 매핑하고… 실행하고, 커넥션과 리소스를 정리한다.</li>
    </ul>
  </li>
</ul>

<h3 id="트랜잭션-추상화">트랜잭션 추상화</h3>
<ul>
  <li>현재 서비스 계층은 트랜잭션을 사용하기 위해서 JDBC 기술에 의존하고 있다. 향후 JDBC에서 JPA 같은 다른 데이터 접근 기술로 변경하면, 서비스 계층의 트랜잭션 관련 코드도 모두 함께 수정해야 한다. 구현 기술마다 트랜잭션을 사용하는 방법이 다르다.</li>
</ul>

<figure class="half ">
  
    
      <a href="/assets/images/post/Spring/db1/13.png">
          <img src="/assets/images/post/Spring/db1/13.png" alt="" />
      </a>
    
  
    
      <a href="/assets/images/post/Spring/db1/14.png">
          <img src="/assets/images/post/Spring/db1/14.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>이 문제를 해결하려면 트랜잭션 기능을 추상화하면 된다.</li>
  <li>서비스는 특정 트랜잭션 기술에 직접 의존하는 것이 아니라, <code class="language-plaintext highlighter-rouge">TxManager</code> 라는 추상화된 인터페이스에 의존한다. 이제 원하는 구현체를 DI를 통해서 주입하면 된다. 예를 들어서 JDBC 트랜잭션 기능이 필요하면 <code class="language-plaintext highlighter-rouge">JdbcTxManager</code> 를 서비스에 주입하고, JPA 트랜잭션 기능으로 변경해야 하면 <code class="language-plaintext highlighter-rouge">JpaTxManager</code> 를 주입하면 된다.</li>
  <li>클라이언트인 서비스는 인터페이스에 의존하고 DI를 사용한 덕분에 OCP 원칙을 지키게 되었다. 이제 트랜잭션을 사용하는 서비스 코드를 전혀 변경하지 않고, 트랜잭션 기술을 마음껏 변경할 수 있다.</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/15.png">
          <img src="/assets/images/post/Spring/db1/15.png" alt="" />
      </a>
    
  
  
</figure>

<h4 id="스프링의-트랜잭션-추상화">스프링의 트랜잭션 추상화</h4>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/16.png">
          <img src="/assets/images/post/Spring/db1/16.png" alt="" />
      </a>
    
  
  
</figure>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PlatformTransactionManager</span> <span class="kd">extends</span> <span class="nc">TransactionManager</span> <span class="o">{</span>

	<span class="nc">TransactionStatus</span> <span class="nf">getTransaction</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">TransactionDefinition</span> <span class="n">definition</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">TransactionException</span><span class="o">;</span>

	<span class="kt">void</span> <span class="nf">commit</span><span class="o">(</span><span class="nc">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">TransactionException</span><span class="o">;</span>

	<span class="kt">void</span> <span class="nf">rollback</span><span class="o">(</span><span class="nc">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">TransactionException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="트랜잭션-동기화">트랜잭션 동기화</h3>
<p>트랜잭션을 유지하려면 트랜잭션의 시작부터 끝까지 같은 데이터베이스 커넥션을 유지해아한다. 결국 같은 커넥션을 동기화(맞추어 사용)하기 위해서 이전에는 파라미터로 커넥션을 전달하는 방법을 사용했다. 파라미터로 커넥션을 전달하는 방법은 코드가 지저분해지는 것은 물론이고, 커넥션을 넘기는 메서드와 넘기지 않는 메서드를 중복해서 만들어야 하는 등 여러가지 단점들이 많다.</p>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/17.png">
          <img src="/assets/images/post/Spring/db1/17.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>스프링은 트랜잭션 동기화 매니저를 제공한다(<code class="language-plaintext highlighter-rouge">TransactionSynchronizationManager</code>). 이것은 쓰레드 로컬( <code class="language-plaintext highlighter-rouge">ThreadLocal</code> )을 사용해서 커넥션을 동기화해준다. 트랜잭션 매니저는 내부에서 이 트랜잭션 동기화 매니저를 사용한다.</li>
  <li>트랜잭션 동기화 매니저는 쓰레드 로컬을 사용하기 때문에 멀티쓰레드 상황에 안전하게 커넥션을 동기화 할 수 있다. 따라서 커넥션이 필요하면 트랜잭션 동기화 매니저를 통해 커넥션을 획득하면 된다. 따라서 이전처럼 파라미터로 커넥션을 전달하지 않아도 된다.</li>
</ul>

<h4 id="workflow">workflow</h4>
<ol>
  <li>트랜잭션을 시작하려면 커넥션이 필요하다. 트랜잭션 매니저는 데이터소스를 통해 커넥션을 만들고 트랜잭션을 시작한다.</li>
  <li>트랜잭션 매니저는 트랜잭션이 시작된 커넥션을 트랜잭션 동기화 매니저에 보관한다.</li>
  <li>리포지토리는 트랜잭션 동기화 매니저에 보관된 커넥션을 꺼내서 사용한다. 따라서 파라미터로 커넥션을 전달하지 않아도 된다.</li>
  <li>트랜잭션이 종료되면 트랜잭션 매니저는 트랜잭션 동기화 매니저에 보관된 커넥션을 통해 트랜잭션을 종료하고, 커넥션도 닫는다.</li>
</ol>

<h3 id="트랜잭션-문제-해결---트랜잭션-매니저">트랜잭션 문제 해결 - 트랜잭션 매니저</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRepositoryV3</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into member(member_id, money) values(?, ?)"</span><span class="o">;</span>

        <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">PreparedStatement</span> <span class="n">pstmt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">getConnection</span><span class="o">();</span>
            <span class="n">pstmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getMoney</span><span class="o">());</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>

            <span class="k">return</span> <span class="n">member</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"db error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">pstmt</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from member where member_id = ?"</span><span class="o">;</span>

        <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">PreparedStatement</span> <span class="n">pstmt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">getConnection</span><span class="o">();</span>
            <span class="n">pstmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">memberId</span><span class="o">);</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">pstmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">();</span>
                <span class="n">member</span><span class="o">.</span><span class="na">setMemberId</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"member_id"</span><span class="o">));</span>
                <span class="n">member</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"money"</span><span class="o">));</span>

                <span class="k">return</span> <span class="n">member</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">(</span><span class="s">"member not found memberId="</span> <span class="o">+</span> <span class="n">memberId</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"db error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">pstmt</span><span class="o">,</span> <span class="n">rs</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"update member set money=? where member_id=?"</span><span class="o">;</span>

        <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">PreparedStatement</span> <span class="n">pstmt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">getConnection</span><span class="o">();</span>
            <span class="n">pstmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">memberId</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">resultSize</span> <span class="o">=</span> <span class="n">pstmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"db error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">pstmt</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"delete from member where member_id=?"</span><span class="o">;</span>

        <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">PreparedStatement</span> <span class="n">pstmt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">getConnection</span><span class="o">();</span>
            <span class="n">pstmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">memberId</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"db error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">pstmt</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">Statement</span> <span class="n">stmt</span><span class="o">,</span> <span class="nc">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">JdbcUtils</span><span class="o">.</span><span class="na">closeResultSet</span><span class="o">(</span><span class="n">rs</span><span class="o">);</span>
        <span class="nc">JdbcUtils</span><span class="o">.</span><span class="na">closeStatement</span><span class="o">(</span><span class="n">stmt</span><span class="o">);</span>
        <span class="c1">// 트랜잭션 동기화를 사용하려면 DataSourceUtils를 사용해야 한다.</span>
        <span class="nc">DataSourceUtils</span><span class="o">.</span><span class="na">releaseConnection</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="c1">// 트랜잭션 동기화를 사용하려면 DataSourceUtils를 사용해야 한다.</span>
        <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="nc">DataSourceUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"get connection={}, class={}"</span><span class="o">,</span> <span class="n">con</span><span class="o">,</span> <span class="n">con</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">con</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>커넥션을 파라미터로 전달하는 부분이 모두 제거되었다.</li>
  <li><code class="language-plaintext highlighter-rouge">DataSourceUtils.getConnection()</code>
    <ul>
      <li>트랜잭션 동기화 매니저가 관리하는 커넥션이 있으면 해당 커넥션을 반환한다.</li>
      <li>트랜잭션 동기화 매니저가 관리하는 커넥션이 없는 경우 새로운 커넥션을 생성해서 반환한다.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">DataSourceUtils.releaseConnection()</code>
    <ul>
      <li>커넥션을 <code class="language-plaintext highlighter-rouge">con.close()</code> 를 사용해서 직접 닫아버리면 커넥션이 유지되지 않는 문제가 발생한다. 이 커넥션은 이후 로직은 물론이고, 트랜잭션을 종료(커밋, 롤백)할 때 까지 살아있어야 한다.</li>
      <li>트랜잭션을 사용하기 위해 동기화된 커넥션은 커넥션을 닫지 않고 그대로 유지해준다.</li>
      <li>트랜잭션 동기화 매니저가 관리하는 커넥션이 없는 경우 해당 커넥션을 닫는다.</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberServiceV3_1</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">PlatformTransactionManager</span> <span class="n">transactionManager</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MemberRepositoryV3</span> <span class="n">memberRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accountTransfer</span><span class="o">(</span><span class="nc">String</span> <span class="n">fromId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">toId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">TransactionStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">transactionManager</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">(</span><span class="k">new</span> <span class="nc">DefaultTransactionDefinition</span><span class="o">());</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 비즈니스 로직</span>
            <span class="n">bizLogic</span><span class="o">(</span><span class="n">fromId</span><span class="o">,</span> <span class="n">toId</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>

            <span class="n">transactionManager</span><span class="o">.</span><span class="na">commit</span><span class="o">(</span><span class="n">status</span><span class="o">);</span> <span class="c1">// 성공시 커밋</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">transactionManager</span><span class="o">.</span><span class="na">rollback</span><span class="o">(</span><span class="n">status</span><span class="o">);</span> <span class="c1">// 실패시 롤백</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">bizLogic</span><span class="o">(</span><span class="nc">String</span> <span class="n">fromId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">toId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">fromMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">fromId</span><span class="o">);</span>
        <span class="nc">Member</span> <span class="n">toMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">toId</span><span class="o">);</span>

        <span class="n">memberRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">fromId</span><span class="o">,</span> <span class="n">fromMember</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">-</span> <span class="n">money</span><span class="o">);</span>
        <span class="n">validation</span><span class="o">(</span><span class="n">toMember</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">toId</span><span class="o">,</span> <span class="n">toMember</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">+</span> <span class="n">money</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">validation</span><span class="o">(</span><span class="nc">Member</span> <span class="n">toMember</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">toMember</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"ex"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"이체중 예외 발생"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">private final PlatformTransactionManager transactionManager</code>
    <ul>
      <li>트랜잭션 매니저를 주입 받는다. 지금은 JDBC 기술을 사용하기 때문에 <code class="language-plaintext highlighter-rouge">DataSourceTransactionManager</code> 구현체를 주입 받아야 한다.</li>
      <li>물론 JPA 같은 기술로 변경되면 <code class="language-plaintext highlighter-rouge">JpaTransactionManager</code> 를 주입 받으면 된다.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">transactionManager.getTransaction()</code>
    <ul>
      <li>트랜잭션을 시작한다.</li>
      <li><code class="language-plaintext highlighter-rouge">TransactionStatus status</code> 를 반환한다. 현재 트랜잭션의 상태 정보가 포함되어 있다. 이후 트랜잭션을 커밋, 롤백할 때 필요하다.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">new DefaultTransactionDefinition()</code>
    <ul>
      <li>트랜잭션과 관련된 옵션을 지정할 수 있다.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">transactionManager.commit(status)</code>
    <ul>
      <li>트랜잭션이 성공하면 이 로직을 호출해서 커밋하면 된다.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">transactionManager.rollback(status)</code>
    <ul>
      <li>문제가 발생하면 이 로직을 호출해서 트랜잭션을 롤백하면 된다.</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MemberServiceV3_1Test</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_A</span> <span class="o">=</span> <span class="s">"memberA"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_B</span> <span class="o">=</span> <span class="s">"memberB"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_EX</span> <span class="o">=</span> <span class="s">"ex"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">MemberRepositoryV3</span> <span class="n">memberRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">MemberServiceV3_1</span> <span class="n">memberService</span><span class="o">;</span>

    <span class="nd">@BeforeEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">DriverManagerDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DriverManagerDataSource</span><span class="o">(</span><span class="no">URL</span><span class="o">,</span> <span class="no">USERNAME</span><span class="o">,</span> <span class="no">PASSWORD</span><span class="o">);</span>
        <span class="n">memberRepository</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MemberRepositoryV3</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
        <span class="nc">PlatformTransactionManager</span> <span class="n">transactionManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
        <span class="n">memberService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MemberServiceV3_1</span><span class="o">(</span><span class="n">transactionManager</span><span class="o">,</span> <span class="n">memberRepository</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@AfterEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">after</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">MEMBER_A</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">MEMBER_B</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">MEMBER_EX</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">new DataSourceTransactionManager(dataSource)</code>
    <ul>
      <li>JDBC 기술을 사용하므로, JDBC용 트랜잭션 매니저( <code class="language-plaintext highlighter-rouge">DataSourceTransactionManager</code> )를 선택해서 서비스에 주입한다.</li>
      <li>트랜잭션 매니저는 데이터소스를 통해 커넥션을 생성하므로 <code class="language-plaintext highlighter-rouge">DataSource</code> 가 필요하다.</li>
    </ul>
  </li>
</ul>

<h4 id="workflow-1">workflow</h4>
<ol>
  <li>서비스 계층에서 <code class="language-plaintext highlighter-rouge">transactionManager.getTransaction()</code> 을 호출해서 트랜잭션을 시작한다.</li>
  <li>트랜잭션을 시작하려면 먼저 데이터베이스 커넥션이 필요하다. 트랜잭션 매니저는 내부에서 <code class="language-plaintext highlighter-rouge">데이터소스</code>를 사용해서 커넥션을 생성한다.</li>
  <li>커넥션을 수동 커밋 모드로 변경해서 실제 데이터베이스 트랜잭션을 시작한다.</li>
  <li>커넥션을 트랜잭션 동기화 매니저에 보관한다.</li>
  <li>트랜잭션 동기화 매니저는 <code class="language-plaintext highlighter-rouge">쓰레드 로컬</code>에 커넥션을 보관한다. 따라서 멀티 쓰레드 환경에 안전하게 커넥션을 보관할 수 있다.</li>
  <li>서비스는 비즈니스 로직을 실행하면서 리포지토리의 메서드들을 호출한다. 이때 커넥션을 파라미터로 전달하지 않는다.</li>
  <li>리포지토리 메서드들은 트랜잭션이 시작된 커넥션이 필요하다. 리포지토리는 <code class="language-plaintext highlighter-rouge">DataSourceUtils.getConnection()</code> 을 사용해서 트랜잭션 동기화 매니저에 보관된 커넥션을 꺼내서 사용한다. 이 과정을 통해서 자연스럽게 같은 커넥션을 사용하고, 트랜잭션도 유지된다.</li>
  <li>획득한 커넥션을 사용해서 SQL을 데이터베이스에 전달해서 실행한다.</li>
  <li>비즈니스 로직이 끝나고 트랜잭션을 종료한다. 트랜잭션은 커밋하거나 롤백하면 종료된다.</li>
  <li>트랜잭션을 종료하려면 동기화된 커넥션이 필요하다. 트랜잭션 동기화 매니저를 통해 동기화된 커넥션을 획득한다.</li>
  <li>획득한 커넥션을 통해 데이터베이스에 트랜잭션을 커밋하거나 롤백한다.</li>
  <li>전체 리소스를 정리한다.
    <ul>
      <li>트랜잭션 동기화 매니저를 정리한다. <code class="language-plaintext highlighter-rouge">쓰레드 로컬</code>은 사용후 꼭 정리해야 한다. <code class="language-plaintext highlighter-rouge">con.setAutoCommit(true)</code> 로 되돌린다. 커넥션 풀을 고려해야 한다.</li>
      <li><code class="language-plaintext highlighter-rouge">con.close()</code> 를 호출해셔 커넥션을 종료한다. 커넥션 풀을 사용하는 경우 <code class="language-plaintext highlighter-rouge">con.close()</code> 를 호출하면 커넥션 풀에 반환된다.</li>
    </ul>
  </li>
</ol>

<h3 id="트랜잭션-문제-해결---트랜잭션-템플릿">트랜잭션 문제 해결 - 트랜잭션 템플릿</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberServiceV3_2</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TransactionTemplate</span> <span class="n">txTemplate</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MemberRepositoryV3</span> <span class="n">memberRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MemberServiceV3_2</span><span class="o">(</span><span class="nc">PlatformTransactionManager</span> <span class="n">transactionManager</span><span class="o">,</span> <span class="nc">MemberRepositoryV3</span> <span class="n">memberRepository</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">txTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TransactionTemplate</span><span class="o">(</span><span class="n">transactionManager</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">memberRepository</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accountTransfer</span><span class="o">(</span><span class="nc">String</span> <span class="n">fromId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">toId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="n">txTemplate</span><span class="o">.</span><span class="na">executeWithoutResult</span><span class="o">((</span><span class="n">status</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">bizLogic</span><span class="o">(</span><span class="n">fromId</span><span class="o">,</span> <span class="n">toId</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">bizLogic</span><span class="o">(</span><span class="nc">String</span> <span class="n">fromId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">toId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">fromMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">fromId</span><span class="o">);</span>
        <span class="nc">Member</span> <span class="n">toMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">toId</span><span class="o">);</span>

        <span class="n">memberRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">fromId</span><span class="o">,</span> <span class="n">fromMember</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">-</span> <span class="n">money</span><span class="o">);</span>
        <span class="n">validation</span><span class="o">(</span><span class="n">toMember</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">toId</span><span class="o">,</span> <span class="n">toMember</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">+</span> <span class="n">money</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">validation</span><span class="o">(</span><span class="nc">Member</span> <span class="n">toMember</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">toMember</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"ex"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"이체중 예외 발생"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>템플릿 콜백 패턴을 사용하여 트랜잭션을 시작하고 커밋 하거나 롤백 하는 로직을 한 번 더 추상화하였다. 즉 트랜잭션 기능을 사용하는 클라이언트는 서비스 로직만 람다식을 통해 콜백으로 넘겨주면 된다.</li>
  <li>트랜잭션 템플릿 덕분에 트랜잭션을 시작하고, 커밋하거나 롤백하는 코드가 모두 제거되었다.</li>
  <li>트랜잭션 템플릿의 기본 동작은 다음과 같다.
    <ul>
      <li>비즈니스 로직이 정상 수행되면 커밋한다.</li>
      <li>언체크 예외가 발생하면 롤백한다. 그 외의 경우 커밋한다.</li>
    </ul>
  </li>
  <li>코드에서 예외를 처리하기 위해 <code class="language-plaintext highlighter-rouge">try~catch</code> 가 들어갔는데, <code class="language-plaintext highlighter-rouge">bizLogic()</code> 메서드를 호출하면 <code class="language-plaintext highlighter-rouge">SQLException</code> 체크 예외를 넘겨준다. 해당 람다에서 체크 예외를 밖으로 던질 수 없기 때문에 언체크 예외로 바꾸어 던지도록 예외를 전환했다.</li>
  <li>하지만 이곳은 서비스 로직인데 비즈니스 로직 뿐만 아니라 트랜잭션을 처리하는 기술 로직이 함께 포함되어 있다.</li>
  <li>애플리케이션을 구성하는 로직을 핵심 기능과 부가 기능으로 구분하자면 서비스 입장에서 비즈니스 로직은 핵심 기능이고, 트랜잭션은 부가 기능이다.</li>
  <li>이렇게 비즈니스 로직과 트랜잭션을 처리하는 기술 로직이 한 곳에 있으면 두 관심사를 하나의 클래스에서 처리하게 된다. 결과적으로 코드를 유지보수하기 어려워진다.</li>
</ul>

<h3 id="트랜잭션-문제-해결---트랜잭션-aop-이해">트랜잭션 문제 해결 - 트랜잭션 AOP 이해</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/18.png">
          <img src="/assets/images/post/Spring/db1/18.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>스프링이 제공하는 AOP 기능을 사용하면 프록시를 매우 편리하게 적용할 수 있다.</li>
  <li>물론 스프링 AOP를 직접 사용해서 트랜잭션을 처리해도 되지만, 트랜잭션은 매우 중요한 기능이고, 전세계 누구나 다 사용하는 기능이다. 스프링은 트랜잭션 AOP를 처리하기 위한 모든 기능을 제공한다. 스프링 부트를 사용하면 트랜잭션 AOP를 처리하기 위해 필요한 스프링 빈들도 자동으로 등록해준다.</li>
  <li>개발자는 트랜잭션 처리가 필요한 곳에 <code class="language-plaintext highlighter-rouge">@Transactional</code> 애노테이션만 붙여주면 된다. 스프링의 트랜잭션 AOP는 이 애노테이션을 인식해서 트랜잭션 프록시를 적용해준다.</li>
</ul>

<h3 id="트랜잭션-문제-해결---트랜잭션-aop-적용">트랜잭션 문제 해결 - 트랜잭션 AOP 적용</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberServiceV3_3</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MemberRepositoryV3</span> <span class="n">memberRepository</span><span class="o">;</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accountTransfer</span><span class="o">(</span><span class="nc">String</span> <span class="n">fromId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">toId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="n">bizLogic</span><span class="o">(</span><span class="n">fromId</span><span class="o">,</span> <span class="n">toId</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">bizLogic</span><span class="o">(</span><span class="nc">String</span> <span class="n">fromId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">toId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">fromMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">fromId</span><span class="o">);</span>
        <span class="nc">Member</span> <span class="n">toMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">toId</span><span class="o">);</span>

        <span class="n">memberRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">fromId</span><span class="o">,</span> <span class="n">fromMember</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">-</span> <span class="n">money</span><span class="o">);</span>
        <span class="n">validation</span><span class="o">(</span><span class="n">toMember</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">toId</span><span class="o">,</span> <span class="n">toMember</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">+</span> <span class="n">money</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">validation</span><span class="o">(</span><span class="nc">Member</span> <span class="n">toMember</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">toMember</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"ex"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"이체중 예외 발생"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">@Transactional</code> 애노테이션은 메서드에 붙여도 되고, 클래스에 붙여도 된다. 클래스에 붙이면 외부에서 호출 가능한 <code class="language-plaintext highlighter-rouge">public</code> 메서드가 AOP 적용 대상이 된다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootTest</span>
<span class="nd">@Slf4j</span>
<span class="kd">class</span> <span class="nc">MemberServiceV3_3Test</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_A</span> <span class="o">=</span> <span class="s">"memberA"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_B</span> <span class="o">=</span> <span class="s">"memberB"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_EX</span> <span class="o">=</span> <span class="s">"ex"</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MemberRepositoryV3</span> <span class="n">memberRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">MemberServiceV3_3</span> <span class="n">memberService</span><span class="o">;</span>

    <span class="nd">@AfterEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">after</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">MEMBER_A</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">MEMBER_B</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">MEMBER_EX</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">AopCheck</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"memberService class={}"</span><span class="o">,</span> <span class="n">memberService</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"memberRepository class={}"</span><span class="o">,</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="nc">AopUtils</span><span class="o">.</span><span class="na">isAopProxy</span><span class="o">(</span><span class="n">memberService</span><span class="o">)).</span><span class="na">isTrue</span><span class="o">();</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="nc">AopUtils</span><span class="o">.</span><span class="na">isAopProxy</span><span class="o">(</span><span class="n">memberRepository</span><span class="o">)).</span><span class="na">isFalse</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accountTransfer</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">memberA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="no">MEMBER_A</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="nc">Member</span> <span class="n">memberB</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="no">MEMBER_B</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">memberA</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">memberB</span><span class="o">);</span>

        <span class="n">memberService</span><span class="o">.</span><span class="na">accountTransfer</span><span class="o">(</span><span class="n">memberA</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">(),</span> <span class="n">memberB</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">(),</span> <span class="mi">2000</span><span class="o">);</span>

        <span class="nc">Member</span> <span class="n">findMemberA</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">memberA</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>
        <span class="nc">Member</span> <span class="n">findMemberB</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">memberB</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMemberA</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">8000</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMemberB</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">12000</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accountTransferEx</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">memberA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="no">MEMBER_A</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="nc">Member</span> <span class="n">memberEx</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="no">MEMBER_EX</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">memberA</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">memberEx</span><span class="o">);</span>

        <span class="n">assertThatThrownBy</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">memberService</span><span class="o">.</span><span class="na">accountTransfer</span><span class="o">(</span><span class="n">memberA</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">(),</span> <span class="n">memberEx</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">(),</span> <span class="mi">2000</span><span class="o">))</span>
                <span class="o">.</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="nc">IllegalStateException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="nc">Member</span> <span class="n">findMemberA</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">memberA</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>
        <span class="nc">Member</span> <span class="n">findMemberB</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">memberEx</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">());</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMemberA</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMemberB</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@TestConfiguration</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TestConfig</span> <span class="o">{</span>
        <span class="nd">@Bean</span>
        <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">DriverManagerDataSource</span><span class="o">(</span><span class="no">URL</span><span class="o">,</span> <span class="no">USERNAME</span><span class="o">,</span> <span class="no">PASSWORD</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Bean</span>
        <span class="nc">PlatformTransactionManager</span> <span class="nf">transactionManager</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="nd">@Bean</span>
        <span class="nc">MemberRepositoryV3</span> <span class="nf">memberRepositoryV3</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">MemberRepositoryV3</span><span class="o">(</span><span class="n">dataSource</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="nd">@Bean</span>
        <span class="n">MemberServiceV3_3</span> <span class="nf">memberServiceV3_3</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">MemberServiceV3_3</span><span class="o">(</span><span class="n">memberRepositoryV3</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">@SpringBootTest</code> : 스프링 AOP를 적용하려면 스프링 컨테이너가 필요하다. 이 애노테이션이 있으면 테스트시 스프링 부트를 통해 스프링 컨테이너를 생성한다. 그리고 테스트에서 <code class="language-plaintext highlighter-rouge">@Autowired</code> 등을 통해 스프링 컨테이너가 관리하는 빈들을 사용할 수 있다.</li>
  <li><code class="language-plaintext highlighter-rouge">@TestConfiguration</code> : 테스트 안에서 내부 설정 클래스를 만들어서 사용하면서 이 에노테이션을 붙이면, 스프링 부트가 자동으로 만들어주는 빈들에 추가로 필요한 스프링 빈들을 등록하고 테스트를 수행할 수 있다.</li>
  <li><code class="language-plaintext highlighter-rouge">TestConfig</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DataSource</code> : 스프링에서 기본으로 사용할 데이터소스를 스프링 빈으로 등록한다. 추가로 <code class="language-plaintext highlighter-rouge">트랜잭션 매니저</code>에서도 사용한다.</li>
      <li><code class="language-plaintext highlighter-rouge">DataSourceTransactionManager</code> : 트랜잭션 매니저를 스프링 빈으로 등록한다. 스프링이 제공하는 트랜잭션 AOP는 스프링 빈에 등록된 트랜잭션 매니저를 찾아서 사용하기 때문에 트랜잭션 매니저를 스프링 빈으로 등록해두어야 한다.</li>
    </ul>
  </li>
</ul>

<h3 id="트랜잭션-문제-해결---트랜잭션-aop-정리">트랜잭션 문제 해결 - 트랜잭션 AOP 정리</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/19.png">
          <img src="/assets/images/post/Spring/db1/19.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="스프링-부트의-자동-리소스-등록">스프링 부트의 자동 리소스 등록</h3>
<h4 id="데이터소스---자동-등록">데이터소스 - 자동 등록</h4>
<ul>
  <li>스프링 부트는 데이터소스( <code class="language-plaintext highlighter-rouge">DataSource</code> )를 스프링 빈에 자동으로 등록한다.</li>
  <li>자동으로 등록되는 스프링 빈 이름: <code class="language-plaintext highlighter-rouge">dataSource</code></li>
  <li>참고로 개발자가 직접 데이터소스를 빈으로 등록하면 스프링 부트는 데이터소스를 자동으로 등록하지 않는다.</li>
  <li>이때 스프링 부트는 다음과 같이 <code class="language-plaintext highlighter-rouge">application.properties</code> 에 있는 속성을 사용해서 <code class="language-plaintext highlighter-rouge">DataSource</code> 를 생성한다. 그리고 스프링 빈에 등록한다.</li>
  <li>스프링 부트가 기본으로 생성하는 데이터소스는 커넥션풀을 제공하는 <code class="language-plaintext highlighter-rouge">HikariDataSource</code> 이다. 커넥션풀과 관련된 설정도 <code class="language-plaintext highlighter-rouge">application.properties</code> 를 통해서 지정할 수 있다.</li>
  <li><code class="language-plaintext highlighter-rouge">spring.datasource.url</code> 속성이 없으면 내장 데이터베이스(메모리 DB)를 생성하려고 시도한다.</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">spring.datasource.url=jdbc:h2:tcp://localhost/~/test</span>
<span class="s">spring.datasource.username=sa</span>
<span class="s">spring.datasource.password=</span>
</code></pre></div></div>

<h4 id="트랜잭션-매니저---자동-등록">트랜잭션 매니저 - 자동 등록</h4>
<ul>
  <li>스프링 부트는 적절한 트랜잭션 매니저( <code class="language-plaintext highlighter-rouge">PlatformTransactionManager</code> )를 자동으로 스프링 빈에 등록한다.</li>
  <li>자동으로 등록되는 스프링 빈 이름: <code class="language-plaintext highlighter-rouge">transactionManager</code></li>
  <li>참고로 개발자가 직접 트랜잭션 매니저를 빈으로 등록하면 스프링 부트는 트랜잭션 매니저를 자동으로 등록하지 않는다.</li>
  <li>어떤 트랜잭션 매니저를 선택할지는 현재 등록된 라이브러리를 보고 판단하는데, JDBC를 기술을 사용하면 <code class="language-plaintext highlighter-rouge">DataSourceTransactionManager</code> 를 빈으로 등록하고, JPA를 사용하면 <code class="language-plaintext highlighter-rouge">JpaTransactionManager</code> 를 빈으로 등록한다. 둘다 사용하는 경우 <code class="language-plaintext highlighter-rouge">JpaTransactionManager</code> 를 등록한다.</li>
  <li>참고로 <code class="language-plaintext highlighter-rouge">JpaTransactionManager</code> 는 <code class="language-plaintext highlighter-rouge">DataSourceTransactionManager</code> 가 제공하는 기능도 대부분 지원한다.</li>
</ul>

<h4 id="데이터소스와-트랜잭션-매니저-자동-등록">데이터소스와 트랜잭션 매니저 자동 등록</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootTest</span>
<span class="nd">@Slf4j</span>
<span class="kd">class</span> <span class="nc">MemberServiceV3_4Test</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_A</span> <span class="o">=</span> <span class="s">"memberA"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_B</span> <span class="o">=</span> <span class="s">"memberB"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MEMBER_EX</span> <span class="o">=</span> <span class="s">"ex"</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MemberRepositoryV3</span> <span class="n">memberRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">MemberServiceV3_3</span> <span class="n">memberService</span><span class="o">;</span>

    <span class="o">...</span>

    <span class="nd">@TestConfiguration</span>
    <span class="nd">@RequiredArgsConstructor</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TestConfig</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span> <span class="c1">// 의존관계 주입</span>

        <span class="nd">@Bean</span>
        <span class="nc">MemberRepositoryV3</span> <span class="nf">memberRepositoryV3</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">MemberRepositoryV3</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Bean</span>
        <span class="n">MemberServiceV3_3</span> <span class="nf">memberServiceV3_3</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">MemberServiceV3_3</span><span class="o">(</span><span class="n">memberRepositoryV3</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>데이터소스와 트랜잭션 매니저를 스프링 빈으로 등록하는 코드가 생략되었다. 따라서 스프링 부트가 <code class="language-plaintext highlighter-rouge">application.properties</code> 에 지정된 속성을 참고해서 데이터소스와 트랜잭션 매니저를 자동으로 생성해준다.</li>
</ul>

<h2 id="자바-예외-이해">자바 예외 이해</h2>
<h3 id="체크-예외-활용">체크 예외 활용</h3>
<ul>
  <li>체크 예외는 제공되는 메서드를 사용하는 클라이언트한테 예외처리를 컴파일 오류를 통해 강제할 수 있다는 장점이 있다. 즉 메서드 선언부에 발생할 수 있는 체크 예외를 명시함으로써 클라이언트는 처리해줘야 하는 예외를 쉽게, 안전하게 인지할 수 있다.</li>
  <li>체크 예외 문제점
    <ul>
      <li><code class="language-plaintext highlighter-rouge">ConnectException</code> 처럼 연결이 실패하거나, <code class="language-plaintext highlighter-rouge">SQLException</code> 처럼 데이터베이스에서 발생하는 문제처럼 심각한 문제들은 대부분 애플리케이션 로직에서 처리할 방법이 없다.</li>
      <li>서비스는 <code class="language-plaintext highlighter-rouge">SQLException</code> 과 <code class="language-plaintext highlighter-rouge">ConnectException</code> 를 처리할 수 없으므로 둘다 밖으로 던진다.(method() throws SQLException, ConnectException`)</li>
      <li>컨트롤러도 두 예외를 처리할 방법이 없다.(<code class="language-plaintext highlighter-rouge">method() throws SQLException, ConnectException</code>)</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CheckedAppTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">checked</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Controller</span> <span class="n">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Controller</span><span class="o">();</span>
        <span class="n">assertThatThrownBy</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">controller</span><span class="o">.</span><span class="na">request</span><span class="o">()).</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="nc">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Controller</span> <span class="o">{</span>
        <span class="nc">Service</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Service</span><span class="o">();</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">request</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">,</span> <span class="nc">ConnectException</span> <span class="o">{</span>
            <span class="n">service</span><span class="o">.</span><span class="na">logic</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Service</span> <span class="o">{</span>
        <span class="nc">Repository</span> <span class="n">repository</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Repository</span><span class="o">();</span>
        <span class="nc">NetworkClient</span> <span class="n">networkClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NetworkClient</span><span class="o">();</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">logic</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">,</span> <span class="nc">ConnectException</span> <span class="o">{</span>
            <span class="n">repository</span><span class="o">.</span><span class="na">call</span><span class="o">();</span>
            <span class="n">networkClient</span><span class="o">.</span><span class="na">call</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">NetworkClient</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">ConnectException</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConnectException</span><span class="o">(</span><span class="s">"연결 실패"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Repository</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">SQLException</span><span class="o">(</span><span class="s">"ex"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<h4 id="복구-불가능한-예외">복구 불가능한 예외</h4>
<p>대부분의 예외는 복구가 불가능하다. 일부 복구가 가능한 예외도 있지만 아주 적다. <code class="language-plaintext highlighter-rouge">SQLException</code> 을 예를 들면 데이터베이스에 무언가 문제가 있어서 발생하는 예외이다. SQL 문법에 문제가 있을 수도 있고, 데이터베이스 자체에 뭔가 문제가 발생했을 수도 있다. 
데이터베이스 서버가 중간에 다운 되었을 수도 있다. 이런 문제들은 대부분 복구가 불가능하다. 특히나 대부분의 서비스나 컨트롤러는 이런 문제를 해결할 수는 없다. 따라서 이런 문제들은 일관성 있게 공통으로 처리해야 한다. 오류 로그를 남기고 개발자가 해당 오류를 빠르게 인지하는 것이 필요하다. 
서블릿 필터, 스프링 인터셉터, 스프링의 <code class="language-plaintext highlighter-rouge">ControllerAdvice</code> 를 사용하면 이런 부분을 깔끔하게 공통으로 해결할 수 있다.</p>

<h4 id="의존-관계에-대한-문제">의존 관계에 대한 문제</h4>
<p>체크 예외의 또 다른 심각한 문제는 예외에 대한 의존 관계 문제이다. 앞서 대부분의 예외는 복구 불가능한 예외라고 했다. 그런데 체크 예외이기 때문에 컨트롤러나 서비스 입장에서는 본인이 처리할 수 없어도 어쩔 수 없이 <code class="language-plaintext highlighter-rouge">throws</code>를 통해 던지는 예외를 선언해야 한다.</p>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/20.png">
          <img src="/assets/images/post/Spring/db1/20.png" alt="" />
      </a>
    
  
  
</figure>

<p>즉 처리할 수도 없는 예외를 메서드의 선언부에 명시해야 되는 의존관계 발생으로 OCP에 위배된다.</p>

<h4 id="throws-exception">throws Exception</h4>
<p>물론 메서드의 선언부에서 체크 예외의 조상인 <code class="language-plaintext highlighter-rouge">Exception</code>을 활용함으로써 OCP를 지킬 수는 있다. 하지만 중간에 존재하는 모든 메서드에서 <code class="language-plaintext highlighter-rouge">Exception</code>를 활용하면 어떠한 종류의 체크 예외가 발생하는지 클라이언트 입장에서는 알 수가 없다. 즉 중요한 체크 예외를 다 놓치게 되고 체크 예외를 사용하는 진정한 목적이 퇴색되어 버린다.</p>

<h3 id="언체크-예외-활용">언체크 예외 활용</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/21.png">
          <img src="/assets/images/post/Spring/db1/21.png" alt="" />
      </a>
    
  
  
</figure>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnCheckedAppTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unchecked</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Controller</span> <span class="n">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Controller</span><span class="o">();</span>
        <span class="n">assertThatThrownBy</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">controller</span><span class="o">.</span><span class="na">request</span><span class="o">()).</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="nc">RuntimeSQLException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Controller</span> <span class="o">{</span>
        <span class="nc">Service</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Service</span><span class="o">();</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">request</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">service</span><span class="o">.</span><span class="na">logic</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Service</span> <span class="o">{</span>
        <span class="nc">Repository</span> <span class="n">repository</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Repository</span><span class="o">();</span>
        <span class="nc">NetworkClient</span> <span class="n">networkClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NetworkClient</span><span class="o">();</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">logic</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">repository</span><span class="o">.</span><span class="na">call</span><span class="o">();</span>
            <span class="n">networkClient</span><span class="o">.</span><span class="na">call</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">NetworkClient</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeConnectException</span><span class="o">(</span><span class="s">"연결 실패"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Repository</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">runSQL</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeSQLException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">runSQL</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">SQLException</span><span class="o">(</span><span class="s">"ex"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">RuntimeConnectException</span> <span class="kd">extends</span> <span class="nc">RuntimeException</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="nf">RuntimeConnectException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">RuntimeSQLException</span> <span class="kd">extends</span> <span class="nc">RuntimeException</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="nf">RuntimeSQLException</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>체크 예외의 문제는 체크 예외를 런타임 예외로 변경함으로써 해결할 수 있다. 런타임 예외의 경우 예외 처리가 강요되지 않으므로 서비스 등에서 처리할 수 있는 예외는 <code class="language-plaintext highlighter-rouge">try ~ catch</code>로 처리하고 그렇지 않은 경우 그냥 예외를 던지면 된다. 위와 같은 방법으로 필요한 예외를 걸러내면서 끝까지 걸러지지 않은 예외는 단순히 <code class="language-plaintext highlighter-rouge">ControllerAdvice</code> 기술을 이용하여 SRP 원칙을 지키면 된다.</li>
  <li>단 위와 같은 플로우를 위해서는 클라이언트를 위해 런타임 예외를 문서화해야 한다. 메서드 선언부에 런타임 예외를 명시하거나 javadoc를 이용하면 된다.</li>
  <li>또한 런타임 예외로 변경하는 경우 <code class="language-plaintext highlighter-rouge">RuntimeException(Throwable cause)</code>등을 이용하여 로그에서 스택 트레이스를 확인할 수 있도록 개발해야 한다.</li>
</ul>

<h2 id="스프링과-문제-해결---예외-처리-반복">스프링과 문제 해결 - 예외 처리, 반복</h2>
<h3 id="체크-예외와-인터페이스">체크 예외와 인터페이스</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepositoryEx</span> <span class="o">{</span>
    <span class="nc">Member</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">;</span>
    <span class="nc">Member</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">;</span>
    <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">;</span>
    <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>구현 기술을 쉽게 변경하기 위해서 인터페이스를 도입하더라도 <code class="language-plaintext highlighter-rouge">SQLException</code> 과 같은 특정 구현 기술에 종속적인 체크 예외를 사용하게 되면 인터페이스에도 해당 예외를 포함해야 한다. 하지만 이것은 우리가 원하던 순수한 인터페이스가 아니다. JDBC 기술에 종속적인 인터페이스일 뿐이다. 인터페이스를 만드는 목적은 구현체를 쉽게 변경하기 위함인데, 이미 인터페이스가 특정 구현 기술에 오염이 되어 버렸다. 향후 JDBC가 아닌 다른 기술로 변경한다면 인터페이스 자체를 변경해야 한다.</li>
  <li>런타임 예외는 이런 부분에서 자유롭다. 인터페이스에 런타임 예외를 따로 선언하지 않아도 된다. 따라서 인터페이스가 특정 기술에 종속적일 필요가 없다.</li>
</ul>

<h3 id="런타임-예외-적용">런타임 예외 적용</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="o">{</span>

    <span class="nc">Member</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">);</span>

    <span class="nc">Member</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyDbException</span> <span class="kd">extends</span> <span class="nc">RuntimeException</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">MyDbException</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">MyDbException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">MyDbException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">MyDbException</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRepositoryV4_1</span> <span class="kd">implements</span> <span class="nc">MemberRepository</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">Statement</span> <span class="n">stmt</span><span class="o">,</span> <span class="nc">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Repository</code>에서 체크 예외를 런타임 예외로 변환해서 던진다. 이 경우 메서드 선언부에 예외를 명시할 필요가 없어진다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberServiceV4</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MemberRepository</span> <span class="n">memberRepository</span><span class="o">;</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accountTransfer</span><span class="o">(</span><span class="nc">String</span> <span class="n">fromId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">toId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">bizLogic</span><span class="o">(</span><span class="n">fromId</span><span class="o">,</span> <span class="n">toId</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">bizLogic</span><span class="o">(</span><span class="nc">String</span> <span class="n">fromId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">toId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">fromMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">fromId</span><span class="o">);</span>
        <span class="nc">Member</span> <span class="n">toMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">toId</span><span class="o">);</span>

        <span class="n">memberRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">fromId</span><span class="o">,</span> <span class="n">fromMember</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">-</span> <span class="n">money</span><span class="o">);</span>
        <span class="n">validation</span><span class="o">(</span><span class="n">toMember</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">toId</span><span class="o">,</span> <span class="n">toMember</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">+</span> <span class="n">money</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">validation</span><span class="o">(</span><span class="nc">Member</span> <span class="n">toMember</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">toMember</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"ex"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"이체중 예외 발생"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>서비스 계층에서 체크 예외에 대한 의존성이 사라졌다. 즉 런타임 예외로 변경함으로써 서비스 계층부터는 필요한 예외만 잡아서 처리하면 되고 순수한 자바 코드로만 구성된다.</li>
  <li>체크 예외를 런타임 예외로 변환하면서 인터페이스와 서비스 계층의 순수성을 유지할 수 있게 되었다.</li>
  <li>덕분에 향후 JDBC에서 다른 구현 기술로 변경하더라도 서비스 계층의 코드를 변경하지 않고 유지할 수 있다.</li>
  <li>하지만 리포지토리에서 넘어오는 특정한 예외의 경우 복구를 시도할 수도 있다. 그런데 지금 방식은 항상 <code class="language-plaintext highlighter-rouge">MyDbException</code> 이라는 예외만 넘어오기 때문에 예외를 구분할 수 없는 단점이 있다.</li>
</ul>

<h3 id="데이터-접근-예외-직접-만들기">데이터 접근 예외 직접 만들기</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/22.png">
          <img src="/assets/images/post/Spring/db1/22.png" alt="" />
      </a>
    
  
  
</figure>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyDuplicateKeyException</span> <span class="kd">extends</span> <span class="nc">MyDbException</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">MyDuplicateKeyException</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">MyDuplicateKeyException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">MyDuplicateKeyException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">MyDuplicateKeyException</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>기존에 사용했던 <code class="language-plaintext highlighter-rouge">MyDbException</code> 을 상속받아서 의미있는 계층을 형성한다. 이렇게하면 데이터베이스 관련 예외라는 계층을 만들 수 있다.</li>
  <li>그리고 이름도 <code class="language-plaintext highlighter-rouge">MyDuplicateKeyException</code> 이라는 이름을 지었다. 이 예외는 데이터 중복의 경우에만 던져야 한다.</li>
  <li>이 예외는 우리가 직접 만든 것이기 때문에, JDBC나 JPA 같은 특정 기술에 종속적이지 않다. 따라서 이 예외를 사용하더라도 서비스 계층의 순수성을 유지할 수 있다. (향후 JDBC에서 다른 기술로 바꾸어도 이 예외는 그대로 유지할 수 있다.)</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExTranslatorV1Test</span> <span class="o">{</span>

    <span class="nc">Repository</span> <span class="n">repository</span><span class="o">;</span>
    <span class="nc">Service</span> <span class="n">service</span><span class="o">;</span>

    <span class="nd">@BeforeEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">duplicateKeySave</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">service</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"myId"</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"myId"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Slf4j</span>
    <span class="nd">@RequiredArgsConstructor</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Service</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Repository</span> <span class="n">repository</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">create</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">repository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="n">memberId</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"saveId={}"</span><span class="o">,</span> <span class="n">memberId</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">MyDuplicateKeyException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"키 중복, 복구 시도"</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">retryId</span> <span class="o">=</span> <span class="n">generateNewId</span><span class="o">(</span><span class="n">memberId</span><span class="o">);</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"retryId={}"</span><span class="o">,</span> <span class="n">retryId</span><span class="o">);</span>
                <span class="n">repository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="n">retryId</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">MyDbException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"데이터 접근 계층 예외"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="nc">String</span> <span class="nf">generateNewId</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">memberId</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@RequiredArgsConstructor</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Repository</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">...</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="o">...</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">==</span> <span class="mi">23505</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">MyDuplicateKeyException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">MyDbException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="o">...</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>리포지토리 계층이 예외를 변환해준 덕분에 서비스 계층은 특정 기술에 의존하지 않는 <code class="language-plaintext highlighter-rouge">MyDuplicateKeyException</code> 을 사용해서 문제를 복구하고, 서비스 계층의 순수성도 유지할 수 있었다.</li>
  <li>하지만 SQL ErrorCode는 각각의 데이터베이스 마다 다르다. 결과적으로 데이터베이스가 변경될 때 마다 ErrorCode도 모두 변경해야 한다.</li>
</ul>

<h3 id="스프링-예외-추상화-이해">스프링 예외 추상화 이해</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/db1/23.png">
          <img src="/assets/images/post/Spring/db1/23.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>스프링은 데이터 접근 계층에 대한 수십 가지 예외를 정리해서 일관된 예외 계층을 제공한다.</li>
  <li>각각의 예외는 특정 기술에 종속적이지 않게 설계되어 있다. 따라서 서비스 계층에서도 스프링이 제공하는 예외를 사용하면 된다. 예를 들어서 JDBC 기술을 사용하든, JPA 기술을 사용하든 스프링이 제공하는 예외를 사용하면 된다.</li>
  <li>JDBC나 JPA를 사용할 때 발생하는 예외를 스프링이 제공하는 예외로 변환해주는 역할도 스프링이 제공한다.</li>
  <li>예외의 최고 상위는 <code class="language-plaintext highlighter-rouge">org.springframework.dao.DataAccessException</code> 이다. 그림에서 보는 것 처럼 런타임 예외를 상속 받았기 때문에 스프링이 제공하는 데이터 접근 계층의 모든 예외는 런타임 예외이다.</li>
  <li><code class="language-plaintext highlighter-rouge">DataAccessException</code> 은 크게 2가지로 구분하는데 <code class="language-plaintext highlighter-rouge">NonTransient</code> 예외와 <code class="language-plaintext highlighter-rouge">Transient</code> 예외이다.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">Transient</code> 는 일시적이라는 뜻이다. <code class="language-plaintext highlighter-rouge">Transient</code> 하위 예외는 동일한 SQL을 다시 시도했을 때 성공할 가능성이 있다. 예를 들어서 쿼리 타임아웃, 락과 관련된 오류들이다. 이런 오류들은 데이터베이스 상태가 좋아지거나, 락이 풀렸을 때 다시 시도하면 성공할 수 도 있다.</li>
      <li><code class="language-plaintext highlighter-rouge">NonTransient</code> 는 일시적이지 않다는 뜻이다. 같은 SQL을 그대로 반복해서 실행하면 실패한다. SQL 문법 오류, 데이터베이스 제약조건 위배 등이 있다.</li>
    </ul>
  </li>
</ul>

<h4 id="스프링이-제공하는-예외-변환기">스프링이 제공하는 예외 변환기</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringExceptionTranslatorTest</span> <span class="o">{</span>

    <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span>

    <span class="nd">@BeforeEach</span>
    <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DriverManagerDataSource</span><span class="o">(</span><span class="no">URL</span><span class="o">,</span> <span class="no">USERNAME</span><span class="o">,</span> <span class="no">PASSWORD</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionTranslator</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select bad grammer"</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
            <span class="nc">PreparedStatement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">assertThat</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">42122</span><span class="o">);</span>

            <span class="nc">SQLErrorCodeSQLExceptionTranslator</span> <span class="n">exTranslator</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SQLErrorCodeSQLExceptionTranslator</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
            <span class="nc">DataAccessException</span> <span class="n">resultEx</span> <span class="o">=</span> <span class="n">exTranslator</span><span class="o">.</span><span class="na">translate</span><span class="o">(</span><span class="s">"select"</span><span class="o">,</span> <span class="n">sql</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"resultEx"</span><span class="o">,</span> <span class="n">resultEx</span><span class="o">);</span>
            <span class="n">assertThat</span><span class="o">(</span><span class="n">resultEx</span><span class="o">.</span><span class="na">getClass</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="nc">BadSqlGrammarException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">translate()</code> 메서드의 첫번째 파라미터는 읽을 수 있는 설명이고, 두번째는 실행한 sql, 마지막은 발생된 <code class="language-plaintext highlighter-rouge">SQLException</code> 을 전달하면 된다. 이렇게 하면 적절한 스프링 데이터 접근 계층의 예외로 변환해서 반환해준다.</li>
  <li>스프링은 <code class="language-plaintext highlighter-rouge">sql-error-codes.xml</code> 설정 파일을 통해서 각 DB별 에러 코드를 보고 그에 대응되는 스프링 정의 런타임 예외로 변환해준다.</li>
</ul>

<h3 id="jdbc-반복-문제-해결---jdbctemplate">JDBC 반복 문제 해결 - JdbcTemplate</h3>
<h4 id="jdbc-반복-문제-1">JDBC 반복 문제</h4>
<ul>
  <li>커넥션 조회, 커넥션 동기화</li>
  <li>₩PreparedStatement₩ 생성 및 파라미터 바인딩 쿼리 실행</li>
  <li>결과 바인딩</li>
  <li>예외 발생시 스프링 예외 변환기 실행</li>
  <li>리소스 종료</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRepositoryV5</span> <span class="kd">implements</span> <span class="nc">MemberRepository</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JdbcTemplate</span> <span class="n">template</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MemberRepositoryV5</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JdbcTemplate</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into member(member_id, money) values(?, ?)"</span><span class="o">;</span>
        <span class="n">template</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getMemberId</span><span class="o">(),</span> <span class="n">member</span><span class="o">.</span><span class="na">getMoney</span><span class="o">());</span>

        <span class="k">return</span> <span class="n">member</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from member where member_id = ?"</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">memberRowMapper</span><span class="o">(),</span> <span class="n">memberId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">RowMapper</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">memberRowMapper</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">rowNum</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">();</span>
            <span class="n">member</span><span class="o">.</span><span class="na">setMemberId</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"member_id"</span><span class="o">));</span>
            <span class="n">member</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"money"</span><span class="o">));</span>
            <span class="k">return</span> <span class="n">member</span><span class="o">;</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"update member set money=? where member_id=?"</span><span class="o">;</span>
        <span class="n">template</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">money</span><span class="o">,</span> <span class="n">memberId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"delete from member where member_id=?"</span><span class="o">;</span>
        <span class="n">template</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">memberId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">JdbcTemplate</code> 은 JDBC로 개발할 때 발생하는 반복을 대부분 해결해준다. 그 뿐만 아니라 지금까지 학습했던, 트랜잭션을 위한 커넥션 동기화는 물론이고, 예외 발생시 스프링 예외 변환기도 자동으로 실행해준다.</li>
</ul>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#jdbc" class="page__taxonomy-item" rel="tag">JDBC</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#jpa" class="page__taxonomy-item" rel="tag">JPA</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#orm" class="page__taxonomy-item" rel="tag">ORM</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#spring" class="page__taxonomy-item" rel="tag">Spring</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 카테고리: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#spring-db" class="page__taxonomy-item" rel="tag">Spring/DB</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 업데이트:</strong> <time datetime="2022-07-08T00:00:00+09:00">July 8, 2022</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">공유하기</h4>
  

  <a href="https://twitter.com/intent/tweet?text=%5BSpring%5D%5BDB%5D+%EC%8A%A4%ED%94%84%EB%A7%81+DB+1%ED%8E%B8+-+%EB%8D%B0%EC%9D%B4%ED%84%B0+%EC%A0%91%EA%B7%BC+%ED%95%B5%EC%8B%AC+%EC%9B%90%EB%A6%AC%20https%3A%2F%2Frere950303.github.io%2Fspring%2Fdb%2Fspringdb%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Frere950303.github.io%2Fspring%2Fdb%2Fspringdb%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Frere950303.github.io%2Fspring%2Fdb%2Fspringdb%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/cleancode/exception/" class="pagination--pager" title="[CleanCode] 오류 처리
">이전</a>
    
    
      <a href="/cleancode/adapter/" class="pagination--pager" title="[CleanCode] 어댑터 패턴
">다음</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">연관글</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/cleancode/adapter/" rel="permalink">[CleanCode] 어댑터 패턴
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-07-08T00:00:00+09:00">July 8, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/cleancode/exception/" rel="permalink">[CleanCode] 오류 처리
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-07-06T00:00:00+09:00">July 6, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/daily/intern/" rel="permalink">[Daily] 웍스 모바일 인턴 합격 후기
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-07-04T00:00:00+09:00">July 4, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/java/clear/" rel="permalink">[Java] 다 쓴 객체를 해제하라
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-05-28T00:00:00+09:00">May 28, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          최대 1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="검색어를 입력하세요..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      
        
      
        
      
        
          <li><a href="https://github.com/rere950303" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    
    
    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 yhw. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    <script>
  'use strict';

  (function() {
    var commentContainer = document.querySelector('#utterances-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://utteranc.es/client.js');
    script.setAttribute('repo', 'rere950303/rere950303.github.io');
    script.setAttribute('issue-term', 'title');
    script.setAttribute('theme', 'github-light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>

  





  </body>
</html>
