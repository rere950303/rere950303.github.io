<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.20.2 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>[Spring][Batch] Spring Batch - YHW Blog</title>
<meta name="description" content="새로운 배움을 기록하고 공유합니다">


  <meta name="author" content="yhw">
  
  <meta property="article:author" content="yhw">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="YHW Blog">
<meta property="og:title" content="[Spring][Batch] Spring Batch">
<meta property="og:url" content="https://rere950303.github.io/spring/batch/batch/">


  <meta property="og:description" content="새로운 배움을 기록하고 공유합니다">







  <meta property="article:published_time" content="2022-01-03T00:00:00+09:00">





  

  


<link rel="canonical" href="https://rere950303.github.io/spring/batch/batch/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "yhw",
      "url": "https://rere950303.github.io/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="YHW Blog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
<link rel="manifest" href="/favicon/site.webmanifest">
<link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          YHW Blog
          <span class="site-subtitle">새로운 배움을 기록하고 공유합니다</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/">categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">토글 메뉴</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://rere950303.github.io/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#spring" itemprop="item"><span itemprop="name">Spring</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#batch" itemprop="item"><span itemprop="name">Batch</span></a>
          <meta itemprop="position" content="3" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">[Spring][Batch] Spring Batch</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/bio/photo.jpg" alt="yhw" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">yhw</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>어제와 다른 오늘, 오늘 같은 내일</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">팔로우</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Republic of Korea</span>
        </li>
      

      
        
          
            <li><a href="mailto:yhwjjang1995@naver.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
        
          
        
          
            <li><a href="https://github.com/rere950303" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="[Spring][Batch] Spring Batch">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2022-01-03T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">[Spring][Batch] Spring Batch
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-01-03T00:00:00+09:00">January 3, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          36 분 소요
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              
                <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
                <ul class="toc__menu">
  <li><a href="#들어가며">들어가며</a></li>
  <li><a href="#스프링-배치-소개">스프링 배치 소개</a>
    <ul>
      <li><a href="#개요">개요</a></li>
      <li><a href="#아키텍처">아키텍처</a></li>
    </ul>
  </li>
  <li><a href="#스프링-배치-시작">스프링 배치 시작</a>
    <ul>
      <li><a href="#스프링-배치-활성화">스프링 배치 활성화</a></li>
      <li><a href="#hello-spring-batch-시작하기">Hello Spring Batch 시작하기</a></li>
      <li><a href="#db-스키마-생성">DB 스키마 생성</a></li>
    </ul>
  </li>
  <li><a href="#스프링-배치-도메인-이해">스프링 배치 도메인 이해</a>
    <ul>
      <li><a href="#job">Job</a></li>
      <li><a href="#jobinstance">JobInstance</a></li>
      <li><a href="#jobparameter">JobParameter</a></li>
      <li><a href="#jobexecution">JobExecution</a></li>
      <li><a href="#step">Step</a></li>
      <li><a href="#stepexecution">StepExecution</a></li>
      <li><a href="#stepcontribution">StepContribution</a></li>
      <li><a href="#executioncontext">ExecutionContext</a></li>
      <li><a href="#jobrepository">JobRepository</a></li>
      <li><a href="#joblauncher">JobLauncher</a></li>
    </ul>
  </li>
  <li><a href="#스프링-배치-실행---job">스프링 배치 실행 - Job</a>
    <ul>
      <li><a href="#배치-초기화-설정">배치 초기화 설정</a></li>
      <li><a href="#jobbuilderfactory--jobbuilder">JobBuilderFactory / JobBuilder</a></li>
      <li><a href="#simplejob">SimpleJob</a></li>
      <li><a href="#simplejob---validator">SimpleJob - validator()</a></li>
      <li><a href="#simplejob---preventrestart">SimpleJob - preventRestart()</a></li>
      <li><a href="#simplejob---incrementer">SimpleJob - incrementer()</a></li>
      <li><a href="#simplejob-아키텍처">SimpleJob 아키텍처</a></li>
    </ul>
  </li>
  <li><a href="#스프링-배치-실행---step">스프링 배치 실행 - Step</a>
    <ul>
      <li><a href="#stepbuilderfactory">StepBuilderFactory</a></li>
      <li><a href="#taskletstep---개념-및-api-소개">TaskletStep - 개념 및 API 소개</a></li>
      <li><a href="#taskletstep---tasklet">TaskletStep - tasklet()</a></li>
      <li><a href="#taskletstep---startlimit">TaskletStep - startLimit()</a></li>
      <li><a href="#taskletstep---allowstartifcomplete">TaskletStep - allowStartIfComplete()</a></li>
      <li><a href="#taskletstep-아키텍처">TaskletStep 아키텍처</a></li>
      <li><a href="#jobstep">JobStep</a></li>
    </ul>
  </li>
  <li><a href="#스프링-배치-실행---flow">스프링 배치 실행 - Flow</a>
    <ul>
      <li><a href="#flowjob---개념-및-api-소개">FlowJob - 개념 및 API 소개</a></li>
      <li><a href="#flowjob---start--next">FlowJob - start() / next()</a></li>
      <li><a href="#transition---배치상태-유형-batchstatus--exitstatus--flowexecutionstatus">Transition - 배치상태 유형 (BatchStatus / ExitStatus / FlowExecutionStatus)</a></li>
      <li><a href="#transition---on--to--stop-fail-end-stopandrestart">Transition - on() / to() / stop(), fail(), end(), stopAndRestart()</a></li>
      <li><a href="#사용자-정의-exitstatus">사용자 정의 ExitStatus</a></li>
      <li><a href="#jobexecutiondecider">JobExecutionDecider</a></li>
      <li><a href="#flowjob-아키텍처">FlowJob 아키텍처</a></li>
      <li><a href="#simpleflow---개념-및-api-소개">SimpleFlow - 개념 및 API 소개</a></li>
      <li><a href="#simpleflow-아키텍처">SimpleFlow 아키텍처</a></li>
      <li><a href="#flowstep">FlowStep</a></li>
      <li><a href="#jobscope--stepscope---기본개념-및-설정">@JobScope / @StepScope - 기본개념 및 설정</a></li>
      <li><a href="#jobscope--stepscope-아키텍처">@JobScope / @StepScope 아키텍처</a></li>
    </ul>
  </li>
  <li><a href="#스프링-배치-청크-프로세스-이해">스프링 배치 청크 프로세스 이해</a>
    <ul>
      <li><a href="#chunk">Chunk</a></li>
      <li><a href="#chunkorientedtasklet---개념-및-api-소개">ChunkOrientedTasklet - 개념 및 API 소개</a></li>
      <li><a href="#chunkorientedtasklet---chunkprovider--chunkprocessor">ChunkOrientedTasklet - ChunkProvider / ChunkProcessor</a>
        <ul>
          <li><a href="#chunkprovider">ChunkProvider</a></li>
          <li><a href="#chunkprocessor">ChunkProcessor</a></li>
        </ul>
      </li>
      <li><a href="#itemreader--itemwriter--itemprocessor-이해">ItemReader / ItemWriter / ItemProcessor 이해</a>
        <ul>
          <li><a href="#itemreader">ItemReader</a></li>
          <li><a href="#itemwriter">ItemWriter</a></li>
        </ul>
      </li>
      <li><a href="#itemstream">ItemStream</a></li>
    </ul>
  </li>
  <li><a href="#스프링-배치-청크-프로세스-활용---itemreader">스프링 배치 청크 프로세스 활용 - ItemReader</a>
    <ul>
      <li><a href="#flatfileitemreader---개념-및-api-소개">FlatFileItemReader - 개념 및 API 소개</a></li>
      <li><a href="#flatfileitemreader---delimetedlinetokenizer">FlatFileItemReader - delimetedlinetokenizer</a></li>
      <li><a href="#flatfileitemreader---fixedlengthtokenizer">FlatFileItemReader - fixedlengthtokenizer</a></li>
      <li><a href="#exception-handling">Exception Handling</a></li>
      <li><a href="#json---jsonitemreader">Json - JsonItemReader</a></li>
      <li><a href="#db---cursor--paging-이해">DB - Cursor &amp; Paging 이해</a></li>
      <li><a href="#db---jdbccursoritemreader">DB - JdbcCursorItemReader</a></li>
      <li><a href="#db---jpacursoritemreader">DB - JpaCursorItemReader</a></li>
      <li><a href="#db---jdbcpagingitemreader">DB - JdbcPagingItemReader</a></li>
      <li><a href="#db---jpapagingitemreader">DB - JpaPagingItemReader</a></li>
      <li><a href="#itemreaderadapter">ItemReaderAdapter</a></li>
    </ul>
  </li>
  <li><a href="#스프링-배치-청크-프로세스-활용---itemwriter">스프링 배치 청크 프로세스 활용 - ItemWriter</a>
    <ul>
      <li><a href="#jsonfileitemwriter">JsonFileItemWriter</a></li>
      <li><a href="#db---jdbcbatchitemwriter">DB - JdbcBatchItemWriter</a></li>
      <li><a href="#db---jpaitemwriter">DB - JpaItemWriter</a></li>
    </ul>
  </li>
  <li><a href="#스프링-배치-청크-프로세스-활용---itemprocessor">스프링 배치 청크 프로세스 활용 - ItemProcessor</a>
    <ul>
      <li><a href="#compositeitemprocessor">CompositeItemProcessor</a></li>
    </ul>
  </li>
  <li><a href="#목차-소개">목차 소개</a>
    <ul>
      <li><a href="#repeat">Repeat</a></li>
      <li><a href="#faulttolerant">FaultTolerant</a></li>
      <li><a href="#skip">Skip</a></li>
      <li><a href="#retry">Retry</a></li>
      <li><a href="#skip--retry-architecture">Skip &amp; Retry Architecture</a></li>
    </ul>
  </li>
  <li><a href="#스프링-배치-멀티-스레드-프로세싱">스프링 배치 멀티 스레드 프로세싱</a>
    <ul>
      <li><a href="#기본-개념">기본 개념</a></li>
      <li><a href="#asyncitemprocessor--asyncitemwriter">AsyncItemProcessor / AsyncItemWriter</a></li>
      <li><a href="#multi-threaded-step">Multi-threaded Step</a></li>
      <li><a href="#parallel-steps">Parallel Steps</a></li>
      <li><a href="#partitioning">Partitioning</a></li>
      <li><a href="#synchronizeditemstreamreader">SynchronizedItemStreamReader</a></li>
    </ul>
  </li>
  <li><a href="#스프링-배치-이벤트-리스너">스프링 배치 이벤트 리스너</a>
    <ul>
      <li><a href="#기본개념">기본개념</a></li>
      <li><a href="#jobexecutionlistener--stepexecutionlistener">JobExecutionListener / StepExecutionListener</a></li>
      <li><a href="#chunklistener--itemreadlistener-itemprocesslistener-itemwritelistener">ChunkListener / ItemReadListener /ItemProcessListener /ItemWriteListener</a></li>
      <li><a href="#skiplistener--retrylistener">SkipListener &amp; RetryListener</a>
        <ul>
          <li><a href="#skiplistener">SkipListener</a></li>
          <li><a href="#retrylistener">RetryListener</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#jobexplorer--jobregistry--joboperator">JobExplorer / JobRegistry / JobOperator</a>
    <ul>
      <li><a href="#jobexplorer">JobExplorer</a></li>
      <li><a href="#jobregistry">JobRegistry</a></li>
      <li><a href="#joboperator">JobOperator</a></li>
    </ul>
  </li>
</ul>

              
            </nav>
            <nav class="toc-custom">
              
            </nav>
          </aside>
        
        <h2 id="들어가며">들어가며</h2>
<p>해당 게시글은 인프런 정수원 강사님의 <a href="https://www.inflearn.com/course/스프링-배치/dashboard">스프링 배치 - Spring Boot 기반으로 개발하는 Spring Batch</a> 강의를 바탕으로 쓰였음을 미리 밝힙니다.</p>

<h2 id="스프링-배치-소개">스프링 배치 소개</h2>
<h3 id="개요">개요</h3>
<ul>
  <li>배치 핵심 패턴
    <ul>
      <li>Read: 데이터베이스, 파일, 큐에서 다량의 데이터 조회한다.</li>
      <li>Process: 특정 방법으로 데이터를 가공한다.</li>
      <li>Write: 데이터를 수정된 양식으로 다시 저장한다.</li>
    </ul>
  </li>
  <li>배치 시나리오
    <ul>
      <li>배치 프로세스를 주기적으로 커밋</li>
      <li>동시 다발적인 Job의 배치처리, 대용량 병렬 처리(멀티쓰레드)</li>
      <li>실패 후 수동 또는 스케줄링에 의한 재시작</li>
      <li>의존관계가 있는 step 여러 개를 순차적으로 처리</li>
      <li>조건적 Flow 구성을 통한 체계적이고 유연한 배치 모델 구성</li>
      <li>반복, 재시도, Skip 처리</li>
    </ul>
  </li>
</ul>

<h3 id="아키텍처">아키텍처</h3>
<ul>
  <li>Application
    <ul>
      <li>스프링 배치 프레임워크를 통해 개발자가 만든 모든 배치 Job과 커스텀 코드를 포함</li>
      <li>개발자는 업무로직의 구현에만 집중하고 공통적인 기반기술은 프레임웍이 담당하게 한다.</li>
    </ul>
  </li>
  <li>Batch Core
    <ul>
      <li>Job을 실행, 모니터링, 관리하는 API로 구성되어 있다.</li>
      <li>JobLauncher, Job, Step, Flow 등이 속한다.</li>
    </ul>
  </li>
  <li>Batch Intrastructure
    <ul>
      <li>Application, Core 모두 공통 Infrastructure 위에서 빌드한다.</li>
      <li>Job 실행의 흐름과 처리를 위한 틀을 제공함</li>
      <li>Reader, Processor Writer, Skip, Retry 등이 속한다.</li>
    </ul>
  </li>
</ul>

<h2 id="스프링-배치-시작">스프링 배치 시작</h2>
<h3 id="스프링-배치-활성화">스프링 배치 활성화</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">@EnableBatchProcessing</code>: 총 4개의 설정 클래스를 실행시키며 스프링 배치의 모든 초기화 및 실행 구성이 이루어진다. 스프링 부트 배치의 자동 설정 클래스가 실행됨으로 빈으로 등록된 모든 Job 을 검색해서 초기화와 동시에 Job 을 수행하도록 구성됨</li>
  <li>스프링 배치 초기화 설정 클래스
    <ul>
      <li>BatchAutoConfiguration: 스프링 배치가 초기화 될 때 자동으로 실행되는 설정 클래스, Job 을 수행하는 JobLauncherApplicationRunner 빈을 생성</li>
      <li>SimpleBatchConfiguration: JobBuilderFactory 와 StepBuilderFactory 생성, 스프링 배치의 주요 구성요소 생성 - 프록시 객체로 생성됨</li>
      <li>BatchConfigurerConfiguration
        <ul>
          <li>BasicBatchConfigurer: SimpleBatchConfiguration 에서 생성한 프록시 객체의 실제 대상 객체를 생성하는 설정 클래스, 빈으로 의존성 주입 받아서 주요 객체들을 참조해서 사용할 수 있다.</li>
          <li>JpaBatchConfigurer: JPA 관련 객체를 생성하는 설정 클래스</li>
          <li>사용자 정의 BatchConfigurer 인터페이스를 구현하여 사용할 수 있음</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="hello-spring-batch-시작하기">Hello Spring Batch 시작하기</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloJobConfiguration</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JobBuilderFactory</span> <span class="n">jobBuilderFactory</span><span class="o">;</span> <span class="c1">// Job을 생성하는 빌더 팩토리</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">StepBuilderFactory</span> <span class="n">stepBuilderFactory</span><span class="o">;</span> <span class="c1">// Step을 생성하는 빌더 팩토리</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Job</span> <span class="nf">helloJob</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"helloJob"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">helloStep1</span><span class="o">())</span>
                <span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="n">helloStep2</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Step</span> <span class="nf">helloStep1</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">stepBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"helloStep1"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">tasklet</span><span class="o">(</span><span class="k">new</span> <span class="nc">Tasklet</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// Step 안에서 단일 태스크로 수행되는 로직 구현</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">RepeatStatus</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">StepContribution</span> <span class="n">contribution</span><span class="o">,</span> <span class="nc">ChunkContext</span> <span class="n">chunkContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"============================="</span><span class="o">);</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" &gt;&gt; Hello Spring Step1!!"</span><span class="o">);</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"============================="</span><span class="o">);</span>
                        <span class="k">return</span> <span class="nc">RepeatStatus</span><span class="o">.</span><span class="na">FINISHED</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}).</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>Job 구동 -&gt; Step을 실행 -&gt; Taskelt 실행</li>
  <li>Job: 일, Step: 일의 항목, Taskelt: 작업 내용</li>
</ul>

<h3 id="db-스키마-생성">DB 스키마 생성</h3>
<ul>
  <li>스프링 배치의 실행 및 관리를 위한 목적으로 여러 도메인들(Job, Step, JobParameters..) 의 정보들을 저장, 업데이트, 조회할 수 있는 스키마 제공</li>
  <li>과거, 현재의 실행에 대한 세세한 정보, 실행에 대한 성공과 실패 여부 등을 일목요연하게 관리함으로서 배치운용에 있어 리스크 발생시 빠른 대처 가능</li>
  <li>DB와 연동할 경우 필수적으로 메타 테이블이 생성 되어야함</li>
  <li>스키마 생성 설정
    <ul>
      <li>수동 생성 – 쿼리 복사 후 직접 실행</li>
      <li>자동 생성 - spring.batch.jdbc.initialize-schema 설정
        <ul>
          <li>ALWAYS: 스크립트 항상 실행, RDBMS 설정이 되어 있을 경우 내장 DB 보다 우선적으로 실행</li>
          <li>EMBEDDED: 내장 DB일 때만 실행되며 스키마가 자동 생성됨, 기본값</li>
          <li>NEVER: 스크립트 항상 실행 안함, 내장 DB 일경우 스크립트가 생성이 안되기 때문에 오류 발생, 운영에서 수동으로 스크립트 생성 후 설정하는 것을 권장</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/1.png">
          <img src="/assets/images/post/Spring/Batch/1.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>Job 관련 테이블
    <ul>
      <li>BATCH_JOB_INSTANCE: Job이 실행될 때 JobInstance 정보가 저장되며 job_name과 job_key를 하나의 데이터로 저장, 동일한 job_name과 job_key로 중복 저장될 수없다.</li>
      <li>BATCH_JOB_EXECUTION: job 의 실행정보가 저장되며 Job 생성, 시작, 종료 시간, 실행상태, 메시지 등을 관리</li>
      <li>BATCH_JOB_EXECUTION_PARAMS: Job과 함께 실행되는 JobParameter 정보를 저장</li>
      <li>BATCH_JOB_EXECUTION_CONTEXT: Job의 실행동안 여러가지 상태정보, 공유 데이터를 직렬화(Json형식)해서 저장, Step간 서로 공유 가능함</li>
    </ul>
  </li>
  <li>Step 관련 테이블
    <ul>
      <li>BATCH_STEP_EXECUTION: Step 의 실행정보가 저장되며 생성, 시작, 종료 시간, 실행상태, 메시지 등을 관리</li>
      <li>BATCH_STEP_EXECUTION_CONTEXT: Step의 실행동안 여러가지 상태정보, 공유 데이터를 직렬화(Json형식)해서 저장</li>
      <li>Step 별로 저장되며 Step간 서로 공유할 수 없음</li>
    </ul>
  </li>
</ul>

<h2 id="스프링-배치-도메인-이해">스프링 배치 도메인 이해</h2>
<h3 id="job">Job</h3>
<ul>
  <li>기본 개념
    <ul>
      <li>배치 계층 구조에서 가장 상위에 있는 개념으로서 하나의 배치작업 자체를 의미함</li>
      <li>Job Configuration 을 통해 생성되는 객체 단위로서 배치작업을 어떻게 구성하고 실행할 것인지 전체적으로 설정하고 명세해 놓은 객체</li>
      <li>배치 Job 을 구성하기 위한 최상위 인터페이스이며 스프링 배치가 기본 구현체를 제공한다.</li>
      <li>여러 Step 을 포함하고 있는 컨테이너로서 반드시 한개 이상의 Step으로 구성해야 함</li>
    </ul>
  </li>
  <li>기본 구현체
    <ul>
      <li>SimpleJob: 순차적으로 Step 을 실행시키는 Job</li>
      <li>FlowJob: 특정한 조건과 흐름에 따라 Step 을 구성하여 실행시키는 Job, Flow 객체를 실행시켜서 작업을 진행함</li>
    </ul>
  </li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/2.png">
          <img src="/assets/images/post/Spring/Batch/2.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="jobinstance">JobInstance</h3>
<ul>
  <li>기본 개념
    <ul>
      <li>Job이 실행될 때 생성되는 Job의 논리적 실행 단위 객체로서 고유하게 식별 가능한 작업 실행을 나타냄</li>
      <li>Job의 설정과 구성은 동일하지만 Job이 실행되는 시점에 처리하는 내용은 다르기 때문에 Job의 실행을 구분해야 함</li>
      <li>처음 시작하는 Job + JobParameter 일 경우 새로운 JobInstance 생성</li>
      <li>이전과 동일한 Job + JobParameter 으로 실행 할 경우 이미 존재하는 JobInstance 리턴 -&gt; 내부적으로 JobName + jobKey (jobParametes 의 해시값) 를 가지고 JobInstance 객체를 얻음</li>
    </ul>
  </li>
  <li>BATCH_JOB_INSTANCE 테이블과 매핑
    <ul>
      <li>JOB_NAME (Job) 과 JOB_KEY (JobParameter 해시값) 가 동일한 데이터는 중복해서 저장할 수 없음</li>
    </ul>
  </li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/3.png">
          <img src="/assets/images/post/Spring/Batch/3.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="jobparameter">JobParameter</h3>
<ul>
  <li>기본 개념
    <ul>
      <li>Job을 실행할 때 함께 포함되어 사용되는 파라미터를 가진 도메인 객체</li>
      <li>하나의 Job에 존재할 수 있는 여러개의 JobInstance를 구분하기 위한 용도</li>
    </ul>
  </li>
  <li>생성 및 바인딩
    <ul>
      <li>어플리케이션 실행 시 주입: <code class="language-plaintext highlighter-rouge">Java -jar LogBatch.jar requestDate=20210101</code></li>
      <li>코드로 생성: JobParameterBuilder</li>
      <li>SpEL 이용: <code class="language-plaintext highlighter-rouge">@Value(“#{jobParameter[requestDate]}”)</code>, <code class="language-plaintext highlighter-rouge">@JobScope</code>, <code class="language-plaintext highlighter-rouge">@StepScope</code> 선언 필수</li>
    </ul>
  </li>
  <li>BATCH_JOB_EXECUTION_PARAM 테이블과 매핑
    <ul>
      <li>JOB_EXECUTION 과 1:M 의 관계</li>
    </ul>
  </li>
</ul>

<h3 id="jobexecution">JobExecution</h3>
<ul>
  <li>기본 개념
    <ul>
      <li>JobIstance 에 대한 한번의 시도를 의미하는 객체로서 Job 실행 중에 발생한 정보들을 저장하고 있는 객체</li>
      <li>JobExecution은 ‘FAILED’ 또는 ‘COMPLETED‘ 등의 Job의 실행 결과 상태를 가지고 있음</li>
      <li>JobExecution 의 실행 상태 결과가 ‘COMPLETED’ 면 JobInstance 실행이 완료된 것으로 간주해서 재실행이 불가함</li>
      <li>JobExecution 의 실행 상태 결과가 ‘FAILED’ 면 JobInstance 실행이 완료되지 않은 것으로 간주해서 재실행이 가능함(JobParameter 가 동일한 값으로 Job 을 실행할지라도 JobInstance 를 계속 실행할 수 있음)</li>
    </ul>
  </li>
  <li>BATCH_JOB_EXECUTION 테이블과 매핑
    <ul>
      <li>JobInstance 와 JobExecution 는 1:M 의 관계로서 JobInstance 에 대한 성공/실패의 내역을 가지고 있음</li>
    </ul>
  </li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/4.png">
          <img src="/assets/images/post/Spring/Batch/4.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="step">Step</h3>
<ul>
  <li>기본 개념
    <ul>
      <li>Batch job을 구성하는 독립적인 하나의 단계로서 실제 배치 처리를 정의하고 컨트롤하는 데 필요한 모든 정보를 가지고 있는 도메인 객체CFc</li>
      <li>단순한 단일 태스크 뿐 아니라 입력과 처리 그리고 출력과 관련된 복잡한 비즈니스 로직을 포함하는 모든 설정들을 담고 있다.</li>
      <li>배치작업을 어떻게 구성하고 실행할 것인지 Job 의 세부 작업을 Task 기반으로 설정하고 명세해 놓은 객체</li>
      <li>모든 Job은 하나 이상의 step으로 구성됨</li>
    </ul>
  </li>
  <li>기본 구현체
    <ul>
      <li>TaskletStep: 가장 기본이 되는 클래스로서 Tasklet 타입의 구현체들을 제어한다</li>
      <li>PartitionStep: 멀티 스레드 방식으로 Step 을 여러 개로 분리해서 실행한다</li>
      <li>JobStep: Step 내에서 Job 을 실행하도록 한다</li>
      <li>FlowStep: Step 내에서 Flow 를 실행하도록 한다.</li>
    </ul>
  </li>
</ul>

<h3 id="stepexecution">StepExecution</h3>
<ul>
  <li>기본 개념
    <ul>
      <li>Step 에 대한 한번의 시도를 의미하는 객체로서 Step 실행 중에 발생한 정보들을 저장하고 있는 객체</li>
      <li>Step 이 매번 시도될 때마다 생성되며 각 Step 별로 생성된다.</li>
      <li>Job이 재시작 하더라도 이미 성공적으로 완료된 Step은 재실행 되지않고 실패한 Step만 실행된다.</li>
      <li>이전 단계 Step이 실패해서 현재 Step을 실행하지 않았다면 StepExecution을 생성하지 않는다. Step이 실제로 시작됐을 때만 StepExecution을 생성한다.</li>
    </ul>
  </li>
  <li>BATCH_STEP_EXECUTION 테이블과 매핑
    <ul>
      <li>JobExecution 와 StepExecution 는 1:M 의 관계</li>
    </ul>
  </li>
</ul>

<h3 id="stepcontribution">StepContribution</h3>
<ul>
  <li>청크 프로세스의 변경 사항을 버퍼링 한 후 StepExecution 상태를 업데이트하는 도메인 객체</li>
  <li>청크 커밋 직전에 StepExecution 의 apply 메서드를 호출하여 상태를 업데이트 함</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/5.png">
          <img src="/assets/images/post/Spring/Batch/5.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="executioncontext">ExecutionContext</h3>
<ul>
  <li>프레임워크에서 유지 및 관리하는 키/값으로 된 컬렉션으로 StepExecution 또는 JobExecution 객체의 상태(state)를 저장하는 공유 객체</li>
  <li>공유 범위
    <ul>
      <li>Step 범위 – 각 Step 의 StepExecution 에 저장되며 Step 간 서로 공유 안됨</li>
      <li>Job 범위 – 각 Job의 JobExecution 에 저장되며 Job 간 서로 공유 안되며 해당 Job의 Step 간 서로 공유됨</li>
    </ul>
  </li>
</ul>

<h3 id="jobrepository">JobRepository</h3>
<ul>
  <li>배치 작업 중의 정보를 저장하는 저장소 역할</li>
  <li>Job이 언제 수행되었고, 언제 끝났으며, 몇 번이 실행되었고 실행에 대한 결과 등의 배치 작업의 수행과 관련된 모든 meta data 를 저장함(JobLauncher, Job, Step 구현체 내부에서 CRUD 기능을 처리함)</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/6.png">
          <img src="/assets/images/post/Spring/Batch/6.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>JobRepository 설정
    <ul>
      <li><code class="language-plaintext highlighter-rouge">@EnableBatchProcessing</code> 어노테이션만 선언하면 JobRepository 가 자동으로 빈으로 생성됨</li>
      <li>BatchConfigurer 인터페이스를 구현하거나 BasicBatchConfigurer 를 상속해서 JobRepository 설정을 커스터마이징 할 수 있다.</li>
    </ul>
  </li>
</ul>

<h3 id="joblauncher">JobLauncher</h3>
<ul>
  <li>배치 Job 을 실행시키는 역할을 한다.</li>
  <li>Job과 Job Parameters를 인자로 받으며 요청된 배치 작업을 수행한 후 최종 client 에게 JobExecution을 반환함</li>
  <li>스프링 부트 배치가 구동이 되면 JobLauncher 빈이 자동 생성 된다.(<code class="language-plaintext highlighter-rouge">JobLanucher.run(Job, JobParameters)</code>)</li>
  <li>스프링 부트 배치에서는 JobLauncherApplicationRunner 가 자동적으로 JobLauncher 을 실행시킨다.</li>
  <li>동기적 실행
    <ul>
      <li>taskExecutor 를 SyncTaskExecutor 로 설정할 경우 (기본값은 SyncTaskExecutor)</li>
      <li>JobExecution 을 획득하고 배치 처리를 최종 완료한 이후 Client 에게 JobExecution 을 반환</li>
    </ul>
  </li>
  <li>비 동기적 실행
    <ul>
      <li>taskExecutor 가 SimpleAsyncTaskExecutor 로 설정할 경우</li>
      <li>JobExecution 을 획득한 후 Client 에게 바로 JobExecution 을 반환하고 배치처리를 완료한다.</li>
      <li>HTTP 요청에 의한 배치 처리에 적합함 – 배치처리 시간이 길 경우 응답이 늦어지지 않도록 함</li>
    </ul>
  </li>
</ul>

<h2 id="스프링-배치-실행---job">스프링 배치 실행 - Job</h2>
<h3 id="배치-초기화-설정">배치 초기화 설정</h3>
<ul>
  <li>JobLauncherApplicationRunner
    <ul>
      <li>Spring Batch 작업을 시작하는 ApplicationRunner 로서 BatchAutoConfiguration 에서 생성됨</li>
      <li>스프링 부트에서 제공하는 ApplicationRunner 의 구현체로 어플리케이션이 정상적으로 구동되자 마다 실행됨</li>
      <li>기본적으로 빈으로 등록된 모든 job 을 실행시킨다.</li>
    </ul>
  </li>
  <li>BatchProperties
    <ul>
      <li>Spring Batch 의 환경 설정 클래스</li>
      <li>Job 이름, 스키마 초기화 설정, 테이블 Prefix 등의 값을 설정할 수 있다.</li>
    </ul>
  </li>
  <li>Job 실행 옵션
    <ul>
      <li>지정한 Batch Job만 실행하도록 할 수 있음(<code class="language-plaintext highlighter-rouge">spring.batch.job.names: ${job.name:NONE}</code>)</li>
      <li>어플리케이션 실행시 Program arguments 로 job 이름 입력한다.(<code class="language-plaintext highlighter-rouge">--job.name=helloJob</code>, <code class="language-plaintext highlighter-rouge">--job.name=helloJob,simpleJob</code>)</li>
    </ul>
  </li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">batch</span><span class="pi">:</span>
    <span class="na">jdbc</span><span class="pi">:</span>
      <span class="na">initialize-schema</span><span class="pi">:</span> <span class="s">always</span>
    <span class="na">job</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">names</span><span class="pi">:</span> <span class="s">${job.name:NONE}</span>
</code></pre></div></div>

<h3 id="jobbuilderfactory--jobbuilder">JobBuilderFactory / JobBuilder</h3>
<ul>
  <li>스프링 배치는 Job과 Step을 쉽게 생성 및 설정할 수 있도록 util 성격의 빌더 클래스들을 제공함</li>
  <li>JobBuilderFactory
    <ul>
      <li>JobBuilder 를 생성하는 팩토리 클래스로서 get(String name) 메서드 제공</li>
    </ul>
  </li>
  <li>JobBuilder
    <ul>
      <li>Job을 구성하는 설정 조건에 따라 두 개의 하위 빌더 클래스를 생성하고 실제 Job 생성을 위임한다.</li>
      <li>SimpleJobBuilder: SimpleJob 을 생성하는 Builder 클래스</li>
      <li>FlowJobBuilder: FlowJob 을 생성하는 Builder 클래스, 내부적으로 FlowBuilder 를 반환함으로써 Flow 실행과 관련된 여러 설정 API 를 제공한다.</li>
    </ul>
  </li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/7.png">
          <img src="/assets/images/post/Spring/Batch/7.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="simplejob">SimpleJob</h3>
<ul>
  <li>SimpleJob 은 Step 을 실행시키는 Job 구현체로서 SimpleJobBuilder 에 의해 생성된다.</li>
  <li>여러 단계의 Step 으로 구성할 수 있으며 Step 을 순차적으로 실행시킨다.</li>
  <li>맨 마지막에 실행한 Step 의 BatchStatus 가 Job 의 최종 BatchStatus 가 된다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Job</span> <span class="nf">batchJob</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"batchJob"</span><span class="o">)</span> <span class="c1">// JobBuilder 를 생성하는 팩토리, Job 의 이름을 매개변수로 받음</span>
            <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="nc">Step</span><span class="o">)</span> <span class="c1">// 처음 실행 할 Step 설정, 최초 한번 설정, 이 메서드를 실행하면 SimpleJobBuilder 반환</span>
            <span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="nc">Step</span><span class="o">)</span> <span class="c1">// 다음에 실행 할 Step 설정, 횟수는 제한이 없으며 모든 next() 의 Step 이 종료가 되면 Job 이 종료된다</span>
            <span class="o">.</span><span class="na">incrementer</span><span class="o">(</span><span class="nc">JobParametersIncrementer</span><span class="o">)</span> <span class="c1">// JobParameter 의 값을 자동을 증가해 주는 JobParametersIncrementer 설정</span>
            <span class="o">.</span><span class="na">preventRestart</span><span class="o">()</span> <span class="c1">// Job 의 재시작 가능 여부 설정, 기본값은 true</span>
            <span class="o">.</span><span class="na">validator</span><span class="o">(</span><span class="nc">JobParameterValidator</span><span class="o">)</span> <span class="c1">// JobParameter 를 실행하기 전에 올바른 구성이 되었는지 검증하는 JobParametersValidator 설정</span>
            <span class="o">.</span><span class="na">listener</span><span class="o">(</span><span class="nc">JobExecutionListener</span><span class="o">)</span> <span class="c1">// Job 라이프 사이클의 특정 시점에 콜백 제공받도록 JobExecutionListener 설정</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span> <span class="c1">// SimpleJob 생성</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="simplejob---validator">SimpleJob - validator()</h3>
<ul>
  <li>Job 실행에 꼭 필요한 파라미터를 검증하는 용도</li>
  <li>DefaultJobParametersValidator 구현체를 지원하며, 좀 더 복잡한 제약 조건이 있다면 인터페이스를 직접 구현할 수도 있음</li>
  <li>requiredKeys, optionalKeys</li>
  <li>JobParametersInvalidException, Validation Success</li>
</ul>

<h3 id="simplejob---preventrestart">SimpleJob - preventRestart()</h3>
<ul>
  <li>Job 의 재시작 여부를 설정</li>
  <li>기본 값은 true 이며 false 로 설정 시 “ 이 Job은 재시작을 지원하지 않는다 ” 라는 의미</li>
  <li>Job 이 실패해도 재 시작이 안되며 Job을 재시작하려고 하면 JobRestartException이 발생</li>
  <li>Job 의 실행이 처음이 아닌 경우는 Job 의 성공/실패와 상관없이 오직 preventRestart 설정 값에 따라서 실행 여부를 판단한다.</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/8.png">
          <img src="/assets/images/post/Spring/Batch/8.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="simplejob---incrementer">SimpleJob - incrementer()</h3>
<ul>
  <li>JobParameters 에서 필요한 값을 증가시켜 다음에 사용될 JobParameters 오브젝트를 리턴</li>
  <li><strong>기존의</strong> JobParameter 변경없이 Job 을 여러 번 시작하고자 할때</li>
  <li>RunIdIncrementer 구현체를 지원하며 인터페이스를 직접 구현할 수 있음</li>
</ul>

<h3 id="simplejob-아키텍처">SimpleJob 아키텍처</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/9.png">
          <img src="/assets/images/post/Spring/Batch/9.png" alt="" />
      </a>
    
  
  
</figure>

<h2 id="스프링-배치-실행---step">스프링 배치 실행 - Step</h2>
<h3 id="stepbuilderfactory">StepBuilderFactory</h3>
<ul>
  <li>StepBuilderFactory
    <ul>
      <li>StepBuilder 를 생성하는 팩토리 클래스로서 get(String name) 메서드 제공</li>
    </ul>
  </li>
  <li>StepBuilder: Step을 구성하는 설정 조건에 따라 다섯 개의 하위 빌더 클래스를 생성하고 실제 Step 생성을 위임한다.
    <ul>
      <li>TaskletStepBuilder: TaskletStep 을 생성하는 기본 빌더 클래스</li>
      <li>SimpleStepBuilder: TaskletStep 을 생성하며 내부적으로 청크기반의 작업을 처리하는 ChunkOrientedTasklet 클래스를 생성한다.</li>
      <li>PartitionStepBuilder: PartitionStep 을 생성하며 멀티 스레드 방식으로 Job 을 실행한다.</li>
      <li>JobStepBuilder: JobStep 을 생성하여 Step 안에서 Job 을 실행한다.</li>
      <li>FlowStepBuilder: FlowStep 을 생성하여 Step 안에서 Flow 를 실행한다.</li>
    </ul>
  </li>
</ul>

<h3 id="taskletstep---개념-및-api-소개">TaskletStep - 개념 및 API 소개</h3>
<ul>
  <li>스프링 배치에서 제공하는 Step 의 구현체로서 Tasklet 을 실행시키는 도메인 객체</li>
  <li>RepeatTemplate 를 사용해서 Tasklet 의 구문을 트랜잭션 경계 내에서 반복해서 실행함</li>
  <li>Task 기반과 Chunk 기반으로 나누어서 Tasklet 을 실행함</li>
  <li>Task vs Chunk 기반 비교
    <ul>
      <li>Task 기반: 단일 작업 기반으로 처리되는 것이 더 효율적인 경우, 주로 Tasklet 구현체를 만들어 사용, 대량 처리를 하는 경우 chunk 기반에 비해 더 복잡한 구현 필요</li>
      <li>chunk 기반: 하나의 큰 덩어리를 n개씩 나눠서 실행한다는 의미로 대량 처리를 하는 경우 효과적으로 설계 됨. ItemReader, ItemProcessor, ItemWriter 를 사용하며 청크 기반 전용 Tasklet 인 ChunkOrientedTasklet 구현체가 제공된다.</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Step</span> <span class="nf">batchStep</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">stepBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"batchStep"</span><span class="o">)</span> <span class="c1">// StepBuilder 를 생성하는 팩토리, Step 의 이름을 매개변수로 받음</span>
            <span class="o">.</span><span class="na">tasklet</span><span class="o">(</span><span class="nc">Tasklet</span><span class="o">)</span> <span class="c1">// Tasklet 클래스 설정, 이 메서드를 실행하면 TaskletStepBuilder 반환</span>
            <span class="o">.</span><span class="na">startLimit</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span> <span class="c1">// Step의 실행 횟수를 설정, 설정한 만큼 실행되고 초과시 오류 발생, 기본값음 INTEGER.MAX_VALUE</span>
            <span class="o">.</span><span class="na">allowStartIfComplete</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="c1">// Step의 성공, 실패와 상관없이 항상 Step 을 실행하기 위한 설정</span>
            <span class="o">.</span><span class="na">listener</span><span class="o">(</span><span class="nc">StepExecutionListener</span><span class="o">)</span> <span class="c1">// Step 라이프 사이클의 특정 시점에 콜백 제공받도록 StepExecutionListener 설정</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span> <span class="c1">// TaskletStep 을 생성</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="taskletstep---tasklet">TaskletStep - tasklet()</h3>
<ul>
  <li>Step 내에서 구성되고 실행되는 도메인 객체로서 주로 단일 태스크를 수행하기위한 것</li>
  <li>TaskletStep 에 의해 반복적으로 수행되며 반환값에 따라 계속 수행 혹은 종료한다.
    <ul>
      <li>RepeatStatus.FINISHED - Tasklet 종료, RepeatStatus 을 null 로 반환하면 RepeatStatus.FINISHED로 해석됨</li>
      <li>RepeatStatus.CONTINUABLE - Tasklet 반복</li>
    </ul>
  </li>
  <li>Step 에 오직 하나의 Tasklet 설정이 가능하며 두개 이상을 설정 했을 경우 마지막에 설정한 객체가 실행된다.</li>
</ul>

<h3 id="taskletstep---startlimit">TaskletStep - startLimit()</h3>
<ul>
  <li>Step의 실행 횟수를 조정할 수 있다.</li>
  <li>Step 마다 설정할 수 있다.</li>
  <li>설정 값을 초과해서 다시 실행하려고 하면 StartLimitExceededException이 발생</li>
  <li>start-limit의 디폴트 값은 Integer.MAX_VALUE</li>
</ul>

<h3 id="taskletstep---allowstartifcomplete">TaskletStep - allowStartIfComplete()</h3>
<ul>
  <li>재시작 가능한 job 에서 Step 의 이전 성공 여부와 상관없이 항상 step 을 실행하기 위한 설정</li>
  <li>기본적으로 COMPLETED 상태를 가진 Step 은 Job 재시작 시 실행하지 않고 스킵한다.</li>
</ul>

<h3 id="taskletstep-아키텍처">TaskletStep 아키텍처</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/10.png">
          <img src="/assets/images/post/Spring/Batch/10.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="jobstep">JobStep</h3>
<ul>
  <li>Job 에 속하는 Step 중 외부의 Job 을 포함하고 있는 Step</li>
  <li>외부의 Job 이 실패하면 해당 Step 이 실패하므로 결국 최종 기본 Job 도 실패한다.</li>
  <li>모든 메타데이터는 기본 Job 과 외부 Job 별로 각각 저장된다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Step</span> <span class="nf">jobStep</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">stepBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"jobStep"</span><span class="o">)</span> <span class="c1">// StepBuilder 를 생성하는 팩토리, Step 의 이름을 매개변수로 받음</span>
            <span class="o">.</span><span class="na">job</span><span class="o">(</span><span class="nc">Job</span><span class="o">)</span> <span class="c1">// JobStep 내 에서 실행 될 Job 설정, JobStepBuilder 반환</span>
            <span class="o">.</span><span class="na">launcher</span><span class="o">(</span><span class="nc">JobLauncher</span><span class="o">)</span> <span class="c1">// Job 을 실행할 JobLauncher설정</span>
            <span class="o">.</span><span class="na">parametersExtractor</span><span class="o">(</span><span class="nc">JobParametersExtractor</span><span class="o">)</span> <span class="c1">// Step의 ExecutionContext를 Job이 실행되는 데 필요한 JobParameters로 변환</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span> <span class="c1">// JobStep 을 생성</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="스프링-배치-실행---flow">스프링 배치 실행 - Flow</h2>
<h3 id="flowjob---개념-및-api-소개">FlowJob - 개념 및 API 소개</h3>
<ul>
  <li>Step 을 순차적으로만 구성하는 것이 아닌 특정한 상태에 따라 흐름을 전환하도록 구성할 수 있으며 FlowJobBuilder 에 의해 생성된다.</li>
  <li>Flow 와 Job 의 흐름을 구성하는데만 관여하고 실제 비즈니스 로직은 Step 에서 이루어진다.</li>
  <li>내부적으로 SimpleFlow 객체를 포함하고 있으며 Job 실행 시 호출한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Job</span> <span class="nf">batchJob</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"batchJob"</span><span class="o">)</span> 
            <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="nc">Step</span><span class="o">)</span> <span class="c1">// Flow 시작하는 Step 설정</span>
            <span class="o">.</span><span class="na">on</span><span class="o">(</span><span class="nc">String</span> <span class="n">pattern</span><span class="o">)</span> <span class="c1">// Step의 실행 결과로 돌려받는 종료상태 (ExitStatus)를 캐치하여 매칭하는 패턴, TransitionBuilder 반환</span>
            <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="nc">Step</span><span class="o">)</span> <span class="c1">// 다음으로 이동할 Step 지정</span>
            <span class="o">.</span><span class="na">stop</span><span class="o">()</span> <span class="o">/</span> <span class="n">fail</span><span class="o">()</span> <span class="o">/</span> <span class="n">end</span><span class="o">()</span> <span class="o">/</span> <span class="n">stopAndRestart</span><span class="o">()</span> <span class="c1">//Flow를중지/실패/종료하도록 Flow종료</span>
            <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Step</span><span class="o">)</span> <span class="c1">// 이전 단계에서 정의한 Step 의 Flow 를 추가적으로 정의함</span>
            <span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="nc">Step</span><span class="o">)</span> <span class="c1">// 다음으로 이동할 Step 지정</span>
            <span class="o">.</span><span class="na">end</span><span class="o">()</span> <span class="c1">// build() 앞에 위치하면 FlowBuilder 를 종료하고 SimpleFlow 객체 생성</span>
            <span class="o">.</span><span class="na">build</span><span class="o">()</span> <span class="c1">// FlowJob 생성하고 flow 필드에 SimpleFlow 저장</span>
<span class="o">}</span>
</code></pre></div></div>

<figure class="half ">
  
    
      <a href="/assets/images/post/Spring/Batch/11.png">
          <img src="/assets/images/post/Spring/Batch/11.png" alt="" />
      </a>
    
  
    
      <a href="/assets/images/post/Spring/Batch/12.png">
          <img src="/assets/images/post/Spring/Batch/12.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="flowjob---start--next">FlowJob - start() / next()</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Job</span> <span class="nf">batchJob</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"batchJob"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="nc">Flow</span><span class="o">)</span> <span class="c1">// 처음 실행 할 Flow 설정, JobFlowBuilder 가 반환된다. // 여기에 Step 이 인자로 오게 되면 SimpleJobBuilder 가 반환</span>
            <span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="nc">Step</span> <span class="n">or</span> <span class="nc">Flow</span> <span class="n">or</span> <span class="nc">JobExecutionDecider</span><span class="o">)</span>
            <span class="o">.</span><span class="na">on</span><span class="o">(</span><span class="nc">String</span> <span class="n">pattern</span><span class="o">)</span>
            <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="nc">Step</span><span class="o">)</span>
            <span class="o">.</span><span class="na">stop</span><span class="o">()</span> <span class="o">/</span> <span class="n">fail</span><span class="o">()</span> <span class="o">/</span> <span class="n">end</span><span class="o">()</span> <span class="o">/</span> <span class="n">stopAndRestart</span><span class="o">()</span>
            <span class="o">.</span><span class="na">end</span><span class="o">()</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="transition---배치상태-유형-batchstatus--exitstatus--flowexecutionstatus">Transition - 배치상태 유형 (BatchStatus / ExitStatus / FlowExecutionStatus)</h3>
<ul>
  <li>BatchStatus
    <ul>
      <li>JobExecution 과 StepExecution의 속성으로 Job 과 Step 의 종료 후 최종 결과 상태가 무엇인지 정의</li>
      <li>SimpleJob: 마지막 Step 의 BatchStatus 값을 Job 의 최종 BatchStatus 값으로 반영, Step 이 실패할 경우 해당 Step 이 마지막 Step 이 된다.</li>
      <li>FlowJob: Flow 내 Step 의 ExitStatus 값을 FlowExecutionStatus 값으로 저장, 마지막 Flow 의 FlowExecutionStatus 값을 Job 의 최종 BatchStatus 값으로 반영</li>
      <li>COMPLETED, STARTING, STARTED, STOPPING, STOPPED, FAILED, ABANDONED, UNKNOWN</li>
    </ul>
  </li>
  <li>ExitStatus
    <ul>
      <li>JobExecution 과 StepExecution의 속성으로 Job 과 Step 의 실행 후 어떤 상태로 종료되었는지 정의</li>
      <li>기본적으로 ExitStatus 는 BatchStatus 와 동일한 값으로 설정된다.</li>
      <li>SimpleJob: 마지막 Step 의 ExitStatus 값을 Job 의 최종 ExitStatus 값으로 반영</li>
      <li>FlowJob: Flow 내 Step 의 ExitStatus 값을 FlowExecutionStatus 값으로 저장, 마지막 Flow 의 FlowExecutionStatus 값을 Job 의 최종 ExitStatus 값으로 반영</li>
      <li>UNKNOWN, EXECUTING, COMPLETED, NOOP, FAILED, STOPPED</li>
    </ul>
  </li>
  <li>FlowExecutionStatus
    <ul>
      <li>FlowExecution 의 속성으로 Flow 의 실행 후 최종 결과 상태가 무엇인지 정의</li>
      <li>Flow 내 Step 이 실행되고 나서 ExitStatus 값을 FlowExecutionStatus 값으로 저장</li>
      <li>COMPLETED, STOPPED, FAILED, UNKNOWN</li>
    </ul>
  </li>
</ul>

<h3 id="transition---on--to--stop-fail-end-stopandrestart">Transition - on() / to() / stop(), fail(), end(), stopAndRestart()</h3>
<ul>
  <li>Transition
    <ul>
      <li>Flow 내 Step 의 조건부 전환(전이)을 정의함</li>
      <li>Job 의 API 설정에서 on(String pattern) 메소드를 호출하면 TransitionBuilder 가 반환되어 Transition Flow 를 구성할 수 있음</li>
      <li><strong>Step의 종료상태(ExitStatus) 가 어떤 pattern 과도 매칭되지 않으면 스프링 배치에서 예외을 발생하고 Job 은 실패</strong></li>
      <li>transition은 구체적인 것부터 그렇지 않은 순서로 적용된다.</li>
    </ul>
  </li>
  <li>on(String pattern)
    <ul>
      <li>Step의 실행 결과로 돌려받는 종료상태(ExitStatus)와 매칭하는 패턴 스키마, BatchStatus 와 매칭하는 것이 아님</li>
      <li>pattern 과 ExitStatus 와 매칭이 되면 다음으로 실행할 Step 을 지정할 수 있다.</li>
      <li>특수문자는 두 가지만 허용: “*” : 0개 이상의 문자와 매칭, 모든 ExitStatus 와 매칭된다 / ”?” : 정확히 1개의 문자와 매칭</li>
    </ul>
  </li>
  <li>to(): 다음으로 실행할 단계를 지정</li>
  <li>from(): 이전 단계에서 정의한 Transition 을 새롭게 추가 정의함</li>
  <li>stop(): FlowExecutionStatus 가 STOPPED 상태로 종료되는 transition, Job 의 BatchStatus 와 ExitStatus 가 STOPPED 으로 종료됨</li>
  <li>fail(): FlowExecutionStatus 가 FAILED 상태로 종료되는 transition, Job 의 BatchStatus 와 ExitStatus 가 FAILED 으로 종료됨</li>
  <li>end(): FlowExecutionStatus 가 COMPLETED 상태로 종료 되는 transition, Job 의 BatchStatus 와 ExitStatus 가 COMPLETED 으로 종료됨, Step 의 ExitStatus 가 FAILED 이더라도 Job 의 BatchStatus 가 COMPLETED 로 종료하도록 가능하며 이 때 Job의 재시작은 불가능함</li>
  <li>stopAndRestart(Step or Flow or JobExecutionDecider): 특정 step에서 작업을 중단하도록 설정하면 중단 이전의 Step 만 COMPLETED 저장되고 이후의 step 은 실행되지 않고 STOPPED 상태로 Job 종료, Job 이 다시 실행됐을 때 실행해야 할 step 을 restart 인자로 넘기면 이전에 COMPLETED 로 저장된 step 은 건너뛰고 중단 이후 step 부터 시작한다.</li>
</ul>

<h3 id="사용자-정의-exitstatus">사용자 정의 ExitStatus</h3>
<ul>
  <li>ExitStatus 에 존재하지 않는 exitCode 를 새롭게 정의해서 설정</li>
  <li>StepExecutionListener 의 afterStep() 메서드에서 Custom exitCode 생성 후 새로운 ExitStatus 반환</li>
  <li>Step 실행 후 완료 시점에서 현재 exitCode 를 사용자 정의 exitCode 로 수정할 수 있음</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">Job</span> <span class="nf">batchJob</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"batchJob"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">step1</span><span class="o">())</span>
            <span class="o">.</span><span class="na">on</span><span class="o">(</span><span class="s">"FAILED"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="n">step2</span><span class="o">())</span>
            <span class="o">.</span><span class="na">on</span><span class="o">(</span><span class="s">"PASS"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">stop</span><span class="o">()</span>
            <span class="o">.</span><span class="na">end</span><span class="o">()</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">Step</span> <span class="nf">step2</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">stepBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"step2"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">tasklet</span><span class="o">((</span><span class="n">contribution</span><span class="o">,</span> <span class="n">chunkContext</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&gt;&gt; step2 has executed"</span><span class="o">);</span>
                <span class="k">return</span> <span class="nc">RepeatStatus</span><span class="o">.</span><span class="na">FINISHED</span><span class="o">;</span>
            <span class="o">})</span>
            <span class="o">.</span><span class="na">listener</span><span class="o">(</span><span class="k">new</span> <span class="nc">PassCheckingListener</span><span class="o">())</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">class</span> <span class="nc">PassCheckingListener</span> <span class="kd">extends</span> <span class="nc">StepExecutionListenerSupport</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">ExitStatus</span> <span class="nf">afterStep</span><span class="o">(</span><span class="nc">StepExecution</span> <span class="n">stepExecution</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">exitCode</span> <span class="o">=</span> <span class="n">stepExecution</span><span class="o">.</span><span class="na">getExitStatus</span><span class="o">().</span><span class="na">getExitCode</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">exitCode</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">ExitStatus</span><span class="o">.</span><span class="na">FAILED</span><span class="o">.</span><span class="na">getExitCode</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">ExitStatus</span><span class="o">(</span><span class="s">"PASS "</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="jobexecutiondecider">JobExecutionDecider</h3>
<ul>
  <li>ExitStatus 를 조작하거나 StepExecutionListener 를 등록할 필요 없이 Transition 처리를 위한 전용 클래스</li>
  <li>Step 과 Transiton 역할을 명확히 분리해서 설정 할 수 있음</li>
  <li>Step 의 ExitStatus 가 아닌 JobExecutionDecider 의 FlowExecutionStatus 상태값을 새롭게 설정해서 반환함</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JobConfiguration</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JobBuilderFactory</span> <span class="n">jobBuilderFactory</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">StepBuilderFactory</span> <span class="n">stepBuilderFactory</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Job</span> <span class="nf">job</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"batchJob"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">incrementer</span><span class="o">(</span><span class="k">new</span> <span class="nc">RunIdIncrementer</span><span class="o">())</span>
                <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">step</span><span class="o">())</span>
                <span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="n">decider</span><span class="o">())</span>
                <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">decider</span><span class="o">()).</span><span class="na">on</span><span class="o">(</span><span class="s">"ODD"</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">oddStep</span><span class="o">())</span>
                <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">decider</span><span class="o">()).</span><span class="na">on</span><span class="o">(</span><span class="s">"EVEN"</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">evenStep</span><span class="o">())</span>
                <span class="o">.</span><span class="na">end</span><span class="o">()</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JobExecutionDecider</span> <span class="nf">decider</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">CustomDecider</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">CustomDecider</span> <span class="kd">implements</span> <span class="nc">JobExecutionDecider</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FlowExecutionStatus</span> <span class="nf">decide</span><span class="o">(</span><span class="nc">JobExecution</span> <span class="n">jobExecution</span><span class="o">,</span> <span class="nc">StepExecution</span> <span class="n">stepExecution</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">count</span><span class="o">++;</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nf">FlowExecutionStatus</span><span class="o">(</span><span class="s">"EVEN"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nf">FlowExecutionStatus</span><span class="o">(</span><span class="s">"ODD"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="flowjob-아키텍처">FlowJob 아키텍처</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/13.png">
          <img src="/assets/images/post/Spring/Batch/13.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="simpleflow---개념-및-api-소개">SimpleFlow - 개념 및 API 소개</h3>
<ul>
  <li>스프링 배치에서 제공하는 Flow 의 구현체로서 각 요소(Step, Flow, JobExecutionDecider) 들을 담고 있는 State 를 실행시키는 도메인 객체</li>
  <li>FlowBuilder 를 사용해서 생성하며 Transition 과 조합하여 여러 개의 Flow 및 중첩 Flow 를 만들어 Job 을 구성할 수 있다.</li>
  <li>Flow 안에 Step 을 구성하거나 Flow 를 중첩되게 구성할 수 있다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JobConfiguration</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JobBuilderFactory</span> <span class="n">jobBuilderFactory</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">StepBuilderFactory</span> <span class="n">stepBuilderFactory</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Job</span> <span class="nf">job</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"batchJob"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">flow</span><span class="o">())</span>
                <span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="n">step3</span><span class="o">())</span>
                <span class="o">.</span><span class="na">end</span><span class="o">()</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Flow</span> <span class="nf">flow</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">FlowBuilder</span><span class="o">&lt;</span><span class="nc">Flow</span><span class="o">&gt;(</span><span class="s">"flow"</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">step1</span><span class="o">())</span>
                <span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="n">step2</span><span class="o">())</span>
                <span class="o">.</span><span class="na">end</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>Flow 안에 Flow와 Step를 포함한 구조</li>
</ul>

<h3 id="simpleflow-아키텍처">SimpleFlow 아키텍처</h3>
<ul>
  <li>Step, Flow, Decider 등을 담은 State 생성하여 StateTransition에 담은 후에 이를 토대로 SimpleFlow 속성을 생성한다. <code class="language-plaintext highlighter-rouge">start()</code>, <code class="language-plaintext highlighter-rouge">resume()</code>, <code class="language-plaintext highlighter-rouge">nextState()</code> 메소드를 통해서 조건에 맞는 Transition에 따라 State를 실행시킨다. FlowState 일 경우에는 다시 재귀적 호출이 된다.</li>
  <li>SimpleFlow 는 StateMap 에 저장되어 있는 모든 State 들의 handle 메서드를 호출해서 모든 Step 들이 실행되도록 한다.</li>
  <li>SimpleFlow 는 현재 호출되는 State 가 어떤 타입인지 알지 못하고 관심도 없다. 단지 handle 메소드를 실행하고 상태값을 얻어올 뿐이다.(상태 패턴)</li>
</ul>

<figure class="half ">
  
    
      <a href="/assets/images/post/Spring/Batch/14.png">
          <img src="/assets/images/post/Spring/Batch/14.png" alt="" />
      </a>
    
  
    
      <a href="/assets/images/post/Spring/Batch/15.png">
          <img src="/assets/images/post/Spring/Batch/15.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="flowstep">FlowStep</h3>
<ul>
  <li>Step 내에 Flow 를 할당하여 실행시키는 도메인 객체</li>
  <li>flowStep 의 BatchStatus 와 ExitStatus 은 Flow 의 최종 상태값에 따라 결정된다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JobConfiguration</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JobBuilderFactory</span> <span class="n">jobBuilderFactory</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">StepBuilderFactory</span> <span class="n">stepBuilderFactory</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Job</span> <span class="nf">job</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"job"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">flowStep</span><span class="o">())</span>
                <span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="n">step3</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Step</span> <span class="nf">flowStep</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">stepBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"flowStep"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">flow</span><span class="o">(</span><span class="n">flow</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Flow</span> <span class="nf">flow</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">FlowBuilder</span><span class="o">&lt;</span><span class="nc">Flow</span><span class="o">&gt;(</span><span class="s">"flow"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">step1</span><span class="o">())</span>
                <span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="n">step2</span><span class="o">())</span>
                <span class="o">.</span><span class="na">end</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="jobscope--stepscope---기본개념-및-설정">@JobScope / @StepScope - 기본개념 및 설정</h3>
<ul>
  <li>스프링 컨테이너에서 빈이 관리되는 범위</li>
  <li><code class="language-plaintext highlighter-rouge">@JobScope</code>, <code class="language-plaintext highlighter-rouge">@StepScope</code>
    <ul>
      <li>Job과 Step의 빈 생성과 실행에 관여하는 스코프</li>
      <li>프록시 모드를 기본값으로 하는 스코프 - <code class="language-plaintext highlighter-rouge">@Scope(value = "job", proxyMode = ScopedProxyMode.TARGET_CLASS)</code></li>
      <li>해당 스코프가 선언되면 빈이 생성이 어플리케이션 구동시점이 아닌 빈의 실행시점에 이루어진다. 프록시 모드로 빈이 선언되기 때문에 어플리케이션 구동시점에는 빈의 프록시 객체가 생성되어 실행 시점에 실제 빈을 호출해 준다.</li>
      <li>@Values를 주입해서 빈의 실행 시점에 값을 참조할 수 있으며 일종의 Lazy Binding 이 가능해 진다.</li>
      <li><code class="language-plaintext highlighter-rouge">@Value("#{jobParameters[파라미터명]}")</code>, <code class="language-plaintext highlighter-rouge">@Value("#{jobExecutionContext[파라미터명]”})</code>, <code class="language-plaintext highlighter-rouge">@Value("#{stepExecutionContext[파라미터명]”})</code></li>
      <li>병렬처리 시 각 스레드 마다 생성된 스코프 빈이 할당되기 때문에 스레드에 안전하게 실행이 가능하다.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">@JobScope</code>
    <ul>
      <li>Step 선언문에 정의한다</li>
      <li><code class="language-plaintext highlighter-rouge">@Value</code> : jobParameter, jobExecutionContext 만 사용가능</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">@StepScope</code>
    <ul>
      <li>Tasklet이나 ItemReader, ItemWriter, ItemProcessor 선언문에 정의한다.</li>
      <li><code class="language-plaintext highlighter-rouge">@Value</code> : jobParameter, jobExecutionContext, stepExecutionContext 사용가능</li>
    </ul>
  </li>
</ul>

<h3 id="jobscope--stepscope-아키텍처">@JobScope / @StepScope 아키텍처</h3>
<ul>
  <li>Proxy 객체 생성: <code class="language-plaintext highlighter-rouge">@JobScope</code> , <code class="language-plaintext highlighter-rouge">@StepScope</code> 어노테이션이 붙은 빈 선언은 내부적으로 빈의 Proxy 객체가 생성된다.</li>
  <li>Job 실행 시 Proxy 객체가 실제 빈을 호출해서 해당 메서드를 실행시키는 구조</li>
  <li>JobScope , StepScope: Proxy 객체의 실제 대상이 되는 Bean 을 등록, 해제하는 역할. 실제 빈을 저장하고 있는 JobContext, StepContext 를 가지고 있다.</li>
  <li>JobContext , StepContext: 스프링 컨테이너에서 생성된 빈을 저장하는 컨텍스트 역할, Job 의 실행 시점에서 프록시 객체가 실제 빈을 참조할 때 사용됨</li>
</ul>

<h2 id="스프링-배치-청크-프로세스-이해">스프링 배치 청크 프로세스 이해</h2>
<h3 id="chunk">Chunk</h3>
<ul>
  <li>Chunk 란 여러 개의 아이템을 묶은 하나의 덩어리, 블록을 의미</li>
  <li>한번에 하나씩 아이템을 입력 받아 Chunk 단위의 덩어리로 만든 후 Chunk 단위로 트랜잭션을 처리함, 즉 Chunk 단위의 Commit 과 Rollback 이 이루어짐</li>
  <li>일반적으로 대용량 데이터를 한번에 처리하는 것이 아닌 청크 단위로 쪼개어서 더 이상 처리할 데이터가 없을 때까지 반복해서 입출력하는데 사용됨</li>
  <li><code class="language-plaintext highlighter-rouge">Chunk&lt;I&gt;</code>: ItemReader 로 읽은 하나의 아이템을 Chunk 에서 정한 개수만큼 반복해서 저장하는 타입</li>
  <li><code class="language-plaintext highlighter-rouge">Chunk&lt;O&gt;</code>: <code class="language-plaintext highlighter-rouge">Chunk&lt;I&gt;</code> 를 참조해서 ItemProcessor 에서 적절하게 가공, 필터링한 다음 ItemWriter 에 전달하는 타입</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/16.png">
          <img src="/assets/images/post/Spring/Batch/16.png" alt="" />
      </a>
    
  
  
</figure>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JobConfiguration</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JobBuilderFactory</span> <span class="n">jobBuilderFactory</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">StepBuilderFactory</span> <span class="n">stepBuilderFactory</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Job</span> <span class="nf">job</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"job"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">step1</span><span class="o">())</span>
                <span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="n">step2</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Step</span> <span class="nf">step1</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">stepBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"step1"</span><span class="o">)</span>
                <span class="o">.&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span><span class="n">chunk</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
                <span class="o">.</span><span class="na">reader</span><span class="o">(</span><span class="k">new</span> <span class="nc">ListItemReader</span><span class="o">&lt;&gt;(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">"item1"</span><span class="o">,</span> <span class="s">"item2"</span><span class="o">,</span> <span class="s">"item3"</span><span class="o">,</span> <span class="s">"item4"</span><span class="o">,</span> <span class="s">"item5"</span><span class="o">)))</span>
                <span class="o">.</span><span class="na">processor</span><span class="o">(</span><span class="k">new</span> <span class="nc">ItemProcessor</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">process</span><span class="o">(</span><span class="nc">String</span> <span class="n">item</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">);</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"item = "</span> <span class="o">+</span> <span class="n">item</span><span class="o">);</span>
                        <span class="k">return</span> <span class="n">item</span> <span class="o">+</span> <span class="s">" processed"</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">})</span>
                <span class="o">.</span><span class="na">writer</span><span class="o">(</span><span class="k">new</span> <span class="nc">ItemWriter</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">);</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"items = "</span> <span class="o">+</span> <span class="n">items</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">})</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="chunkorientedtasklet---개념-및-api-소개">ChunkOrientedTasklet - 개념 및 API 소개</h3>
<ul>
  <li>ChunkOrientedTasklet 은 스프링 배치에서 제공하는 Tasklet 의 구현체로서 Chunk 지향 프로세싱를 담당하는 도메인 객체</li>
  <li>ItemReader, ItemWriter, ItemProcessor 를 사용해 Chunk 기반의 데이터 입출력 처리를 담당한다.</li>
  <li>TaskletStep 에 의해서 반복적으로 실행되며 ChunkOrientedTasklet 이 실행 될 때마다 매번 새로운 트랜잭션이 생성되어 처리가 이루어진다.</li>
  <li>내부적으로 ItemReader 를 핸들링 하는 ChunkProvider 와 ItemProcessor, ItemWriter 를 핸들링하는 ChunkProcessor 타입의 구현체를 가진다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Step</span> <span class="nf">chunkStep</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">stepBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"chunkStep"</span><span class="o">)</span>
            <span class="o">.&lt;</span><span class="no">I</span><span class="o">,</span> <span class="no">O</span><span class="o">&gt;</span><span class="n">chunk</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span> <span class="c1">// chunk size 설정, chunk size 는 commit interval 을 의미함, input, output 제네릭타입 설정</span>
            <span class="o">.&lt;</span><span class="no">I</span><span class="o">,</span> <span class="no">O</span><span class="o">&gt;</span><span class="n">chunk</span><span class="o">(</span><span class="nc">CompletionPolicy</span><span class="o">)</span> <span class="c1">// Chunk 프로세스를 완료하기 위한 정책 설정 클래스 지정</span>
            <span class="o">.</span><span class="na">reader</span><span class="o">(</span><span class="n">itemReader</span><span class="o">())</span> <span class="c1">// 소스로 부터 item 을 읽거나 가져오는 ItemReader 구현체 설정</span>
            <span class="o">.</span><span class="na">writer</span><span class="o">(</span><span class="n">itemWriter</span><span class="o">())</span> <span class="c1">// item 을 목적지에 쓰거나 보내기 위한 ItemWriter 구현체 설정</span>
            <span class="o">.</span><span class="na">processor</span><span class="o">(</span><span class="n">itemProcessor</span><span class="o">())</span> <span class="c1">// item 을 변형, 가공, 필터링 하기 위한 ItemProcessor 구현체 설정</span>
            <span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="nc">ItemStream</span><span class="o">())</span> <span class="c1">// 재시작 데이터를 관리하는 콜백에 대한 스트림 등록</span>
            <span class="o">.</span><span class="na">readerIsTransactionalQueue</span><span class="o">()</span> <span class="c1">// Item 이 JMS, Message Queue Server 와 같은 트랜잭션 외부에서 읽혀지고 캐시할 것인지 여부, 기본값은 false</span>
            <span class="o">.</span><span class="na">listener</span><span class="o">(</span><span class="nc">ChunkListener</span><span class="o">)</span> <span class="c1">// Chunk 프로세스가 진행되는 특정 시점에 콜백 제공받도록 ChunkListener 설정</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="chunkorientedtasklet---chunkprovider--chunkprocessor">ChunkOrientedTasklet - ChunkProvider / ChunkProcessor</h3>
<h4 id="chunkprovider">ChunkProvider</h4>
<ul>
  <li>ItemReader 를 사용해서 소스로부터 아이템을 Chunk size 만큼 읽어서 Chunk 단위로 만들어 제공하는 도메인 객체</li>
  <li>Chunk<i> 를 만들고 내부적으로 반복문을 사용해서 ItemReader.read() 를 계속 호출하면서 item 을 Chunk 에 쌓는다.</i></li>
  <li>외부로 부터 ChunkProvider 가 호출될 때마다 항상 새로운 Chunk 가 생성된다.</li>
  <li>반복문 종료 시점: Chunk size 만큼 item 을 읽으면 반복문 종료되고 ChunkProcessor 로 넘어감, ItemReader 가 읽은 item 이 null 일 경우 반복문 종료 및 해당 Step 반복문까지 종료</li>
  <li>기본 구현체로서 SimpleChunkProvider 와 FaultTolerantChunkProvider 가 있다.</li>
</ul>

<h4 id="chunkprocessor">ChunkProcessor</h4>
<ul>
  <li>ItemProcessor 를 사용해서 Item 을 변형, 가공, 필터링하고 ItemWriter 를 사용해서 Chunk 데이터를 저장, 출력한다.</li>
  <li>Chunk<O> 를 만들고 앞에서 넘어온 Chunk<i> 의 item 을 한 건씩 처리한 후 Chunk<O> 에 저장한다.</O></i></O></li>
  <li>외부로 부터 ChunkProcessor 가 호출될 때마다 항상 새로운 Chunk 가 생성된다.</li>
  <li>ItemProcessor 는 설정 시 선택사항으로서 만약 객체가 존재하지 않을 경우 ItemReader 에서 읽은 item 그대로가 Chunk<O> 에 저장된다.</O></li>
  <li>ItemWriter 처리가 완료되면 Chunk 트랜잭션이 종료하게 되고 Step 반복문에서 ChunkOrientedTasklet 가 새롭게 실행된다.</li>
  <li>ItemWriter 는 Chunk size 만큼 데이터를 Commit 처리 하기 때문에 Chunk size 는 곧 Commit Interval 이 된다.</li>
  <li>기본 구현체로서 SimpleChunkProcessor 와 FaultTolerantChunkProcessor 가 있다.</li>
</ul>

<h3 id="itemreader--itemwriter--itemprocessor-이해">ItemReader / ItemWriter / ItemProcessor 이해</h3>
<h4 id="itemreader">ItemReader</h4>
<ul>
  <li>다양한 입력으로부터 데이터를 읽어서 제공하는 인터페이스
    <ul>
      <li>플랫(Flat) 파일 – csv, txt (고정 위치로 정의된 데이터 필드나 특수문자로 구별된 데이터의 행)</li>
      <li>XML, Json</li>
      <li>Database</li>
      <li>JMS, RabbitMQ 와 같은 Messag Queuing 서비스</li>
      <li>Custom Reader - 구현 시 멀티 스레드 환경에서 스레드에 안전하게 구현할 필요가 있음</li>
    </ul>
  </li>
  <li>아이템 하나를 리턴하며 더 이상 아이템이 없는 경우 null 리턴</li>
  <li>다수의 구현체들이 ItemReader 와 ItemStream 인터페이스를 동시에 구현하고 있음: 파일의 스트림을 열거나 종료, DB 커넥션을 열거나 종료, 입력 장치 초기화 등의 작업</li>
  <li>기본적으로 스레드에 안전하지 않기 때문에 병렬 처리시 데이터 정합성을 위한 동기화 처리 필요</li>
</ul>

<h4 id="itemwriter">ItemWriter</h4>
<ul>
  <li>Chunk 단위로 데이터를 받아 일괄 출력 작업을 위한 인터페이스
    <ul>
      <li>플랫(Flat) 파일 – csv, txt</li>
      <li>XML, Json</li>
      <li>Database</li>
      <li>JMS, RabbitMQ 와 같은 Messag Queuing 서비스</li>
      <li>Mail Service</li>
      <li>Custom Writer</li>
    </ul>
  </li>
  <li>다수의 구현체들이 ItemWriter 와 ItemStream 을 동시에 구현하고 있음: 파일의 스트림을 열거나 종료, DB 커넥션을 열거나 종료, 출력 장치 초기화 등의 작업</li>
</ul>

<h3 id="itemstream">ItemStream</h3>
<ul>
  <li>ItemReader 와 ItemWriter 처리 과정 중 상태를 저장하고 오류가 발생하면 해당 상태를 참조하여 실패한 곳에서 재 시작 하도록 지원</li>
  <li>리소스를 열고(open) 닫아야(close) 하며 입출력 장치 초기화 등의 작업을 해야 하는 경우</li>
  <li>ExecutionContext 를 매개변수로 받아서 상태 정보를 업데이트(update) 한다.</li>
  <li>ItemReader 및 ItemWriter 는 ItemStream 을 구현해야 한다.</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/17.png">
          <img src="/assets/images/post/Spring/Batch/17.png" alt="" />
      </a>
    
  
  
</figure>

<h2 id="스프링-배치-청크-프로세스-활용---itemreader">스프링 배치 청크 프로세스 활용 - ItemReader</h2>
<h3 id="flatfileitemreader---개념-및-api-소개">FlatFileItemReader - 개념 및 API 소개</h3>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/18.png">
          <img src="/assets/images/post/Spring/Batch/18.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>2차원 데이터(표)로 표현된 유형의 파일을 처리하는 ItemReader</li>
  <li>Resource 와 LineMapper 두 가지 요소가 필요하다.</li>
  <li>Resource
    <ul>
      <li>new FileSystemResource(“resource/path/config.xml”)</li>
      <li>new ClassPathResource(“classpath:path/config.xml)</li>
    </ul>
  </li>
  <li>LineMapper: 파일의 라인 한줄을 Object 로 변환해서 FlatFileItemReader 로 리턴한다. 단순히 문자열을 받기 때문에 문자열을 토큰화해서 객체로 매핑하는 과정이 필요하다. LineTokenizer 와 FieldSetMapper 를 사용해서 처리한다.
    <ul>
      <li>FieldSet: 라인을 필드로 구분해서 만든 배열 토큰을 전달하면 토큰 필드를 참조 할수 있도록 한다.</li>
      <li>LineTokenizer: 입력받은 라인을 FieldSet 으로 변환해서 리턴한다.</li>
      <li>FieldSetMapper: FieldSet 객체를 받아서 원하는 객체로 매핑해서 리턴한다.</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">FlatFileItemReader</span> <span class="nf">itemReader</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">FlatFileItemReaderBuilder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="c1">// 이름 설정, ExecutionContext 내에서 구분하기 위한 key 로 저장</span>
            <span class="o">.</span><span class="na">resource</span><span class="o">(</span><span class="nc">Resource</span><span class="o">)</span> <span class="c1">// 읽어야 할 리소스 설정</span>
            <span class="o">.</span><span class="na">delimited</span><span class="o">().</span><span class="na">delimiter</span><span class="o">(</span><span class="s">"|"</span><span class="o">)</span> <span class="c1">// 파일의 구분자를 기준으로 파일을 읽어들이는 설정</span>
            <span class="o">.</span><span class="na">fixedLength</span><span class="o">()</span> <span class="c1">// 파일의 고정길이를 기준으로 파일을 읽어들이는 설정</span>
            <span class="o">.</span><span class="na">addColumns</span><span class="o">(</span><span class="nc">Range</span><span class="o">..)</span> <span class="c1">// 고정길이 범위를 정하는 설정</span>
            <span class="o">.</span><span class="na">names</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">fieldNames</span><span class="o">)</span> <span class="c1">// LineTokenizer 로 구분된 라인의 항목을 객체의 필드명과 매핑하도록 설정</span>
            <span class="o">.</span><span class="na">targetType</span><span class="o">(</span><span class="nc">Class</span> <span class="kd">class</span><span class="err">)</span>  <span class="err">//</span> <span class="nc">라인의</span> <span class="n">각</span> <span class="n">항목과</span> <span class="n">매핑할</span> <span class="n">객체</span> <span class="n">타입</span> <span class="n">설정</span>
            <span class="o">.</span><span class="na">addComment</span><span class="o">(</span><span class="nc">String</span> <span class="nc">Comment</span><span class="o">)</span> <span class="c1">// 무시할 라인의 코멘트 기호 설정</span>
            <span class="o">.</span><span class="na">strict</span><span class="o">(</span> <span class="kt">boolean</span><span class="o">)</span> <span class="c1">// 라인을 읽거나 토큰화 할 때 Parsing 예외가 발생하지 않도록 검증 생략하도록 설정</span>
            <span class="o">.</span><span class="na">encoding</span><span class="o">(</span><span class="nc">String</span> <span class="n">encoding</span><span class="o">)</span> <span class="c1">// 파일 인코딩 설정</span>
            <span class="o">.</span><span class="na">linesToSkip</span><span class="o">(</span> <span class="kt">int</span> <span class="n">linesToSkip</span><span class="o">)</span> <span class="c1">// 파일 상단에 있는 무시할 라인 수 설정</span>
            <span class="o">.</span><span class="na">saveState</span><span class="o">(</span> <span class="kt">boolean</span><span class="o">)</span> <span class="c1">// 상태정보를 저장할 것인지 설정</span>
            <span class="o">.</span><span class="na">setLineMapper</span><span class="o">(</span><span class="nc">LineMapper</span><span class="o">)</span> <span class="c1">// LineMapper 객체 설정</span>
            <span class="o">.</span><span class="na">setFieldSetMapper</span><span class="o">(</span><span class="nc">FieldSetMapper</span><span class="o">)</span> <span class="c1">// FieldSetMapper 객체 설정</span>
            <span class="o">.</span><span class="na">setLineTokenizer</span><span class="o">(</span><span class="nc">LineTokenizer</span><span class="o">)</span> <span class="c1">// LineTokenizer 객체 설정</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">JobConfig</code></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JobConfiguration</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JobBuilderFactory</span> <span class="n">jobBuilderFactory</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">StepBuilderFactory</span> <span class="n">stepBuilderFactory</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Job</span> <span class="nf">job</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"job"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">step1</span><span class="o">())</span>
                <span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="n">step2</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Step</span> <span class="nf">step1</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">stepBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"step1"</span><span class="o">)</span>
                <span class="o">.&lt;</span><span class="nc">Customer</span><span class="o">,</span> <span class="nc">Customer</span><span class="o">&gt;</span><span class="n">chunk</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
                <span class="o">.</span><span class="na">reader</span><span class="o">(</span><span class="n">itemReader</span><span class="o">())</span>
                <span class="o">.</span><span class="na">writer</span><span class="o">(</span><span class="k">new</span> <span class="nc">ItemWriter</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Customer</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"items = "</span> <span class="o">+</span> <span class="n">items</span><span class="o">);</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"chunk"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">})</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ItemReader</span> <span class="nf">itemReader</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">FlatFileItemReader</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="n">itemReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FlatFileItemReader</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;();</span>
        <span class="n">itemReader</span><span class="o">.</span><span class="na">setResource</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassPathResource</span><span class="o">(</span><span class="s">"/customer.csv"</span><span class="o">));</span>

        <span class="nc">DefaultLineMapper</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="n">lineMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultLineMapper</span><span class="o">&lt;&gt;();</span>
        <span class="n">lineMapper</span><span class="o">.</span><span class="na">setTokenizer</span><span class="o">(</span><span class="k">new</span> <span class="nc">DelimitedLineTokenizer</span><span class="o">());</span>
        <span class="n">lineMapper</span><span class="o">.</span><span class="na">setFieldSetMapper</span><span class="o">(</span><span class="k">new</span> <span class="nc">CustomerFieldSetMapper</span><span class="o">());</span>

        <span class="n">itemReader</span><span class="o">.</span><span class="na">setLineMapper</span><span class="o">(</span><span class="n">lineMapper</span><span class="o">);</span>
        <span class="n">itemReader</span><span class="o">.</span><span class="na">setLinesToSkip</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">itemReader</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">DefaultLineMapper</code></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultLineMapper</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">LineMapper</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">LineTokenizer</span> <span class="n">tokenizer</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">FieldSetMapper</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">fieldSetMapper</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="no">T</span> <span class="nf">mapLine</span><span class="o">(</span><span class="nc">String</span> <span class="n">line</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lineNumber</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">fieldSetMapper</span><span class="o">.</span><span class="na">mapFieldSet</span><span class="o">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="na">tokenize</span><span class="o">(</span><span class="n">line</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTokenizer</span><span class="o">(</span><span class="nc">LineTokenizer</span> <span class="n">tokenizer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFieldSetMapper</span><span class="o">(</span><span class="nc">FieldSetMapper</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">fieldSetMapper</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">fieldSetMapper</span> <span class="o">=</span> <span class="n">fieldSetMapper</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">CustomerFieldSetMapper</code></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerFieldSetMapper</span> <span class="kd">implements</span> <span class="nc">FieldSetMapper</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Customer</span> <span class="nf">mapFieldSet</span><span class="o">(</span><span class="nc">FieldSet</span> <span class="n">fieldSet</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BindException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fieldSet</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">Customer</span> <span class="n">customer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Customer</span><span class="o">();</span>
        <span class="n">customer</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">fieldSet</span><span class="o">.</span><span class="na">readString</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
        <span class="n">customer</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="n">fieldSet</span><span class="o">.</span><span class="na">readInt</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
        <span class="n">customer</span><span class="o">.</span><span class="na">setYear</span><span class="o">(</span><span class="n">fieldSet</span><span class="o">.</span><span class="na">readInt</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>

        <span class="k">return</span> <span class="n">customer</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="flatfileitemreader---delimetedlinetokenizer">FlatFileItemReader - delimetedlinetokenizer</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">ItemReader</span> <span class="nf">itemReader</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">FlatFileItemReaderBuilder</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"flatFile"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">resource</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassPathResource</span><span class="o">(</span><span class="s">"/customer.csv"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">fieldSetMapper</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanWrapperFieldSetMapper</span><span class="o">&lt;&gt;())</span>
            <span class="o">.</span><span class="na">targetType</span><span class="o">(</span><span class="nc">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">linesToSkip</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
            <span class="o">.</span><span class="na">delimited</span><span class="o">().</span><span class="na">delimiter</span><span class="o">(</span><span class="s">","</span><span class="o">)</span>
            <span class="o">.</span><span class="na">names</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"age"</span><span class="o">,</span> <span class="s">"year"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="flatfileitemreader---fixedlengthtokenizer">FlatFileItemReader - fixedlengthtokenizer</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">ItemReader</span> <span class="nf">itemReader</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">FlatFileItemReaderBuilder</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"flatFile"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">resource</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileSystemResource</span><span class="o">(</span><span class="s">"/Users/hyungwook/Desktop/Spring/batch/spring-batch/src/main/resources/customer.csv"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">fieldSetMapper</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanWrapperFieldSetMapper</span><span class="o">&lt;&gt;())</span>
            <span class="o">.</span><span class="na">targetType</span><span class="o">(</span><span class="nc">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">linesToSkip</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
            <span class="o">.</span><span class="na">fixedLength</span><span class="o">()</span>
            <span class="o">.</span><span class="na">addColumns</span><span class="o">(</span><span class="k">new</span> <span class="nc">Range</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">5</span><span class="o">))</span>
            <span class="o">.</span><span class="na">addColumns</span><span class="o">(</span><span class="k">new</span> <span class="nc">Range</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span><span class="mi">9</span><span class="o">))</span>
            <span class="o">.</span><span class="na">addColumns</span><span class="o">(</span><span class="k">new</span> <span class="nc">Range</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span><span class="mi">11</span><span class="o">))</span>
            <span class="o">.</span><span class="na">names</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"age"</span><span class="o">,</span> <span class="s">"year"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="exception-handling">Exception Handling</h3>
<ul>
  <li>라인을 읽거나 토큰화 할 때 발생하는 Parsing 예외를 처리할 수 있도록 예외 계층 제공</li>
  <li>토큰화 검증을 엄격하게 적용하지 않도록 설정하면 Parsing 예외가 발생하지 않도록 할 수 있다.</li>
  <li>FlatFileParseException: ItemReader 에서 파일을 읽어들이는 동안 발생 하는 예외</li>
  <li>FlatFileFormatException: LineTokenizer 에서 토큰화 하는 도중 발생하는 예외, FlatFileParseException 보다 좀 더 구체적인 예외</li>
  <li>IncorrectTokenCountException: DelimitedLineTokenizer 로 토큰화 할 때 컬럼 개수와 실제 토큰화 한 컬럼 수와 다를 때 발생하는 예외</li>
  <li>IncorrectLineLengthException: FixedLengthLineTokenizer 으로 토큰화 할 때 라인 전체 길이와 컬럼 길이의 총합과 일치하지 않을 때 발생</li>
  <li><code class="language-plaintext highlighter-rouge">tokenizer.setStrict(false)</code>
    <ul>
      <li>LineTokenizer 의 Strict 속성을 false 로 설정하게 되면 Tokenizer 가 라인 길이를 검증하지 않는다.</li>
      <li>Tokenizer 가 라인 길이나 컬럼명을 검증하지 않을 경우 예외가 발생하지 않는다.</li>
      <li>FieldSet 은 성공적으로 리턴이 되며 두번째 범위 값은 빈 토큰을 가지게 된다.</li>
    </ul>
  </li>
</ul>

<h3 id="json---jsonitemreader">Json - JsonItemReader</h3>
<ul>
  <li>Json 데이터의 Parsing 과 Binding 을 JsonObjectReader 인터페이스 구현체에 위임하여 처리하는 ItemReader</li>
  <li>두 가지 JsonObjectReader 구현체 제공: JacksonJsonObjectReader, GsonJsonObjectReader</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">ItemReader</span> <span class="nf">itemReader</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">JsonItemReaderBuilder</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"jsonReader"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">resource</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassPathResource</span><span class="o">(</span><span class="s">"customer.csv"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">jsonObjectReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">JacksonJsonObjectReader</span><span class="o">&lt;&gt;(</span><span class="nc">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="db---cursor--paging-이해">DB - Cursor &amp; Paging 이해</h3>
<ul>
  <li>배치 어플리케이션은 실시간적 처리가 어려운 대용량 데이터를 다루며 이 때 DB I/O 의 성능문제와 메모리 자원의 효율성 문제를 해결할 수 있어야 한다.</li>
  <li>스프링 배치에서는 대용량 데이터 처리를 위한 두 가지 해결방안을 제시하고 있다.</li>
  <li>Cursor Based 처리
    <ul>
      <li>현재 행에 커서를 유지하며 다음 데이터를 호출하면 다음 행으로 커서를 이동하며 데이터 반환이 이루어지는 Streaming 방식의 I/O 이다.</li>
      <li>ResultSet이 open 될 때마다 next() 메소드가 호출 되어 Database의 데이터가 반환되고 객체와 매핑이 이루어진다.</li>
      <li>DB Connection 이 연결되면 배치 처리가 완료될 때 까지 데이터를 읽어오기 때문에 DB와 SocketTimeout을 충분히 큰 값으로 설정 필요</li>
      <li>모든 결과를 메모리에 할당하기 때문에 메모리 사용량이 많아지는 단점이 있다.</li>
    </ul>
  </li>
  <li>Paging Based 처리
    <ul>
      <li>페이징 단위로 데이터를 조회하는 방식으로 Page Size 만큼 한번에 메모리로 가지고 온 다음 한 개씩 읽는다.</li>
      <li>한 페이지를 읽을때마다 Connection을 맺고 끊기 때문에 대량의 데이터를 처리하더라도 SocketTimeout 예외가 거의 일어나지 않는다.</li>
      <li>시작 행 번호를 지정하고 페이지에 반환시키고자 하는 행의 수를 지정한 후 사용 – Offset, Limit</li>
      <li>페이징 단위의 결과만 메모리에 할당하기 때문에 메모리 사용량이 적어지는 장점이 있다.</li>
    </ul>
  </li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/19.png">
          <img src="/assets/images/post/Spring/Batch/19.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="db---jdbccursoritemreader">DB - JdbcCursorItemReader</h3>
<ul>
  <li>Cursor 기반의 JDBC 구현체로서 ResultSet 과 함께 사용되며 Datasource 에서 Connection 을 얻어와서 SQL 을 실행한다.</li>
  <li>Thread 안정성을 보장하지 않기 때문에 멀티 스레드 환경에서 사용할 경우 동시성 이슈가 발생하지 않도록 별도 동기화 처리가 필요하다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">JdbcCursorItemReader</span> <span class="nf">itemReader</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">JdbcCursorItemReaderBuilder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"cursorItemReader"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">fetchSize</span><span class="o">(</span><span class="kt">int</span> <span class="n">chunkSize</span><span class="o">)</span> <span class="c1">// Cursor 방식으로 데이터를 가지고 올 때 한번에 메모리에 할당할 크기를 설정한다</span>
            <span class="o">.</span><span class="na">dataSource</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">)</span> <span class="c1">// DB 에 접근하기 위해 Datasource 설정</span>
            <span class="o">.</span><span class="na">rowMapper</span><span class="o">(</span><span class="nc">RowMapper</span><span class="o">)</span> <span class="c1">// 쿼리 결과로 반환되는 데이터와 객체를 매핑하기 위한 RowMapper 설정</span>
            <span class="o">.</span><span class="na">beanRowMapper</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;)</span> <span class="c1">// 별도의 RowMapper 을 설정하지 않고 클래스 타입을 설정하면 자동으로 객체와 매핑</span>
            <span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="nc">String</span> <span class="n">sql</span><span class="o">)</span> <span class="c1">// ItemReader 가 조회 할 때 사용할 쿼리 문장 설정</span>
            <span class="o">.</span><span class="na">queryArguments</span><span class="o">(</span><span class="nc">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="c1">// 쿼리 파라미터 설정</span>
            <span class="o">.</span><span class="na">maxItemCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="c1">// 조회 할 최대 item 수</span>
            <span class="o">.</span><span class="na">currentItemCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="c1">// 조회 Item의 시작 지점</span>
            <span class="o">.</span><span class="na">maxRows</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxRows</span><span class="o">)</span> <span class="c1">// ResultSet 오브젝트가 포함 할 수 있는 최대 행 수</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/20.png">
          <img src="/assets/images/post/Spring/Batch/20.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="db---jpacursoritemreader">DB - JpaCursorItemReader</h3>
<ul>
  <li>Cursor 기반의 JPA 구현체로서 EntityManagerFactory 객체가 필요하며 쿼리는 JPQL 을 사용한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">JpaCursorItemReader</span> <span class="nf">itemReader</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">JpaCursorItemReaderBuilder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"cursorItemReader"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="nc">String</span> <span class="no">JPQL</span><span class="o">)</span> <span class="c1">// ItemReader 가 조회 할 때 사용할 JPQL 문장 설정</span>
            <span class="o">.</span><span class="na">EntityManagerFactory</span><span class="o">(</span><span class="nc">EntityManagerFactory</span><span class="o">)</span> <span class="c1">// JPQL 을 실행하는 EntityManager 를 생성하는 팩토리</span>
            <span class="o">.</span><span class="na">parameterValue</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="o">)</span> <span class="c1">// 쿼리 파라미터 설정</span>
            <span class="o">.</span><span class="na">maxItemCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="c1">// 조회 할 최대 item 수 </span>
            <span class="o">.</span><span class="na">currentItemCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="c1">// 조회 Item의 시작 지점</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/21.png">
          <img src="/assets/images/post/Spring/Batch/21.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="db---jdbcpagingitemreader">DB - JdbcPagingItemReader</h3>
<ul>
  <li>Paging 기반의 JDBC 구현체로서 쿼리에 시작 행 번호 (offset) 와 페이지에서 반환 할 행 수 (limit)를 지정해서 SQL 을 실행한다.</li>
  <li>스프링 배치에서 offset과 limit을 PageSize에 맞게 자동으로 생성해 주며 페이징 단위로 데이터를 조회할 때 마다 새로운 쿼리가 실행한다.</li>
  <li>멀티 스레드 환경에서 Thread 안정성을 보장하기 때문에 별도의 동기화를 할 필요가 없다.</li>
  <li>PagingQueryProvider
    <ul>
      <li>쿼리 실행에 필요한 쿼리문을 ItemReader 에게 제공하는 클래스</li>
      <li>데이터베이스마다 페이징 전략이 다르기 때문에 각 데이터 베이스 유형마다 다른 PagingQueryProvider 를 사용한다.</li>
      <li>Select 절, from 절, sortKey 는 필수로 설정해야 하며 where, group by 절은 필수가 아니다.</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">JdbcPagingItemReader</span> <span class="nf">itemReader</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">JdbcPagingItemReaderBuilder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"pagingItemReader"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">pageSize</span><span class="o">(</span><span class="kt">int</span> <span class="n">pageSize</span><span class="o">)</span>
            <span class="o">.</span><span class="na">dataSource</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">)</span>
            <span class="o">.</span><span class="na">queryProvider</span><span class="o">(</span><span class="nc">PagingQueryProvider</span><span class="o">)</span> <span class="c1">// DB 페이징 전략에 따른 PagingQueryProvider 설정</span>
            <span class="o">.</span><span class="na">rowMapper</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;)</span>
            <span class="o">.</span><span class="na">selectClause</span><span class="o">(</span><span class="nc">String</span> <span class="n">selectClause</span><span class="o">)</span>
            <span class="o">.</span><span class="na">fromClause</span><span class="o">(</span><span class="nc">String</span> <span class="n">fromClause</span><span class="o">)</span>
            <span class="o">.</span><span class="na">whereClause</span><span class="o">(</span><span class="nc">String</span> <span class="n">whereClause</span><span class="o">)</span>
            <span class="o">.</span><span class="na">groupClause</span><span class="o">(</span><span class="nc">String</span> <span class="n">groupClause</span><span class="o">)</span>
            <span class="o">.</span><span class="na">sortKeys</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Order</span><span class="o">&gt;</span> <span class="n">sortKeys</span><span class="o">)</span>
            <span class="o">.</span><span class="na">parameterValues</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="o">)</span>
            <span class="o">.</span><span class="na">maxItemCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span>
            <span class="o">.</span><span class="na">currentItemCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span>
            <span class="o">.</span><span class="na">maxRows</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxRows</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="db---jpapagingitemreader">DB - JpaPagingItemReader</h3>
<ul>
  <li>Paging 기반의 JPA 구현체로서 EntityManagerFactory 객체가 필요하며 쿼리는 JPQL 을 사용한다. 동기화 문제에 안전하다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">ItemReader</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Customer</span><span class="o">&gt;</span> <span class="nf">customerItemReader</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">JpaPagingItemReaderBuilder</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"itemReader"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">entityManagerFactory</span><span class="o">(</span><span class="n">entityManagerFactory</span><span class="o">)</span>
            <span class="o">.</span><span class="na">pageSize</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
            <span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="s">"select c from Customer c join fetch c.address"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="itemreaderadapter">ItemReaderAdapter</h3>
<ul>
  <li>배치 Job 안에서 이미 있는 DAO 나 다른 서비스를 ItemReader 안에서 사용하고자 할 때 위임 역할을 한다.</li>
  <li>targetObject의 targetMethod 에서 반환하는 객체를 Chunk에 저장한다.</li>
</ul>

<h2 id="스프링-배치-청크-프로세스-활용---itemwriter">스프링 배치 청크 프로세스 활용 - ItemWriter</h2>
<ul>
  <li>Resource 와 LineAggregator 두 가지가 요소가 필요하다.</li>
  <li>LineAggregator
    <ul>
      <li>Item 을 받아서 String 으로 변환하여 리턴한다.</li>
      <li>FieldExtractor를 사용해서 처리할 수 있다.</li>
      <li>구현체: PassThroughLineAggregator, DelimitedLineAggregator, FormatterLineAggregator</li>
    </ul>
  </li>
  <li>FieldExtractor
    <ul>
      <li>전달 받은 Item 객체의 필드를 배열로 만들어서 제공하는 인터페이스</li>
      <li>구현체: BeanWrapperFieldExtractor, PassThroughFieldExtractor</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">FlatFileItemReader</span> <span class="nf">itemReader</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">FlatFileItemWriterBuilder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span>
            <span class="o">.</span><span class="na">resource</span><span class="o">(</span><span class="nc">Resource</span><span class="o">)</span>
            <span class="o">.</span><span class="na">lineAggregator</span><span class="o">(</span><span class="nc">LineAggregator</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;)</span> <span class="c1">// 객체를 String 으로 변환하는 LineAggregator 객체 설정</span>
            <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span> <span class="c1">// 존재하는 파일에 내용을 추가할 것인지 여부 설정</span>
            <span class="o">.</span><span class="na">fieldExtractor</span><span class="o">(</span><span class="nc">FieldExtractor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;)</span> <span class="c1">// 객체 필드를 추출해서 배열로 만드는 FieldExtrator 설정</span>
            <span class="o">.</span><span class="na">headerCallback</span><span class="o">(</span><span class="nc">FlatFileHeaderCallback</span><span class="o">)</span>
            <span class="o">.</span><span class="na">footerCallback</span><span class="o">(</span><span class="nc">FlatFileFooterCallback</span><span class="o">)</span>
            <span class="o">.</span><span class="na">shouldDeleteIfExists</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span> <span class="c1">// 파일이 이미 존재한다면 삭제</span>
            <span class="o">.</span><span class="na">shouldDeleteIfEmpty</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span> <span class="c1">// 파일의 내용이 비어 있다면 삭제</span>
            <span class="o">.</span><span class="na">delimited</span><span class="o">().</span><span class="na">delimiter</span><span class="o">(</span><span class="nc">String</span> <span class="n">delimiter</span><span class="o">)</span> <span class="c1">// 파일의 구분자를 기준으로 파일을 작성하도록 설정</span>
            <span class="o">.</span><span class="na">formatted</span><span class="o">().</span><span class="na">format</span><span class="o">(</span><span class="nc">String</span> <span class="n">format</span><span class="o">)</span> <span class="c1">// 파일의 고정길이를 기준으로 파일을 작성하도록 설정</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="jsonfileitemwriter">JsonFileItemWriter</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">JsonFileItemWriterBuilder</span> <span class="nf">itemReader</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">JsonFileItemWriterBuilder</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span>
            <span class="o">.</span><span class="na">resource</span><span class="o">(</span><span class="nc">Resource</span><span class="o">)</span>
            <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span>
            <span class="o">.</span><span class="na">jsonObjectMarshaller</span><span class="o">(</span><span class="nc">JsonObjectMarshaller</span><span class="o">)</span> <span class="c1">// JsonObjectMarshaller 객체 설정</span>
            <span class="o">.</span><span class="na">headerCallback</span><span class="o">(</span><span class="nc">FlatFileHeaderCallback</span><span class="o">)</span>
            <span class="o">.</span><span class="na">footerCallback</span><span class="o">(</span><span class="nc">FlatFileFooterCallback</span><span class="o">)</span>
            <span class="o">.</span><span class="na">shouldDeleteIfExists</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span>
            <span class="o">.</span><span class="na">shouldDeleteIfEmpty</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="db---jdbcbatchitemwriter">DB - JdbcBatchItemWriter</h3>
<ul>
  <li>JdbcCursorItemReader 설정과 마찬가지로 datasource 를 지정하고, sql 속성에 실행할 쿼리를 설정</li>
  <li>JDBC의 Batch 기능을 사용하여 bulk insert/update/delete 방식으로 처리(성능에 이점)</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/22.png">
          <img src="/assets/images/post/Spring/Batch/22.png" alt="" />
      </a>
    
  
  
</figure>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">JdbcBatchItemWriter</span> <span class="nf">itemWriter</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">JdbcBatchItemWriterBuilder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span>
            <span class="o">.</span><span class="na">datasource</span><span class="o">(</span><span class="nc">Datasource</span><span class="o">)</span>
            <span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="nc">String</span> <span class="n">sql</span><span class="o">)</span>
            <span class="o">.</span><span class="na">assertUpdates</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span> <span class="c1">// 트랜잭션 이후 적어도 하나의 항목이 행을 업데이트 혹은 삭제하지 않을 경우 예외발생여부를 설정함, 기본값은 true</span>
            <span class="o">.</span><span class="na">beanMapped</span><span class="o">()</span> <span class="c1">// Pojo 기반으로 Insert SQL의 Values를 매핑</span>
            <span class="o">.</span><span class="na">columnMapped</span><span class="o">()</span> <span class="c1">// Key,Value 기반으로 Insert SQL의 Values를 매핑</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="db---jpaitemwriter">DB - JpaItemWriter</h3>
<ul>
  <li>JPA Entity 기반으로 데이터를 처리하며 EntityManagerFactory 를 주입받아 사용한다.</li>
  <li>Entity를 하나씩 chunk 크기 만큼 insert 혹은 merge 한 다음 flush 한다.</li>
  <li>ItemReader 나 ItemProcessor 로 부터 아이템을 전발 받을 때는 Entity 클래스 타입으로 받아야 한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">JpaItemWriter</span> <span class="nf">itemWriter</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">JpaItemWriterBuilder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">usePersist</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span> <span class="c1">// Entity 를 persist() 할 것인지 여부 설정, false 이면 merge() 처리</span>
            <span class="o">.</span><span class="na">entityManagerFactory</span><span class="o">(</span><span class="nc">EntityManagerFactory</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="스프링-배치-청크-프로세스-활용---itemprocessor">스프링 배치 청크 프로세스 활용 - ItemProcessor</h2>
<h3 id="compositeitemprocessor">CompositeItemProcessor</h3>
<ul>
  <li>ItemProcessor 들을 연결(Chaining)해서 위임하면 각 ItemProcessor 를 실행시킨다.</li>
  <li>이전 ItemProcessor 반환 값은 다음 ItemProcessor 값 으로 연결된다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">ItemProcessor</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">customItemProcessor</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">List</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">CustomItemProcessor</span><span class="o">());</span>
    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">CustomItemProcessor2</span><span class="o">());</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nc">CompositeItemProcessorBuilder</span><span class="o">&lt;&gt;()</span>
            <span class="o">.</span><span class="na">delegates</span><span class="o">(</span><span class="n">list</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="목차-소개">목차 소개</h2>
<h3 id="repeat">Repeat</h3>
<ul>
  <li>특정 조건이 충족 될 때까지 (또는 특정 조건이 아직 충족되지 않을 때까지) Job 또는 Step 을 반복하도록 배치 애플리케이션을 구성 할 수 있다.</li>
  <li>스프링 배치에서는 Step 의 반복과 Chunk 반복을 RepeatOperation 을 사용해서 처리하고 있다.</li>
  <li>기본 구현체로 RepeatTemplate 를 제공한다.</li>
  <li>반복을 종료할 것인지 여부를 결정하는 세가지 항목
    <ul>
      <li>RepeatStatus: 스프링 배치의 처리가 끝났는지 판별하기 위한 열거형(enum), CONTINUABLE / FINISHED</li>
      <li>CompletionPolicy: RepeatTemplate 의 iterate 메소드 안에서 반복을 중단할지 결정, 정상 종료를 알리는데 사용된다. (여러가지 기본 구현제 제공))</li>
      <li>ExceptionHandler: RepeatCallback 안에서 예외가 발생하면 RepeatTemplate 가 ExceptionHandler 를 참조해서 예외를 다시 던질지 여부 결정, 예외를 받아서 다시 던지게 되면 반복 종료, 비정상 종료를 알리는데 사용된다. (여러가지 기본 구현체 제공)</li>
    </ul>
  </li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/23.png">
          <img src="/assets/images/post/Spring/Batch/23.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="faulttolerant">FaultTolerant</h3>
<ul>
  <li>스프링 배치는 Job 실행 중에 오류가 발생할 경우 장애를 처리하기 위한 기능을 제공하며 이를 통해 복원력을 향상시킬 수 있다.</li>
  <li>오류가 발생해도 Step 이 즉시 종료되지 않고 Retry 혹은 Skip 기능을 활성화 함으로써 내결함성 서비스가 가능하도록 한다.
    <ul>
      <li>Skip: ItemReader / ItemProcessor / ItemWriter 에 적용 할 수 있다.</li>
      <li>Retry: ItemProcessor / ItemWriter 에 적용할 수 있다.</li>
    </ul>
  </li>
  <li>FaultTolerant 구조는 청크 기반의 프로세스 기반위에 Skip 과 Retry 기능이 추가되어 재정의 되어 있다.</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/24.png">
          <img src="/assets/images/post/Spring/Batch/24.png" alt="" />
      </a>
    
  
  
</figure>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Step</span> <span class="nf">batchStep</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">stepBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"batchStep"</span><span class="o">)</span>
            <span class="o">.&lt;</span><span class="no">I</span><span class="o">,</span> <span class="no">O</span><span class="o">&gt;</span><span class="n">chunk</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
            <span class="o">.</span><span class="na">reader</span><span class="o">(</span><span class="nc">ItemReader</span><span class="o">)</span>
            <span class="o">.</span><span class="na">writer</span><span class="o">(</span><span class="nc">ItemWriter</span><span class="o">)</span>
            <span class="o">.</span><span class="na">falutTolerant</span><span class="o">()</span>
            <span class="o">.</span><span class="na">skip</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Throwable</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> 
            <span class="o">.</span><span class="na">skipLimit</span><span class="o">(</span><span class="kt">int</span> <span class="n">skipLimit</span><span class="o">)</span>
            <span class="o">.</span><span class="na">skipPolicy</span><span class="o">(</span><span class="nc">SkipPolicy</span> <span class="n">skipPolicy</span><span class="o">)</span> 
            <span class="o">.</span><span class="na">noSkip</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Throwable</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> 
            <span class="o">.</span><span class="na">retry</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Throwable</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> 
            <span class="o">.</span><span class="na">retryLimit</span><span class="o">(</span><span class="kt">int</span> <span class="n">retryLimit</span><span class="o">)</span>
            <span class="o">.</span><span class="na">retryPolicy</span><span class="o">(</span><span class="nc">RetryPolicy</span> <span class="n">retryPolicy</span><span class="o">)</span> 
            <span class="o">.</span><span class="na">backOffPolicy</span><span class="o">(</span><span class="nc">BackOffPolicy</span> <span class="n">backOffPolicy</span><span class="o">)</span> <span class="c1">// 다시 Retry 하기 까지의 지연시간 (단위:ms)을 설정</span>
            <span class="o">.</span><span class="na">noRetry</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Throwable</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> 
            <span class="o">.</span><span class="na">noRollback</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Throwable</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="c1">// 예외 발생 시 Rollback 하지 않을 예외 타입 설정</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="skip">Skip</h3>
<ul>
  <li>Skip은 데이터를 처리하는 동안 설정된 Exception이 발생했을 경우, 해당 데이터 처리를 건너뛰는 기능이다.</li>
  <li>ItemReader 는 예외가 발생하면 해당 아이템만 스킵하고 계속 진행한다.</li>
  <li>ItemProcessor 와 ItemWriter 는 예외가 발생하면 스킵된 아이템을 제외한 나머지 아이템들을 가지고 다시 처리하게 된다.</li>
  <li>Skip 기능은 내부적으로 SkipPolicy 를 통해서 구현되어 있다. 스프링 배치가 기본적으로 제공하는 SkipPolicy 구현체들이 있으며 필요 시 직접 생성해서 사용할 수 있다. 그리고 내부적으로 Classfier 클래스들을 활용하고 있다.
    <ul>
      <li>AlwaysSkipItemSkipPolicy: 항상 skip 한다.</li>
      <li>ExceptionClassifierSkipPolicy: 예외대상을 분류하여 skip 여부를 결정한다.</li>
      <li>CompositeSkipPolicy: 여러 SkipPolicy 를 탐색하면서 skip 여부를 결정한다.</li>
      <li>LimitCheckingItemSkipPolicy: Skip 카운터 및 예외 등록 결과에 따라 skip 여부를 결정한다.(기본값)</li>
      <li>NeverSkipItemSkipPolicy: skip 을 하지 않는다.</li>
    </ul>
  </li>
  <li>Skip 가능 여부를 판별하는 기준은 다음과 같다.
    <ul>
      <li>스킵 대상에 포함된 예외인지 여부</li>
      <li>스킵 카운터를 초과 했는지 여부</li>
    </ul>
  </li>
</ul>

<h3 id="retry">Retry</h3>
<ul>
  <li>Retry는 ItemProcess, ItemWriter 에서 설정된 Exception이 발생했을 경우, 지정한 정책에 따라 데이터 처리를 재시도하는 기능이다.</li>
  <li>오류 발생 시 재시도 설정에 의해서 Chunk 단계의 처음부터 다시 시작한다. 아이템은 ItemReader에서 캐시로 저장한 값을 사용한다.</li>
  <li>Retry가 가능한 경우 RetryCallback을 호출하고 Retry를 모두 소진한 경우 RecoveryCallback을 호출하여 Skip 여부 등을 결정한다.</li>
  <li>Skip시에는 Chunk의 처음이 아닌 ItemProcessor의 처음으로 돌아가서 해당 item을 제거한 list로 다시 작업을 진행한다.</li>
  <li>Retry 기능은 내부적으로 RetryPolicy 를 통해서 구현되어 있다. 또한 Item 별로 Retry 횟수를 카운트한다.</li>
  <li>Retry 가능 여부를 판별하는 기준
    <ul>
      <li>재시도 대상에 포함된 예외인지 여부</li>
      <li>재시도 카운터를 초과 했는지 여부</li>
    </ul>
  </li>
  <li>RetryPolicy
    <ul>
      <li>기본적으로 제공하는 RetryPolicy 구현체들이 있으며 필요 시 직접 생성해서 사용할 수 있다.</li>
      <li>SimpleRetryPolicy: 재시도 횟수 및 예외 등록 결과에 따라 재시도 여부를 결정한다. 기본값으로 설정된다.</li>
    </ul>
  </li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/25.png">
          <img src="/assets/images/post/Spring/Batch/25.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="skip--retry-architecture">Skip &amp; Retry Architecture</h3>

<figure class="half ">
  
    
      <a href="/assets/images/post/Spring/Batch/26.png">
          <img src="/assets/images/post/Spring/Batch/26.png" alt="" />
      </a>
    
  
    
      <a href="/assets/images/post/Spring/Batch/27.png">
          <img src="/assets/images/post/Spring/Batch/27.png" alt="" />
      </a>
    
  
    
      <a href="/assets/images/post/Spring/Batch/28.png">
          <img src="/assets/images/post/Spring/Batch/28.png" alt="" />
      </a>
    
  
  
</figure>

<h2 id="스프링-배치-멀티-스레드-프로세싱">스프링 배치 멀티 스레드 프로세싱</h2>
<h3 id="기본-개념">기본 개념</h3>
<ul>
  <li>TaskExecutorRepeatTemplate의 TaskExecutor가 ThreadPoll 에서 쓰레드를 통해 ExecutingRunnable 의 <code class="language-plaintext highlighter-rouge">run()</code> 메소드를 실행시킨다. 해당 메소드 안에서 ChunkOrientedTasklet이 실행된다.</li>
  <li>스프링 배치는 기본적으로 단일 스레드 방식으로 작업을 처리한다.</li>
  <li>성능 향상과 대규모 데이터 작업를 위한 비동기 처리 및 Scale out 기능을 제공한다.</li>
  <li>AsyncItemProcessor / AsyncItemWriter: ItemProcessor 에게 별도의 스레드가 할당되어 작업을 처리하는 방식</li>
  <li>Multi-threaded Step: Step 내 Chunk 구조인 ItemReader, ItemProcessor, ItemWriter 마다 여러 스레드가 할당되어 실행 하는 방법</li>
  <li>Parallel Steps: Step 마다 스레드가 할당되어 여러개의 Step을 병렬로 실행하는 방법</li>
  <li>Partitioning: Master/Slave 방식으로서 Master 가 데이터를 파티셔닝 한 다음 각 파티션에게(각 Step) 스레드를 할당하여 Slave 가 독립적으로 작동하는 방식</li>
</ul>

<h3 id="asyncitemprocessor--asyncitemwriter">AsyncItemProcessor / AsyncItemWriter</h3>
<ul>
  <li>Step 안에서 ItemProcessor 가 비동기적으로 동작하는 구조</li>
  <li>AsyncItemProcessor 와 AsyncItemWriter 가 함께 구성이 되어야 함.</li>
  <li>AsyncItemProcessor 로부터 AsyncItemWriter 가 받는 최종 결과값은 <code class="language-plaintext highlighter-rouge">List&lt;Future&lt;T&gt;&gt;</code> 타입이며 비동기 실행이 완료될 때까지 대기한다.</li>
  <li>spring-batch-integration 의존성이 필요하다.</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">implementation 'org.springframework.batch:spring-batch-integration'</span>
</code></pre></div></div>
<ul>
  <li>AsyncItemWriter 는 비동기 실행 결과 값들을 모두 받아오기 까지 대기해야 한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="o">(</span><span class="nc">Future</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">:</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span> 
  <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>AsyncItemProcessor: 내부적으로 실제 ItemProcessor 에게 실행을 위임하고 결과를 Future 에 저장한다.</li>
  <li>AsyncItemWriter: 내부적으로 실제 ItemWriter 에게 최종 결과값을 넘겨주고 실행을 위임한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Nullable</span>
<span class="kd">public</span> <span class="nc">Future</span><span class="o">&lt;</span><span class="no">O</span><span class="o">&gt;</span> <span class="nf">process</span><span class="o">(</span><span class="kd">final</span> <span class="no">I</span> <span class="n">item</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">StepExecution</span> <span class="n">stepExecution</span> <span class="o">=</span> <span class="n">getStepExecution</span><span class="o">();</span>
    <span class="nc">FutureTask</span><span class="o">&lt;</span><span class="no">O</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FutureTask</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="no">O</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="no">O</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">stepExecution</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">StepSynchronizationManager</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">stepExecution</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">finally</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">stepExecution</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">StepSynchronizationManager</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">});</span>
    <span class="n">taskExecutor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">task</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<h3 id="multi-threaded-step">Multi-threaded Step</h3>
<ul>
  <li>Step 내에서 멀티 스레드로 Chunk 기반 처리가 이루어지는 구조</li>
  <li>TaskExecutorRepeatTemplate 이 반복자로 사용되며 설정한 개수 (throttleLimit) 만큼의 스레드를 생성하여 수행한다.</li>
  <li>ItemReader 는 Thread-safe 인지 반드시 확인해야 한다. 데이터를 소스로 부터 읽어오는 역할이기 때문에 스레드마다 중복해서 데이터를 읽어오지 않도록 동기화가 보장되어야 한다.</li>
  <li>스레드마다 새로운 Chunk 가 할당되어 데이터 동기화가 보장된다. 스레드끼리 Chunk 를 서로 공유하지 않는다.</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/29.png">
          <img src="/assets/images/post/Spring/Batch/29.png" alt="" />
      </a>
    
  
  
</figure>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">Step</span> <span class="nf">step1</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">stepBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"step1"</span><span class="o">)</span>
            <span class="o">.&lt;</span><span class="nc">Customer</span><span class="o">,</span> <span class="nc">Customer2</span><span class="o">&gt;</span><span class="n">chunk</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
            <span class="o">.</span><span class="na">reader</span><span class="o">(</span><span class="n">itemReader</span><span class="o">())</span>
            <span class="o">.</span><span class="na">processor</span><span class="o">(</span><span class="k">new</span> <span class="nc">ItemProcessor</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">,</span> <span class="nc">Customer2</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="nc">Customer2</span> <span class="nf">process</span><span class="o">(</span><span class="nc">Customer</span> <span class="n">customer</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nf">Customer2</span><span class="o">(</span><span class="n">customer</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">})</span>
            <span class="o">.</span><span class="na">writer</span><span class="o">(</span><span class="n">customItemWriter</span><span class="o">)</span>
            <span class="o">.</span><span class="na">taskExecutor</span><span class="o">(</span><span class="n">taskExecutor</span><span class="o">())</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">TaskExecutor</span> <span class="nf">taskExecutor</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ThreadPoolTaskExecutor</span> <span class="n">threadPoolTaskExecutor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskExecutor</span><span class="o">();</span>
    <span class="n">threadPoolTaskExecutor</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
    <span class="n">threadPoolTaskExecutor</span><span class="o">.</span><span class="na">setMaxPoolSize</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
    <span class="n">threadPoolTaskExecutor</span><span class="o">.</span><span class="na">setThreadNamePrefix</span><span class="o">(</span><span class="s">"async-thread"</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">threadPoolTaskExecutor</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="parallel-steps">Parallel Steps</h3>
<ul>
  <li>SplitState 를 사용해서 여러 개의 Flow 들을 병렬적으로 실행하는 구조</li>
  <li>실행이 다 완료된 후 FlowExecutionStatus 결과들을 취합해서 다음 단계 결정을 한다.</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/30.png">
          <img src="/assets/images/post/Spring/Batch/30.png" alt="" />
      </a>
    
  
  
</figure>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">Job</span> <span class="nf">job</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"job"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">flow1</span><span class="o">())</span>
            <span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="n">taskExecutor</span><span class="o">()).</span><span class="na">add</span><span class="o">(</span><span class="n">flow2</span><span class="o">())</span>
            <span class="o">.</span><span class="na">end</span><span class="o">()</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>flow1 과 flow2 가 병렬처리된다.</li>
</ul>

<h3 id="partitioning">Partitioning</h3>
<ul>
  <li>MasterStep(PartitionStep) 이 SlaveStep 을 실행시키는 구조</li>
  <li>SlaveStep 은 각 스레드에 의해 독립적으로 실행이 됨</li>
  <li>SlaveStep은 독립적인 StepExecution 파라미터 환경을 구성함</li>
  <li>SlaveStep은 ItemReader / ItemProcessor / ItemWriter 등을 가지고 동작하며 작업을 독립적으로 병렬 처리한다.</li>
  <li>MasterStep 은 PartitionStep 이며 SlaveStep 은 TaskletStep, FlowStep 등이 올 수 있다.</li>
  <li>PartitionStep
    <ul>
      <li>파티셔닝 기능을 수행하는 Step 구현체</li>
      <li>파티셔닝을 수행 후 StepExecutionAggregator 를 사용해서 StepExecution 의 정보를 최종 집계한다</li>
    </ul>
  </li>
  <li>PartitionHandler
    <ul>
      <li>PartitionStep 에 의해 호출되며 스레드를 생성해서 WorkStep 을 병렬로 실행한다.</li>
      <li>WorkStep 에서 사용할 StepExecution 생성은 StepExecutionSplitter 과 Partitioner에게 위임한다.</li>
    </ul>
  </li>
  <li>StepExecutionSplitter
    <ul>
      <li>WorkStep 에서 사용할 StepExecution 을 gridSize 만큼 생성한다.</li>
      <li>Partitioner 를 통해 ExecutionContext 를 얻어서 StepExecution 에 매핑한다.</li>
    </ul>
  </li>
  <li>Partitioner
    <ul>
      <li>StepExecution 에 매핑 할 ExecutionContext 를 gridsize 만큼 생성한다.</li>
      <li>각 ExecutionContext 에 저장된 정보는 WorkStep 을 실행하는 스레드마다 독립적으로 참조 및 활용 가능하다.</li>
    </ul>
  </li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/31.png">
          <img src="/assets/images/post/Spring/Batch/31.png" alt="" />
      </a>
    
  
  
</figure>

<ul>
  <li>각 스레드는 자신에게 할당된 StepExecution 을 가지고 있다.</li>
  <li>각 스레드는 자신에게 할당된 청크 클래스를 참조한다.</li>
  <li>Thread-safe 를 만족한다.</li>
  <li><code class="language-plaintext highlighter-rouge">jobConfig</code></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JobConfiguration</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JobBuilderFactory</span> <span class="n">jobBuilderFactory</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">StepBuilderFactory</span> <span class="n">stepBuilderFactory</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">EntityManagerFactory</span> <span class="n">entityManagerFactory</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CustomItemWriter</span> <span class="n">customItemWriter</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CustomTasklet</span> <span class="n">customTasklet</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Job</span> <span class="nf">job</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"job"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">masterStep</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Step</span> <span class="nf">masterStep</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">stepBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"masterStep"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">partitioner</span><span class="o">(</span><span class="s">"slaveStep"</span><span class="o">,</span> <span class="n">partitioner</span><span class="o">())</span>
                <span class="o">.</span><span class="na">step</span><span class="o">(</span><span class="n">slaveStep</span><span class="o">())</span>
                <span class="o">.</span><span class="na">gridSize</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
                <span class="o">.</span><span class="na">taskExecutor</span><span class="o">(</span><span class="n">taskExecutor</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Step</span> <span class="nf">slaveStep</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">stepBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"slaveStep"</span><span class="o">)</span>
                <span class="o">.&lt;</span><span class="nc">Customer</span><span class="o">,</span> <span class="nc">Customer2</span><span class="o">&gt;</span><span class="n">chunk</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
                <span class="o">.</span><span class="na">reader</span><span class="o">(</span><span class="n">itemReader</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span>
                <span class="o">.</span><span class="na">processor</span><span class="o">(</span><span class="k">new</span> <span class="nc">ItemProcessor</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">,</span> <span class="nc">Customer2</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">Customer2</span> <span class="nf">process</span><span class="o">(</span><span class="nc">Customer</span> <span class="n">item</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="k">new</span> <span class="nf">Customer2</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">})</span>
                <span class="o">.</span><span class="na">writer</span><span class="o">(</span><span class="n">customItemWriter</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="nd">@StepScope</span>
    <span class="kd">public</span> <span class="nc">ItemStreamReader</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Customer</span><span class="o">&gt;</span> <span class="nf">itemReader</span><span class="o">(</span>
            <span class="nd">@Value</span><span class="o">(</span><span class="s">"#{stepExecutionContext['minValue']}"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">minValue</span><span class="o">,</span>
            <span class="nd">@Value</span><span class="o">(</span><span class="s">"#{stepExecutionContext['maxValue']}"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">maxValue</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"minValue"</span><span class="o">,</span> <span class="n">minValue</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"maxValue"</span><span class="o">,</span> <span class="n">maxValue</span><span class="o">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nc">JpaPagingItemReaderBuilder</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;()</span>
                <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"itemReader"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">pageSize</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
                <span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="s">"select c from Customer c where customer_id &gt;= :minValue and customer_id &lt;= :maxValue"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">entityManagerFactory</span><span class="o">(</span><span class="n">entityManagerFactory</span><span class="o">)</span>
                <span class="o">.</span><span class="na">parameterValues</span><span class="o">(</span><span class="n">map</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Partitioner</span> <span class="nf">partitioner</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ColumnRangePartitioner</span> <span class="n">columnRangePartitioner</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ColumnRangePartitioner</span><span class="o">();</span>
        <span class="n">columnRangePartitioner</span><span class="o">.</span><span class="na">setColumn</span><span class="o">(</span><span class="s">"customer_id"</span><span class="o">);</span>
        <span class="n">columnRangePartitioner</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
        <span class="n">columnRangePartitioner</span><span class="o">.</span><span class="na">setTable</span><span class="o">(</span><span class="s">"Customer"</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">columnRangePartitioner</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">TaskExecutor</span> <span class="nf">taskExecutor</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ThreadPoolTaskExecutor</span> <span class="n">threadPoolTaskExecutor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskExecutor</span><span class="o">();</span>
        <span class="n">threadPoolTaskExecutor</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
        <span class="n">threadPoolTaskExecutor</span><span class="o">.</span><span class="na">setMaxPoolSize</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
        <span class="n">threadPoolTaskExecutor</span><span class="o">.</span><span class="na">setThreadNamePrefix</span><span class="o">(</span><span class="s">"async-thread"</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">threadPoolTaskExecutor</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">ColumnRangePartitioner</code></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ColumnRangePartitioner</span> <span class="kd">implements</span> <span class="nc">Partitioner</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">JdbcOperations</span> <span class="n">jdbcTemplate</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">table</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">column</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTable</span><span class="o">(</span><span class="nc">String</span> <span class="n">table</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setColumn</span><span class="o">(</span><span class="nc">String</span> <span class="n">column</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">column</span> <span class="o">=</span> <span class="n">column</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDataSource</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">jdbcTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JdbcTemplate</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ExecutionContext</span><span class="o">&gt;</span> <span class="nf">partition</span><span class="o">(</span><span class="kt">int</span> <span class="n">gridSize</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="s">"SELECT MIN("</span> <span class="o">+</span> <span class="n">column</span> <span class="o">+</span> <span class="s">") from "</span> <span class="o">+</span> <span class="n">table</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="s">"SELECT MAX("</span> <span class="o">+</span> <span class="n">column</span> <span class="o">+</span> <span class="s">") from "</span> <span class="o">+</span> <span class="n">table</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">targetSize</span> <span class="o">=</span> <span class="o">(</span><span class="n">max</span> <span class="o">-</span> <span class="n">min</span><span class="o">)</span> <span class="o">/</span> <span class="n">gridSize</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>

        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ExecutionContext</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ExecutionContext</span><span class="o">&gt;();</span>
        <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">min</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">targetSize</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">ExecutionContext</span> <span class="n">value</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExecutionContext</span><span class="o">();</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"partition"</span> <span class="o">+</span> <span class="n">number</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">end</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">max</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">value</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="s">"minValue"</span><span class="o">,</span> <span class="n">start</span><span class="o">);</span>
            <span class="n">value</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="s">"maxValue"</span><span class="o">,</span> <span class="n">end</span><span class="o">);</span>
            <span class="n">start</span> <span class="o">+=</span> <span class="n">targetSize</span><span class="o">;</span>
            <span class="n">end</span> <span class="o">+=</span> <span class="n">targetSize</span><span class="o">;</span>
            <span class="n">number</span><span class="o">++;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="synchronizeditemstreamreader">SynchronizedItemStreamReader</h3>
<ul>
  <li>Thread-safe 하지 않은 ItemReader 를 Thread-safe 하게 처리하도록 하는 역할을 한다.</li>
  <li>DB에서 동일한 item을 읽어와서 중복 저장되는 것을 방지한다.</li>
</ul>

<h2 id="스프링-배치-이벤트-리스너">스프링 배치 이벤트 리스너</h2>
<h3 id="기본개념">기본개념</h3>
<ul>
  <li>Listener 는 배치 흐름 중에 Job, Step, Chunk 단계의 실행 전후에 발생하는 이벤트를 받아 용도에 맞게 활용할 수 있도록 제공하는 인터셉터 개념의 클래스</li>
  <li>각 단계별로 로그기록을 남기거나 소요된 시간을 계산하거나 실행상태 정보들을 참조 및 조회 할 수 있다.</li>
  <li>이벤트를 받기 위해서는 Listener 를 등록해야 하며 등록은 API 설정에서 각 단계별로 지정 할 수 있다.</li>
  <li>Job
    <ul>
      <li>JobExecutionListener – Job 실행 전후</li>
    </ul>
  </li>
  <li>Step
    <ul>
      <li>StepExecutionListener – Step 실행 전후</li>
      <li>ChunkListener – Chunk 실행 전후 (Tasklet 실행 전후) , 오류 시점</li>
      <li>ItemReadListener – ItemReader 실행 전후, 오류 시점, item 이 null 일 경우 호출 안됨</li>
      <li>ItemProcessListener – ItemProcessor 실행 전후, 오류 시점, item 이 null 일 경우 호출 안됨</li>
      <li>ItemWriteListener – ItemWriter 실행 전후, 오류 시점, item 이 null 일 경우 호출 안됨</li>
    </ul>
  </li>
  <li>SkipListener – 읽기, 쓰기, 처리 Skip 실행 시점, Item 처리가 Skip 될 경우 Skip 된 item을 추적함</li>
  <li>RetryListener – Retry 시작, 종료, 에러 시점</li>
  <li>구현 방식: 어노테이션 방식, 인터페이스 방식</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/32.png">
          <img src="/assets/images/post/Spring/Batch/32.png" alt="" />
      </a>
    
  
  
</figure>

<h3 id="jobexecutionlistener--stepexecutionlistener">JobExecutionListener / StepExecutionListener</h3>
<ul>
  <li>Job 의 성공여부와 상관없이 호출된다.</li>
  <li>Step 의 성공여부와 상관없이 호출된다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">Job</span> <span class="nf">job</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"job"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">step</span><span class="o">())</span>
            <span class="o">.</span><span class="na">listener</span><span class="o">(</span><span class="nc">JobExecutionListener</span><span class="o">)</span>
            <span class="o">.</span><span class="na">listener</span><span class="o">(</span><span class="nc">Object</span><span class="o">)</span> <span class="c1">// 어노테이션방식</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<h3 id="chunklistener--itemreadlistener-itemprocesslistener-itemwritelistener">ChunkListener / ItemReadListener /ItemProcessListener /ItemWriteListener</h3>
<ul>
  <li>ChunkListener
    <ul>
      <li><code class="language-plaintext highlighter-rouge">void beforeChunk(ChunkContext context)</code>: 트랜잭션이 시작되기 전 호출, ItemReader 의 read() 메소드를 호출하기 전이다.</li>
      <li><code class="language-plaintext highlighter-rouge">void afterChunk(ChunkContext context)</code>: Chunk 가 커밋된 후 호출, ItemWriter 의 write() 메소드를 호출한 후이다.  롤백 되었다면 호출되지 않는다.</li>
      <li><code class="language-plaintext highlighter-rouge">void afterChunkError(ChunkContext context)</code>:  오류 발생 및 롤백이 되면 호출</li>
    </ul>
  </li>
  <li>ItemReadListener
    <ul>
      <li><code class="language-plaintext highlighter-rouge">void beforeRead()</code>: read() 메소드를 호출하기 전 매번 호출</li>
      <li><code class="language-plaintext highlighter-rouge">void afterRead(T item)</code>: read() 메소드를 호출이 성공할 때 마다 호출</li>
      <li><code class="language-plaintext highlighter-rouge">void onReadError(Exception ex)</code>: 읽는 도중 오류가 발생하면 호출</li>
    </ul>
  </li>
  <li>ItemProcessListener
    <ul>
      <li><code class="language-plaintext highlighter-rouge">void beforeProcess(T item)</code>: process() 메소드를 호출하기 전 매번 호출</li>
      <li><code class="language-plaintext highlighter-rouge">void afterWrite(List&lt;? extends S&gt; items)</code>:  process() 메소드 호출이 성공할 때 매번 호출</li>
      <li><code class="language-plaintext highlighter-rouge">void onWriteError(Exception exception, List&lt;? extends S&gt; items)</code>: 처리 도중 오류가 발생하면 호출</li>
    </ul>
  </li>
  <li>ItemWriteListener
    <ul>
      <li><code class="language-plaintext highlighter-rouge">void beforeWrite(List&lt;? extends S&gt; items)</code>: write() 메소드를 호출하기 전 호출</li>
      <li><code class="language-plaintext highlighter-rouge">void afterWrite(List&lt;? extends S&gt; items)</code>: write() 메소드 호출이 성공할 때 호출</li>
      <li><code class="language-plaintext highlighter-rouge">void onWriteError(Exception exception, List&lt;? extends S&gt; items)</code>: 쓰기 도중 오류가 발생하면 호출</li>
    </ul>
  </li>
</ul>

<h3 id="skiplistener--retrylistener">SkipListener &amp; RetryListener</h3>
<h4 id="skiplistener">SkipListener</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">void onSkipInRead(Throwable t)</code>: read 수행중 Skip 이 발생할 경우 호출</li>
  <li><code class="language-plaintext highlighter-rouge">void onSkipInWrite(S item, Throwable t)</code>: write 수행중 Skip 이 발생할 경우 호출</li>
  <li><code class="language-plaintext highlighter-rouge">void onSkipInProcess(T item, Throwable t)</code>: process 수행중 Skip 이 발생할 경우 호출</li>
</ul>

<h4 id="retrylistener">RetryListener</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">boolean open(RetryContext context, RetryCallback&lt;T, E&gt; callback)</code>: 재 시도 전 매번 호출, false 를 반환할 경우 retry 를 시도하지 않음</li>
  <li><code class="language-plaintext highlighter-rouge">void close(RetryContext context, RetryCallback&lt;T, E&gt; callback, Throwable throwable)</code>: 재 시도 후 매번 호출</li>
  <li><code class="language-plaintext highlighter-rouge">void onError(RetryContext context, RetryCallback&lt;T, E&gt; callback, Throwable throwable)</code>: 예외 발생시 호출</li>
</ul>

<figure class=" ">
  
    
      <a href="/assets/images/post/Spring/Batch/33.png">
          <img src="/assets/images/post/Spring/Batch/33.png" alt="" />
      </a>
    
  
  
</figure>

<h2 id="jobexplorer--jobregistry--joboperator">JobExplorer / JobRegistry / JobOperator</h2>
<p>API 요청 등에 맞춰서 원하는 Job을 실행시키기거나 중단시킬 수 있는 운영적인 측면에서의 활용이다.</p>
<h3 id="jobexplorer">JobExplorer</h3>
<ul>
  <li>JobRepository 의 readonly 버전</li>
  <li>실행 중인 Job 의 실행 정보인 JobExecution 또는 Step의 실행 정보인 StepExecution 을 조회할 수 있다.</li>
</ul>

<h3 id="jobregistry">JobRegistry</h3>
<ul>
  <li>생성된 Job 을 자동으로 등록, 추적 및 관리하며 여러 곳에서 job 을 생성한 경우 ApplicationContext 에서 job을 수집해서 사용할 수 있다.</li>
  <li>기본 구현체로 map 기반의 MapJobRegistry 클래스를 제공한다. jobName 을 Key로 하고 job 을 값으로 하여 매핑한다.</li>
  <li>Job등록: JobRegistryBeanPostProcessor – BeanPostProcessor 단계에서 bean 초기화 시 자동으로 JobRegistry에 Job을 등록 시켜준다.</li>
</ul>

<h3 id="joboperator">JobOperator</h3>
<ul>
  <li>JobExplorer, JobRepository, JobRegistry, JobLauncher 를 포함하고 있으며 배치의 시작, 중단, 재시작, job 요약 등의 모니터링이 가능하다.</li>
  <li>기본 구현체로 SimpleJobOprerator 클래스를 제공한다.</li>
</ul>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#batch" class="page__taxonomy-item" rel="tag">Batch</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#spring" class="page__taxonomy-item" rel="tag">Spring</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 카테고리: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#spring-batch" class="page__taxonomy-item" rel="tag">Spring/Batch</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 업데이트:</strong> <time datetime="2022-01-03T00:00:00+09:00">January 3, 2022</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">공유하기</h4>
  

  <a href="https://twitter.com/intent/tweet?text=%5BSpring%5D%5BBatch%5D+Spring+Batch%20https%3A%2F%2Frere950303.github.io%2Fspring%2Fbatch%2Fbatch%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Frere950303.github.io%2Fspring%2Fbatch%2Fbatch%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Frere950303.github.io%2Fspring%2Fbatch%2Fbatch%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/spring/restful/RESTful/" class="pagination--pager" title="[Spring][RESTful] RESTful Web Services 개발
">이전</a>
    
    
      <a href="/spring/batch/SpringThreadTest/" class="pagination--pager" title="[Spring][Batch] Spring Batch Multithread
">다음</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">연관글</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/java/utility/" rel="permalink">[Java] 인스턴스화를 막으려거든 private 생성자를 사용하라
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-05-22T00:00:00+09:00">May 22, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          최대 1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/java/singleton/" rel="permalink">[Java] 생성자나 열거 타입으로 싱글턴임을 보증하라
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-05-21T00:00:00+09:00">May 21, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/java/builder/" rel="permalink">[Java] 생성자의 매개변수가 많을 때는 빌더를 고려해라
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-05-20T00:00:00+09:00">May 20, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/spring/security/aop/" rel="permalink">[Spring][Security] AOP를 통한 메소드 시큐리티 구현
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        <time datetime="2022-04-17T00:00:00+09:00">April 17, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          2 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="검색어를 입력하세요..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      
        
      
        
      
        
          <li><a href="https://github.com/rere950303" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    
    
    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 yhw. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    <script>
  'use strict';

  (function() {
    var commentContainer = document.querySelector('#utterances-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://utteranc.es/client.js');
    script.setAttribute('repo', 'rere950303/rere950303.github.io');
    script.setAttribute('issue-term', 'title');
    script.setAttribute('theme', 'github-light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>

  





  </body>
</html>
